<div id="staff_page" data-role="page" data-dom-cache="true" data-title="Mitarbeiter" data-theme="a" data-content-theme="a">
	<div data-role="content" class="toblur">
		<ul id="staff_content_list" data-role="listview" data-filter="true" data-filter-reveal="true" data-filter-placeholder="Suche Mitarbeiter..." data-inset="true"></ul>
	</div>

	<script>

		/*TODO
		 *
		 */
    		$( "#staff_page" )
	    		.on("pagecreate", staffInitStaffView)
	    		.on("pageshow", function() {
	    			if(!GLOBAL.INIT.staff) loadingIn();
	    			$("#btn_refresh")
						.off()
						.on("click", staffInitStaffView);
	    		 });

		/**
		 * Fetches staff from the Server. Will call staffFillStaffList
		 *
		 */
		function staffInitStaffView() {

			loadingIn();

			$.getJSON(CONFIG.SERVER.base+CONFIG.SERVER.staff)
				.done(function(data, status, jqXHR) {
					if(!isEmpty(data.message)){ajaxErrorHandler(data, status, jqXHR); return;}

					staffFillStaffList(data);

					loadingOut();
					GLOBAL.INIT.staff = true;
				})
				.fail(ajaxErrorHandler);
		}
		
		/**
		 * Fills the staff list widget.
		 *
		 * @ param JSON-Object data
		 *
		 */
		function staffFillStaffList(data) {

			var emp, name;
			var lis = "";
			
			for(var k in data){
				emp = data[k];
				name = emp.name.split(", ");
			
				lis += '<li class="ui-screen-hidden" data-cuid="'+emp.cuid+'">'+
						'<a href="#" class="staff">'+
						'<img src="'+CONFIG.SERVER.base+CONFIG.SERVER.staff+emp.cuid+'/thumb" style="margin:8px 0 0 8px;">'+
							name[1]+' '+name[0]+', '+emp.degree+
							'<p>'+emp.faculty+'</p>'+
						'</a></li>';
			}
		
			$( "#staff_content_list" )
				.off()
				.empty()
				.append(lis)
				.on("click", "a.staff", staffLoadStaffDetails)
				.listview("refresh")
				.trigger("updatelayout");
		
			$( "body" )
				.find("div.staffdetails")
				.remove();
		}

		/**
		 * Fetches staff detail data from the Server and initalizes a new page in document to change to.
		 *
		 * @ param Event e
		 *
		 */
		function staffLoadStaffDetails(e) {

			var id = $(e.target).parents("li").first().data("cuid");
			
			if($("#staff_"+id).length > 0) {
				$.mobile.initializePage();
				$.mobile.changePage("#staff_"+id);
				return;
			}
			
			loadingIn();
			
			$.getJSON(CONFIG.SERVER.base+CONFIG.SERVER.staff+id)
				.done(function(data, status, jqXHR) {
					if(!isEmpty(data.message)){ajaxErrorHandler(data, status, jqXHR); return;}

					var name = data.name.split(", ");
					var div = '<div id="staff_'+id+'" data-role="page" data-title="Mitarbeiter" data-subpage="true" class="staffdetails" data-theme="a" data-content-theme="a">'+
								'<div data-role="content">'+
									'<h1>'+name[1]+' '+name[0]+'<img src="'+CONFIG.SERVER.base+CONFIG.SERVER.staff+id+'/pic" style="float: right" /></h1>'+
									'<hr>'+
									'<p><b>Grad:</b> '+data.degree+'</p>'+
									'<p><b>Bereich:</b> '+data.faculty+'</br><b>Objekt:</b> '+data.location+'</p>'+
									'<p><b>Beschreibung:</b> '+data.description+'</p>'+
									'<p><b>E-Mail:</b> <a href="mailto:'+data.email+'">'+data.email+'</a></p>'+
									'<p><b>Telefon:</b> <a href="tel:'+data.telephone+'">'+data.telephone+'</a></p>'+
									'<p><b>Fax:</b> '+data.telefax+'</p>'+
									'<p><b>Links:</b></br><a href="'+data.detailLink+'" class="external">Details zur Person</a></br>'+
									'<a href="'+data.vcardLink+'">V-Card</a></p>'+
								'</div>'+
							'</div>';
				
					$( "body" )
						.append(div)
						.trigger("create");
				
					$.mobile.initializePage();
					$.mobile.changePage("#staff_"+id);
				
					loadingOut();
				})
				.fail(ajaxErrorHandler);
		}
	</script>
</div>

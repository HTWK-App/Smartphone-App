<div id="canteen_page" data-role="page" data-dom-cache="true" data-title="Mensa" data-theme="a" data-content-theme="a">
	<div data-role="content" class="toblur">
		<div data-role="navbar">
			<p>
				<h3 id="week_label"></h3>
			</p>
		    <ul id="canteen_nav">
		        <li><a href="#" data-day="Mon">Montag</a></li>
		        <li><a href="#" data-day="Tue">Dienstag</a></li>
		        <li><a href="#" data-day="Wed">Mittwoch</a></li>
		        <li><a href="#" data-day="Thu">Donnerstag</a></li>
		        <li><a href="#" data-day="Fri">Freitag</a></li>
		    </ul>
		</div>
		<div data-day="Mon" class="canteen_content"></div>
		<div data-day="Tue" class="canteen_content"></div>
		<div data-day="Wed" class="canteen_content"></div>
		<div data-day="Thu" class="canteen_content"></div>
		<div data-day="Fri" class="canteen_content"></div>
	</div>
	<footer id="canteen_footer" data-role="footer" data-position="fixed" class="toblur">
		<form>
			<div data-role="fieldcontain">
				<label for="canteen_select">Mensa:</label>
				<select id="canteen_select" name="canteen_select"></select>
			</div>
			<div data-role="fieldcontain">
				<input type="checkbox" id="canteen_veggie_mode" name="canteen_veggie_mode" />
				<label for="canteen_veggie_mode">Vegetarische Gerichte</label>
			</div>
		</form>
	</footer>

	<script>
		$( "#canteen_page" )
			.on("pagecreate", initCanteenView)
			.on("pageshow", function() {
				if(!GLOBAL.INIT.mensa) loadingIn();
    			$("#btn_refresh")
				.off()
				.on("click", function() {
					$("#canteen_select").change();
					$("#canteen_veggie_mode")
						.prop("checked", false)
						.checkboxradio("refresh");
				 });
			 })
			.on("click", "#canteen_nav a", function(e) {
				$("#canteen_page")
					.find("div.canteen_content")
					.hide().end()
					.find("div:jqmData(day='"+$(e.target).jqmData("day")+"')")
					.show();
			 })
			.on("swipeleft", "div.canteen_content", function() {
				var o = $(this);	
				
				if(o.index()<5)
				{	
					$("#canteen_nav a").eq(o.index()).not(".ui-disabled").click();
				}
			 })
			.on("swiperight", "div.canteen_content", function() {
				var o = $(this);	
				
				if(o.index()>1)
				{
					$("#canteen_nav a").eq(o.index()-2).not(".ui-disabled").click();
				}
			 });

		$( "#canteen_select" )
			.on("change", function() {
				$("#canteen_page div.canteen_content").empty();
				fillCanteen($(this).val(), GLOBAL.DATE.currentWeek);
			 });
		
		$( "#canteen_veggie_mode" )
			.on("click", function() {
				if($(this).is(":checked"))
				{
					$("#canteen_page div.canteen_content div.non_veggie").hide();
				}
				else
				{
					$("#canteen_page div.canteen_content div.non_veggie").show();
				}
			});

		/**
		 * Loading the available Canteens and fill the pre-selected Canteen.
		 */
		function initCanteenView() {
			var date = new Date();
			var day = getWeekDay(date).id;
			var nav = $("#canteen_nav a");
			
			fillCanteenSelect();

			$("#week_label").html(	"Aktuelle Woche von "+ formatDate(GLOBAL.DATE.currentWeek[0], GLOBAL.DATE.formats.de)+
									" bis "+formatDate(GLOBAL.DATE.currentWeek[4], GLOBAL.DATE.formats.de));

			fillCanteen(CONFIG.MENSA.defaultCanteen, GLOBAL.DATE.currentWeek);

			// deactivate already past Days
			if (date.getDay()>1 && date.getDay()<6)
			{
				for(var i=0; i<date.getDay()-1; i++)
				{
					nav.eq(i).addClass("ui-disabled");
				}
			}
			
			// open the Tab for current Day
			nav.filter(":jqmData(day='"+day+"')")
			   .addClass("ui-btn-active")
			   .click();
			
			loadingOut();
			GLOBAL.INIT.mensa = true;
		};

		/**
		 * Loading all Meals for the given Week of the given Canteen.
		 * 
		 * @param Integer id ... Canteen ID
		 * @param Array[Date] ... Week as Array of Days
		 */
		function fillCanteen(id, week) {
			var today = new Date().getDay();
			var o = $( "#canteen_page div.canteen_content");
			var deferreds = [];
			
			loadingIn();
			
			// Saturday or Sunday ?
			if(today==6 || today==0) today = 0;
			else today--;
			
			for(var i = today; i < week.length; i++) {
				deferreds[deferreds.length] = fillCanteenDay(o, id, week[i]);
			}
			
			$.when.apply($, deferreds)
			 .then(loadingOut);
		};
		
		/**
		 * Loading all Meals for the given Day of the given Canteen.
		 * 
		 * @param jQuery-Object o ... Day DIVs
		 * @param Integer id ... Canteen ID
		 * @param Date date ... Weekday
		 * 
		 * @return jQuery-Deferred
		 */
		function fillCanteenDay(o, id, date) {
			return $.getJSON(CONFIG.SERVER.base+CONFIG.SERVER.mensa+"/"+id+"/"+createServerDateStamp(date))
			 .done(function (data, status, jqXHR) {
				 		var title, desc, addits;
				 		var priceStud, priceEmp, priceExt;
				 		var meal, meals = "";
				 		var veggie = false;

				 		if(isEmpty(data.dayContent))
				 		{
				 			meals = '<div class="no_meals_today">Keine Angebote verfügbar.</div>';
				 		}
				 		else {
    				 		for(var k in data.dayContent)
    						{
    							meal = data.dayContent[k];
    							
    							desc = !isEmpty(meal.ingredients)?meal.ingredients.join(", "):"Keine Beschreibung verfügbar!";
    							
    							addits = "";
    							if(!isEmpty(meal.addititves))
    							{
    								for(var j in meal.addititves)
        							{
    									// exclude Descrition for "Veggie"-Mode
    									if(j!=58 && j!=50)
    										addits += meal.addititves[j] + "</br>";
        							}
    							}
    							
    							if(isEmpty(addits)) addits = "Keine weiteren Inhaltsstoffe.";
    							
    							// make veggie flag
    							veggie = !isEmpty(meal.addititves[58]) || !isEmpty(meal.addititves[50]);
    							
    							title = meal.title;
    							// TODO make Update like Issue #39
    							priceStud = parseFloat(meal.price[0]).toFixed(2).replace(/\./, ",");
    							priceEmp = parseFloat(meal.price[1]).toFixed(2).replace(/\./, ",");
    							priceExt = parseFloat(meal.price[2]).toFixed(2).replace(/\./, ",");
    							
    							meals += '<div '+(veggie?'':'class="non_veggie"')+'>'+
    									 '<h3>'+title+'</h3>'+
    									 '<p>'+desc+'</p>'+
    									 '<p><small>Zusätzliche Inhaltsstoffe:</br>'+addits+'</small></p>'+
    									 '<div class="canteen_price_bar">'+
    										'<span>Student: '+priceStud+' &euro;</span>'+
    										'<span>Mitarbeiter: '+priceEmp+' &euro;</span>'+
    										'<span>Extern: '+priceExt+' &euro;</span>'+
    									 '</div></div>';
    						}
				 		}
						
						o.filter(":jqmData(day='"+getWeekDay(date).id+"')")
						 .empty()
						 .append(meals)
						 .trigger("create");

			  });
			 //.fail(ajaxErrorHandler);
		};
		
		/**
		 * Loading all available Canteens. 
		 */
		function fillCanteenSelect() {
			$.getJSON(CONFIG.SERVER.base+CONFIG.SERVER.mensa)
			 	.done(function(data, status, jqXHR) {
			 		var opts = "";
			 		
			 		for(var k in data.location)
			 		{	
			 			opts += '<option value="'+k+'" ';
			 			
			 			if(k == CONFIG.MENSA.defaultCanteen)
			 				opts += 'selected="selected"';
			 			
			 			opts += '>'+data.location[k]+'</option>';
			 		}

			 		$( "#canteen_select" )
			 			.append(opts)
			 			.selectmenu("refresh");
			   });
			   //.fail(ajaxErrorHandler);
		};
	</script>
</div>
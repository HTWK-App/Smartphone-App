<div data-role="page" id="mensa" data-title="Mensa" data-theme="a" data-content-theme="a" data-dom-cache="true">
	<div data-role="content" id="mensa_content" class="toblur">
		<div data-role="navbar">
			<p>
				<label id="Week" style="font-weight:bold"></label>
			</p>
		    <ul>
		        <li><a href="#" data-href="Mon" id="l_Mon">Montag</a></li>
		        <li><a href="#" data-href="Tue" id="l_Tue">Dienstag</a></li>
		        <li><a href="#" data-href="Wed" id="l_Wed">Mittwoch</a></li>
		        <li><a href="#" data-href="Thu" id="l_Thu">Donnerstag</a></li>
		        <li><a href="#" data-href="Fri" id="l_Fri">Freitag</a></li>
		    </ul>
		</div><!-- /navbar -->
		<div id="Mon" class="mensa_content_div"></div>
		<div id="Tue" class="mensa_content_div"></div>
		<div id="Wed" class="mensa_content_div"></div>
		<div id="Thu" class="mensa_content_div"></div>
		<div id="Fri" class="mensa_content_div"></div>
	</div>
	<div data-role="footer" id="footer_mensa" class="toblur" data-position="fixed">
		<form>
			<div data-role="fieldcontain">
			    <label for="select-mensa">Mensa:</label>
			    <select name="select-mensa" id="select-mensa">
			    </select>
			</div>
		</form>
	</div>
	<script>
		var cWeek = getWeek(new Date());
		var defaultMensa = new Array("Mensa Academica","118");
		var weekday = new Array('Son','Mon','Tue','Wed','Thu','Fri','Sat');

		$(document).on( "pagecreate", '[id="mensa"]', function() {
			fillMensaView();
		});

		$(document).on("pageshow",'[id="mensa"]', function() {
			$('#mensapage').detach();
		});

		$(document).delegate('[data-role="navbar"] a', 'click', function () {
		    $('.mensa_content_div').hide();
		    $('#' + $(this).attr('data-href')).show();
		    return true;
		});

		var sel = document.getElementById('select-mensa');
		sel.onchange = function() {
			$(".mensa_content_div").empty();
			fillMensa(cWeek, this.value);
		}

		function fillMensaView() {
			fillMensaList();

			var wDay = getWeekDay(new Date());
			document.getElementById('Week').innerHTML = 'Aktuelle Woche von '+cWeek[0].replace(/(\d{4})(\d{2})(\d{2})/,'$3.$2.$1')+' bis '+cWeek[4].replace(/(\d{4})(\d{2})(\d{2})/,'$3.$2.$1');

			fillMensa(cWeek, defaultMensa[1]);

			// open the tab for current day
			$('[data-href="'+wDay+'"]').addClass('ui-btn-active');

			//deactivate already past days
			var date = new Date();
			if (date.getDay() < 6) {
				for (var i = 0; i < date.getDay(); i++) {
					$('[data-href="'+weekday[i]+'"]').addClass('ui-disabled');
				};
			}

			document.getElementById('l_'+wDay).click();
		}

		function fillMensa(currentWeek, mensaNo) {
			showLoader;
			for (var i = 0; i < currentWeek.length; i++) {
				var cDate = new Date(currentWeek[i].replace(/(\d{4})(\d{2})(\d{2})/,'$1-$2-$3'));
				var cWeekDay = getWeekDay(cDate);
				handleData(currentWeek[i],cWeekDay,mensaNo);
			}
		}

		function handleData(day,weekDay,mensaNo) {
			$.getJSON( SERVER_URL+'mensa/'+mensaNo+'/'+day).done( function(data) {
					$.each( data.dayContent, function( key, item ) {
						fillMensaDay(weekDay,item.title,item.ingredients,item.price);
					});
					$.mobile.loading('hide'); 
					showLoading = false;
				});
		}
		
		function fillMensaDay(day, dishName, dishDescr, prices) {
			var dishDesc = "";
			for (var i = 0; i < dishDescr.length; i++) {
				dishDesc += dishDescr[i] + " ";
			}
			
			var pattern = 
				'<h3>'+dishName+'</h3><p>'+dishDesc+'</p>'+
					'<div data-role="controlgroup" data-type="horizontal" data-mini="true" class="ui-disabled" style="overflow:visible;">'+
					'<a data-role="button">Student: '+prices[0]+'€  </a>'+
					'<a data-role="button">Mitarbeiter: '+prices[1]+'€  </a>'+
					'<a data-role="button">Extern: '+prices[2]+'€  </a></div><hr>';
			$( '#'+day+'' ).append(pattern).trigger("create");
		}
		
		function fillMensaList(){
			var list = $( "#select-mensa" );

			$.getJSON( SERVER_URL+'mensa').done( function(data, a,b) {
				$.each(data.location, function(key, item) {
					if (key == defaultMensa[0]) {
						list.append('<option value="'+item+'" selected>'+key+'</option>');
					} else {
						list.append('<option value="'+item+'" >'+key+'</option>');
					}
					list.selectmenu( "refresh" );
				});
			});			
		}

		function getFormattedDate(date) {
			var dd = date.getDate();
			var mm = date.getMonth()+1; //January is 0!
			
			var yyyy = date.getFullYear();
			if(dd<10){
				dd='0'+dd
			} 
			if(mm<10){
				mm='0'+mm
			} 
			var retVal = yyyy+''+mm+''+dd;
			
			return retVal;
		}

		function getWeek(today) {
			if (today.getDay() == 0 ) {
				today.setDate(today.getDate() + 1);
			} else if(today.getDay() == 6) {
				today.setDate(today.getDate() + 2);
			}

			var d = new Date(today);
			var day = d.getDay(), diff = d.getDate() - day + (day == 0 ? -6:1); // adjust when day is sunday
			var monday = new Date(d.setDate(diff));
			var week = new Array(5);
			week[0] = getFormattedDate(monday);

			for (var i = 1; i < 5; i++) {
				week[i] = getFormattedDate(new Date(d.setDate(monday.getDate() + i)));
			}

			return week;
		}

		function getWeekDay(date) {
			if (date.getDay() == 0 || date.getDay() == 6) {
				return weekday[1];
			} else {
				return weekday[date.getDay()];
			}
		}
	</script>
</div>

<div id="canteen_page" data-role="page" data-theme='b' data-dom-cache="true">
	<div data-role="panel" id="menue" data-theme="a" data-display="push">
		<ul data-role="listview">
			<li data-role="list-divider">Hauptmenü</li>
			<li data-icon="fire"><a href="index.html" >Startseite</a></li>
			<li data-icon="fire"><a href="news.html" >News</a></li>
			<li data-icon="trophy"><a href="stundenplan.html" >Stundenplan</a></li>
			<li data-icon="trophy"><a href="mensa.html" >Mensa</a></li>
			<li data-icon="trophy"><a href="postfach.html" >Postfach</a></li>
			<li data-icon="trophy"><a href="qis.html" >QIS</a></li>
			<li data-icon="trophy"><a href="sport.html" >Hochschulsport</a></li>
			
		</ul>
		<!--<div data-role="collapsible"><h4>Info-Center</h4> -->
		<ul data-role="listview">
			<li data-role="list-divider">Info-Center</li>
			<li data-icon="trophy"><a href="info_allgemein.html" >Allgemein</a></li>
			<li data-icon="trophy"><a href="info_mitarbeiter.html" >Mitarbeiter</a></li>
			<li data-icon="trophy"><a href="info_gebaeudeplan.html" >Gebäudeplan</a></li>
			<li data-icon="trophy"><a href="info_wlan.html" >WLAN-Konfiguration</a></li>
		</ul>
		<!--</div> -->
		<ul data-role="listview">
			<li data-role="list-divider">Tools</li>
			<li data-icon="trophy"><a href="tools_leeren-raum.html" >Leeren Raum finden</a></li>
			<li data-icon="trophy"><a href="tools_buch.html" >Buchausleihe</a></li>
		</ul>
		<ul data-role="listview">
			<li data-role="list-divider">Einstellungen</li>
			<li data-icon="trophy"><a href="einstellungen_htwk-app.html" >HTWK-App</a></li>
		</ul>
	</div>
	<div data-role="header" data-position="fixed" data-tap-toggle="false" data-theme='b'>
		<a href="#menue" data-role='button' role="button" data-iconpos='left' data-inline='true'><i class="icon-ellipsis-vertical"></i>&nbsp;</a>
		<h1>&nbsp;HTWK App</h1>
	</div>
	<div data-position="fixed" data-role="footer" data-theme='b'> <!--data-tap-toggle="true" setzen falls gewünscht--> 
		<div data-role="fieldcontain">
			<fieldset data-role="controlgroup" data-type="horizontal">
				<select name="canteen_select" id="canteen_select" data-native-menu="true">
					<option selected="selected" value="">Mensa...</option>
				</select>
				<label for="canteen_veggie_mode">Vegetarische Gerichte</label>
				<input type="checkbox" id="canteen_veggie_mode" name="canteen_veggie_mode" />
			</fieldset>
		</div>
	</div>
	<div data-role="content" >
		<div class="inset">
			<div data-role="navbar">
				<p><h3 id="week_label"></h3></p>
				<ul id="canteen_nav">
					<li><a href="#" data-day="Mon">Montag</a></li>
					<li><a href="#" data-day="Tue">Dienstag</a></li>
					<li><a href="#" data-day="Wed">Mittwoch</a></li>
					<li><a href="#" data-day="Thu">Donnerstag</a></li>
					<li><a href="#" data-day="Fri">Freitag</a></li>
				</ul>
			</div>
			<div data-day="Mon" class="canteen_content"></div>
			<div data-day="Tue" class="canteen_content"></div>
			<div data-day="Wed" class="canteen_content"></div>
			<div data-day="Thu" class="canteen_content"></div>
			<div data-day="Fri" class="canteen_content"></div>
		</div>
	</div>

	<script>
	
		/*TODO
		 * Veggi mode doesn't work
		 */
		$( "#canteen_page" )
			.on("pagecreate", canteenInitCanteenView)
			.on("pageshow", function() {
				if(!GLOBAL.INIT.mensa) loadingIn();
    				$("#btn_refresh")
					.off()
					.on("click", function() {
						$("#canteen_select").change();
						$("#canteen_veggie_mode")
							.prop("checked", false)
							.checkboxradio("refresh");
					});
			 })
			.on("click", "#canteen_nav a", function(e) {
				$("#canteen_page")
					.find("div.canteen_content")
					.hide().end()
					.find("div:jqmData(day='"+$(e.target).jqmData("day")+"')")
					.show();
			 })
			.on("swipeleft", "div.canteen_content", function() {
				var o = $(this);	
				
				if(o.index() < 5){	
					$("#canteen_nav a").eq(o.index()).not(".ui-disabled").click();
				}
			 })
			.on("swiperight", "div.canteen_content", function() {
				var o = $(this);	
				
				if(o.index() > 1){
					$("#canteen_nav a").eq(o.index()-2).not(".ui-disabled").click();
				}
			 });

		$( "#canteen_select" )
			.on("change", function() {
				$("#canteen_page div.canteen_content").empty();
				fillCanteen($(this).val(), GLOBAL.DATE.currentWeek);
			 });
		
		$( "#canteen_veggie_mode" )
			.on("click", function() {
				if($(this).is(":checked")){
					$("#canteen_page div.canteen_content div.non_veggie").hide();
				} else {
					$("#canteen_page div.canteen_content div.non_veggie").show();
				}
			});

		/**
		 * Loading the available Canteens and fill the pre-selected Canteen.
		 */
		function canteenInitCanteenView() {

			var date = new Date();
			var day = getWeekDay(date).id;
			var nav = $("#canteen_nav a");

			canteenFillCanteenSelect();

			$("#week_label").html(	""+formatDate(GLOBAL.DATE.currentWeek[0], GLOBAL.DATE.formats.de)+
									" bis "+formatDate(GLOBAL.DATE.currentWeek[4], GLOBAL.DATE.formats.de));

			canteenFillCanteen(CONFIG.MENSA.defaultCanteen, GLOBAL.DATE.currentWeek);

			// deactivate already past Days
			if (date.getDay() > 1 && date.getDay() < 6) {
				for(var i = 0; i < date.getDay()-1; i++) {
					nav.eq(i).addClass("ui-disabled");
				}
			}
			
			// open the Tab for current Day
			nav.filter(":jqmData(day='"+day+"')")
				.addClass("ui-btn-active")
				.click();
			
			GLOBAL.INIT.mensa = true;
		}

		/**
		 * Loading all Meals for the given Week of the given Canteen.
		 * 
		 * @param Integer id ... Canteen ID
		 * @param Array[Date] ... Week as Array of Days
		 */
		function canteenFillCanteen(id, week) {

			var today = new Date().getDay();
			var o = $( "#canteen_page div.canteen_content");
			var deferreds = [];
			
			loadingIn();
			
			// Saturday or Sunday ?
			if(today==6 || today==0) 
				today = 0;
			else 
				today--;
			
			for(var i = today; i < week.length; i++) {
				deferreds[deferreds.length] = canteenFillCanteenDay(o, id, week[i]);
			}
			
//			$.when.apply($, deferreds);//TODO
//				.then(loadingOut);
		}
		
		/**
		 * Loading all Meals for the given Day of the given Canteen.
		 * 
		 * @param jQuery-Object o ... Day DIVs
		 * @param Integer id ... Canteen ID
		 * @param Date date ... Weekday
		 * 
		 * @return jQuery-Deferred
		 */
		function canteenFillCanteenDay(o, id, date) {
			return $.getJSON(CONFIG.SERVER.base+CONFIG.SERVER.mensa+"/"+id+"/"+createServerDateStamp(date))
				.done(function (data, status, jqXHR) {
					if(!isEmpty(data.message)){ajaxErrorHandler(data, status, jqXHR); return;}

			 		var title, desc, addits;
			 		var priceStud, priceEmp, priceExt;
			 		var meal, meals = '<ul data-nativedroid-plugin="cards" class="nativeDroidCards">';
			 		var veggie = false;

			 		if(isEmpty(data.dayContent)) {
			 			meals = '<div class="no_meals_today">Keine Angebote verfügbar.</div>';
			 		} else {
				 		for(var k in data.dayContent) {
							meal = data.dayContent[k];
						
							desc = !isEmpty(meal.ingredients)?meal.ingredients.join(", "):"Keine Beschreibung verfügbar!";
						
							addits = "";
							if(!isEmpty(meal.addititves)) {
								for(var j in meal.addititves) {
									// exclude Descrition for "Veggie"-Mode
									if(j!=58 && j!=50)
										addits += meal.addititves[j] + "</br>";
								}
							}
						
							if(isEmpty(addits)) 
								addits = "Keine weiteren Inhaltsstoffe.";
						
							// make veggie flag
							veggie = !isEmpty(meal.addititves[58]) || !isEmpty(meal.addititves[50]);
						
							title = meal.title;
							// TODO make Update like Issue #39
							priceStud = parseFloat(meal.price[0]).toFixed(2).replace(/\./, ",");
							priceEmp = parseFloat(meal.price[1]).toFixed(2).replace(/\./, ",");
							priceExt = parseFloat(meal.price[2]).toFixed(2).replace(/\./, ",");
						
							meals += '<li data-cards-type="text" '+(veggie?'':'class="non_veggie"')+'><div class="inset">'+
									'<h1>'+title+'</h1><hr/>'+
									'<p>'+desc+'<br/><br/>'+
									'<small>Zusätzliche Inhaltsstoffe:</br>'+addits+'</small><br/></p>'+
									'<p>'+
										'<b>Studenten: </b>'+priceStud+' &euro;<br/>'+
										'<b>Mitarbeiter: </b>'+priceEmp+' &euro;<br/>'+
										'<b>Externe: </b>'+priceExt+' &euro;'+
									'</p>'+
									'</div>'+
								'</li>';
						}
						meals += '</ul>';
			 		}
						
					o.filter(":jqmData(day='"+getWeekDay(date).id+"')")
						.empty()
						.append(meals)
						.trigger("create");

					loadingOut();
				})
				.fail(ajaxErrorHandler);
		}
		
		/**
		 * Loading all available Canteens. 
		 */
		function canteenFillCanteenSelect() {
			$.getJSON(CONFIG.SERVER.base+CONFIG.SERVER.mensa)
				.done(function(data, status, jqXHR) {
					if(!isEmpty(data.message)){ajaxErrorHandler(data, status, jqXHR); return;}

			 		var opts = "";
			 		
			 		for(var k in data.location) {	
			 			opts += '<option value="'+k+'" ';
			 			
			 			if(k == CONFIG.MENSA.defaultCanteen)
			 				opts += 'selected="selected"';
			 			
			 			opts += '>'+data.location[k]+'</option>';
			 		}

			 		$( "#canteen_select" )
						.empty()
			 			.append(opts)
			 			.selectmenu("refresh");
				})
				.fail(ajaxErrorHandler);
		}

	</script>
</div>

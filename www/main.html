<!DOCTYPE html>
<html>
	<head>
		<title>HTWK App</title>
		<!--<meta http-equiv="Content-Security-Policy" content="default-src 'self' data: gap: https://ssl.gstatic.com 'unsafe-eval'; style-src 'self' 'unsafe-inline'; media-src *">-->
		<meta charset="UTF-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="format-detection" content="telephone=no">
		<meta name="msapplication-tap-highlight" content="no">
		<meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height">
		<link rel="icon" type="image/png" href="images/favicon.png">

		<link rel="stylesheet" type="text/css" href="css/HTWK-App.min.css">
		<link rel="stylesheet" type="text/css" href="css/jquery.mobile.icons.min.css">
		<link rel="stylesheet" type="text/css" href="css/jquery.mobile.custom.structure.min.css">
		<link rel="stylesheet" type="text/css" href="css/font-awesome.min.css">
		<link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto">
		<link rel="stylesheet" type="text/css" href="css/defaultThemeChanges.min.css">

		<style> .map-canvas{ height: 250px; }</style>

	</head>
	<body>

		<!--- MENU -->
		<div data-role="panel" id="panelMenu" data-theme="a" data-display="overlay"  data-position="left">
			<ul data-role="listview">
				<li data-role="list-divider">Hauptmenü</li>
					<li><a href="main.html"><i class="fa fa-fw fa-home"></i>Startseite</a></li>
					<li><a href="news.html"><i class="fa fa-fw fa-newspaper-o"></i>News</a></li>
					<li><a href="timetable.html"><i class="fa fa-fw fa-calendar"></i>Stundenplan</a></li>
					<li><a href="canteen.html"><i class="fa fa-fw fa-cutlery"></i>Mensa-Angebot</a></li>
					<li><a href="mail.html"><i class="fa fa-fw fa-envelope"></i>Postfach</a></li>
					<li><a href="qis.html"><i class="fa fa-fw fa-graduation-cap"></i>QIS</a></li>
				<li data-role="list-divider">Info-Center</li>
					<li><a href="info_general.html"><i class="fa fa-fw fa-info"></i>Allgemeine Infos</a></li>
					<li><a href="info_staff.html"><i class="fa fa-fw fa-group"></i>Mitarbeiter</a></li>
					<li><a href="info_buildings.html"><i class="fa fa-fw fa-institution"></i>Gebäudeplan</a></li>
					<li><a href="sport.html"><i class="fa fa-fw fa-dribbble"></i>Sportangebote</a></li>
					<li><a href="info_wlan.html"><i class="fa fa-fw fa-wifi"></i>WLAN-Konfiguration</a></li>
				<li data-role="list-divider">Tools</li>
					<li><a href="room_search.html" ><i class="fa fa-fw fa-map-marker"></i>Leeren Raum finden</a></li>
					<li><a href="settings.html"><i class="fa fa-fw fa-cogs"></i>Einstellungen</a></li>
					<li><a href="about.html"><i class="fa fa-fw fa-info"></i>Über die App</a></li>
			</ul>
		</div>
		<!--- MENU -->

		<div id="overlayer"></div>

		<div id="index" data-role="page" data-theme="b">

			<!--- HEADER -->
			<div data-role="header" data-position="fixed" data-tap-toggle="false" data-theme="b" class="header">
				<a href="#panelMenu" class="ui-btn-left ui-btn ui-btn-inline ui-mini ui-corner-all"><i class="fa fa-bars fa-lg"></i></a>
				<h1>HTWK App</h1>
			</div>
			<!--- HEADER -->

			<div role="main" class="ui-content">
				<ul class="nativeDroidCards">
					<li id="mensaCard" data-cards-type="text"></li>
					<li>
						<h1>Wir suchen dich!</h1><hr/>
						<p>Auch du kannst uns auf vielfältige Weise bei der App unterstützen. Wenn du interessiert bist:</p>
						<a href="about.html" style="clear: both;" data-role="button"><i class="fa fa-plus-circle fa-fw fa-lg"></i> Weiterlesen...</a>
						<hr/>
					</li>
					<li id="HTWKNews" data-cards-type="text" class="HtwkImage"></li>
					<li id="HTWKEvents" data-cards-type="text" class="HtwkImage"></li>
					<li id="LVZNews" data-cards-type="text"></li>
				</ul>
			</div>

		</div>

		<!-- ## SIGNIN DIALOG ## -->
		<div id="signInDialog" data-role="popup" data-dismissible="false" data-theme="a" data-overlay-theme="a" data-transition="pop" class="ui-corner-all">
	    <div data-role="header" data-theme="a">
	   		<h2>Authentifizierung</h2>
	   	</div>
      <div style="padding:10px 20px;">
	 	 		<h4>Damit Sie diesen Dienst nutzen können, müssen Sie sich zunächst anmelden!</h4>

	 	 		<form id="signInDialog_form">
		 	 		<input type="text" id="signInDialog_username" value="" placeholder="Nutzername" autofocus required>
		 	 		<input type="password" id="signInDialog_password" value="" placeholder="Passwort" autocomplete="off" required>
		 	 		<button type="submit" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-a ui-btn-icon-left ui-icon-check">Anmelden</button>
		 	 		<button id="signInDialog_abort" type="button" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-a ui-btn-icon-left ui-icon-back">Abbrechen</button>
	 	 		</form>
 	 		</div>
		</div>
		<!-- ## SIGNIN DIALOG ## -->

		<script type="application/javascript" src="js/lib/jquery-2.1.4.min.js"></script>
		<script type="application/javascript" src="js/lib/jquery.mobile.custom.min.js"></script>

		<script type="application/javascript" src="js/compressed.min.js"></script>
		<!--<script type="application/javascript" src="js/config.js"></script>
		<script type="application/javascript" src="js/fn.js"></script>
		<script type="application/javascript" src="js/building.js"></script>
		<script type="application/javascript" src="js/staff.js"></script>
		<script type="application/javascript" src="js/gmaps.js"></script>-->
		<script type="application/javascript" src="https://maps.google.com/maps/api/js?v=3.exp&sensor=true"></script> <!--TODO Download Script-->

		<script type="application/javascript" src="cordova.js"></script>

		<!--##############################################################################################-->
		<script type="application/javascript">

			// AJAX Setup
			$.ajaxSetup(CONFIG.AJAX);

			// GENERAL Setup
			$( document )
				.ready(function() {

					$("#panelMenu").enhanceWithin().panel();

					$.mobile.defaultPageTransition   = "fade";
					$.mobile.defaultDialogTransition = "fade";
					$.mobile.buttonMarkup.hoverDelay = 0;
					$.mobile.changePage.defaults.allowSamePageTransition = true;

					// swipe Event
					/*GLOBAL.SCREEN.height = window.screen.height;
					GLOBAL.SCREEN.width = window.screen.width;
					$.event.special.swipe.scrollSupressionThreshold=Math.round(0.3*GLOBAL.SCREEN.width);
					$.event.special.swipe.horizontalDistanceThreshold = 20; // Swipe horizontal displacement must be more than this.
					$.event.special.swipe.durationThreshold = 200;  // More time than this, and it isn't a swipe.
					$.event.special.swipe.verticalDistanceThreshold = 75; // Swipe vertical displacement must be less than this.
					//$.event.special.swipe.durationThreshold=1000;
					//$.event.special.swipe.horizontalDistanceThreshold=Math.round(0.2*GLOBAL.SCREEN.width);
					//$.event.special.swipe.verticalDistanceThreshold=Math.round(GLOBAL.SCREEN.height);*/

					GLOBAL.DATE.currentWeek = getWeek(new Date());
					$("#signInDialog").trigger("create").enhanceWithin().popup();
					$.getScript( "https://wurfl.io/wurfl.js", function() { //has to be loaded async but before this code
						if(WURFL.is_mobile){
							analytics.startTrackerWithId('UA-49336195-2');
							analytics.trackView('index');
						}
					});
				})
				.on("deviceready", function() {
					navigator.splashscreen.hide();
					pushNotification = window.plugins.pushNotification;
					registerPush();
				})
				// Header Update on Page Switch
				.on("pageshow", "div:jqmData(role='page')", function() {
					var o = $("body").pagecontainer("getActivePage");
		    	var title = o.jqmData("title");

		    	o.find("div.header h1").text(title);
				})
				// External Link Handling
				.on("click", "a.external", openInExternalBrowser)
				// Swipe Event Menu
				.on("swiperight", function(e) {
					var start = e.swipestart.coords;
					//var stop = e.swipestop.coords;
					if(start[0] <= 0.1*GLOBAL.SCREEN.width){
						$("#panelMenu").panel("open");
					}
				});

				// Deactivate Website behind the Panel
				$("#panelMenu").panel({beforeopen: function() {
					var o = $("body");
					o.find(".ui-page").css("position","fixed").css("overflow-y","hidden");
					o.find(".ui-panel-dismiss").css("position","fixed").css("overflow-y","hidden");
					var overlayer = o.find("#overlayer");
					var newOverlayer = overlayer.clone().removeClass().show();
					overlayer.remove();
					o.append(newOverlayer);
					o.find("#overlayer").addClass("overlayer-in");
				}})
				.panel({beforeclose: function() {
					$("body").find("#overlayer").removeClass("overlayer-in").addClass("overlayer-out");
				}})
				.panel({close: function() {
					var o = $("body");
					o.find(".ui-page").css("position","relative").css("overflow-y","visible");
					o.find(".ui-panel-dismiss").css("position","relative").css("overflow-y","visible");
					o.find("#overlayer").hide();
				}});

			// SignIn Dialog
			$( "#signInDialog_abort" ).on("click", function () {
					$( "#signInDialog" ).popup("close");
					$("#panelMenu").panel("open");
				});

		// ## Index Page #############################################################
			var indexLastReload = 0;

			$("#index")
				.on("pagecreate", function() {loadParameters();})
				.on("pageshow", function () {
					var time = new Date().getTime();
					if(indexLastReload < (time - 900000)){ //15 minuits
						loadingIn();
						getCurrentPlanWeek();
						fillCards();
						indexLastReload = time;
					}
				});

				function getCurrentPlanWeek(){

					$.getJSON(CONFIG.SERVER.base+CONFIG.SERVER.timetable + "cal")
					 .done(function(data, status, jqXHR) {

						if(!isEmpty(data.exception)){
							ajaxErrorHandler(data, status, jqXHR);
							return;
						}

						GLOBAL.DATE.currentPlanWeek = data.current;
						})
					 .fail(ajaxErrorHandler);
				}

			/**
			 * Fills all corresponding cards (named as arguments) with content
			 *
			 */
			function fillCards(){
					fillMensaCard();
					fillCard("rss.lvz.news", "LVZNews", "News der LVZ Leipzig");
					fillCard("rss.htwk.1", "HTWKEvents", "Kommende HTWK Veranstaltungen");
					fillCard("rss.htwk.3", "HTWKNews", "Neuste HTWK Nachrichten");
			}

			/**
			 * Fills the mensa card
			 */
			function fillMensaCard(){

				$.getJSON(CONFIG.SERVER.base+CONFIG.SERVER.mensa+"/"+CONFIG.MENSA.defaultCanteen)
				    .done(function (data, status, jqXHR) {
				    	if(!isEmpty(data.exception) && data.exception != 'javax.naming.directory.InvalidAttributeValueException: no entries found for given date'){
								ajaxErrorHandler(data, status, jqXHR);
								return;
							}

							var meals = '<h1>Mensaangebot des Tages</h1><hr/><img src="images/food.jpg" style="width: 100%;">';

				    	if(isEmpty(data.dayContent)) {
				    		meals += '<p>Heute gibt es leider keine Angebote :-(</p>';
				    	} else {
				    		for(var k in data.dayContent) {
				    			var meal = data.dayContent[k];

				    			meals += !isEmpty(meal.ingredients) ? '<p>'+meal.ingredients.join(", ").replace(/\[\d*\]/gi,"")+'</p>':"";
				    		}
				    	}

					meals += '<a href="canteen.html" class="ui-btn ui-corner-all ui-shadow ui-btn-b "><i class="fa fa-cutlery fa-lg fa-fw"></i> Details</a><hr/>';

					$("#mensaCard")
					 .empty()
					 .append(meals)
					 .trigger("create");
				})
			   .fail(ajaxErrorHandler);
			}

			/**
			 * Fills a card, given by parameter card, with one of the specified news feeds
			 *
			 * @ param String feed ... a valid feed name to fetch from the Server
			 * @ param String card ... the id of the card to be filled
			 * @ param String heading ... the heading of the card
			 */
			function fillCard(feed, card, heading) {

				$.getJSON(CONFIG.SERVER.base+CONFIG.SERVER.news+'/get?feed='+feed+'&limit=2')
				 .done(function(data, status, jqXHR) {

						if(!isEmpty(data.exception)){
							ajaxErrorHandler(data, status, jqXHR);
							return;
						}

						var divs = "<h1>"+heading+"</h1><hr>";

						for(var k in data.responseData.feed.entries) {
							var entry = data.responseData.feed.entries[k];

							var content, links;
							var img = entry.content.match(/<img .*?\/?>/);
							content = replaceWith(entry.content, '', /<img .*?\/?>/);
							do{
								links = content.match(/<a .*?<\/a>/);
								if(!isEmpty(links)){
									var link = links[0];
									content = content.replace(link,$(link).text());
								}
							}while(!isEmpty(links));

							if(!isEmpty(img)){
								img = '<div style="float: left; max-width: 300px; overflow: hidden; padding: 0 8px 8px 8px">'+img[0]+'</div>';
							} else { img = "";}

							if(!isEmpty(entry.content)) {
								divs += '<strong>'+entry.title+'</strong>'+
										'<p id="newsContent">'+img+'<div>'+content.slice(0, 300)+'...</div></p>'+
										'<a href="'+entry.link+'" class="external" style="clear: both;" data-role="button"><i class="fa fa-plus-circle fa-fw fa-lg"></i> Weiterlesen...</a>';
							}

							divs += '<hr/>';
						}

						divs = $(divs);

						$("#"+card)
							.empty()
							.append(divs)
							.trigger("create");

						var imgs = $('.HtwkImage img');
						imgs.width('100%').height('auto').css("padding-right","10px");
						for(var i = 0; i < imgs.length ; i++){
							var img2 = $(imgs[i]);
							img2.attr('src', addhttp(img2.attr('src')));
						}
						loadingOut();
				  })
				 .fail(ajaxErrorHandler);
			}

			function replaceWith(string, toReplace, regExp){

				var reps;

				do{
					reps = string.match(regExp);
					if(!isEmpty(reps)){
						var rep = reps[0];
						string = string.replace(rep,toReplace);
					}
				}while(!isEmpty(reps));

				return string;
			}

			function addhttp(url) {
  				if (!/^(f|ht)tps?:\/\//i.test(url)) {
      				url = "http://htwk-leipzig.de/" + url;
   				}
		   return url;
			}
		</script>
	</body>
</html>

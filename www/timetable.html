<div id="timetable_page" data-role="page" data-dom-cache="true" data-title="Stundenplan" data-theme="a" data-content-theme="a">
	<div data-role="content" class="toblur">
		<div data-role="navbar">
			<p>
				<select id="timetable_week_select"></select>
			</p>
		    <ul id="timetable_nav">
		        <li><a href="#" data-day="Mon">Montag</a></li>
		        <li><a href="#" data-day="Tue">Dienstag</a></li>
		        <li><a href="#" data-day="Wed">Mittwoch</a></li>
		        <li><a href="#" data-day="Thu">Donnerstag</a></li>
		        <li><a href="#" data-day="Fri">Freitag</a></li>
		    </ul>
		</div>
		<div id="timetable_days">
			<table class="timetable_content">
				<thead>
					<tr>
						<th>Beginn</th>
						<th>Ende</th>
						<th>KW</th>
						<th>Ort</th>
						<th>Typ</th>
						<th>Name</th>
						<th>Dozent</th>
						<th>Hinweise</th>
					</tr>
				</thead>
				<tbody data-day="Mon"></tbody>
				<tbody data-day="Tue"></tbody>
				<tbody data-day="Wed"></tbody>
				<tbody data-day="Thu"></tbody>
				<tbody data-day="Fri"></tbody>
			</table>
		</div>
	</div>
	<footer data-role="footer" data-position="fixed" class="toblur">
		<div class="center">
			<h4 id="timetable_week_label"></h4>
		</div>
	</footer>

	<script>		
		$( "#timetable_page" )
			.on("pagecreate", initTimetableView)
			.on("pageshow", function() {
				if(!GLOBAL.INIT.timetable) loadingIn();
    				$("#btn_refresh")
					.off()
					.on("click", function() {
						$("#timetable_week_select").change(); 
					 });
				showConfigDialog();
			 })
			.on("click", "#timetable_nav a", function(e) {
				$("#timetable_days table")
					.find("tbody")
					.hide().end()
					.find("tbody:jqmData(day='"+$(e.target).jqmData("day")+"')")
					.show();
			 })
			.on("swipeleft", "#timetable_days tbody", function() {
					var o = $(this);	
					
					if(o.index()<5)
					{	
						$("#timetable_nav a").eq(o.index()).not(".ui-disabled").click();
					}
			 })
			.on("swiperight", "#timetable_days tbody", function() {
					var o = $(this);	
					
					if(o.index()>1)
					{
						$("#timetable_nav a").eq(o.index()-2).not(".ui-disabled").click();
					}
			 });
			
		$( "#timetable_week_select" )
			.on("change", function() {
				$("#timetable_days table tbody").empty();
				fillTimetable();
			 });

		function getPopup(heading, description){
			var p;
			var div = $("<div data-role='popup'></div>");
			var btn = $('<a class="popup-abort">Abbrechen</a>')
						.buttonMarkup({inline : true, icon : "back"})
						.on("click", closePopup);
				
			div.append('<div data-role="header" data-theme="a"><h1>'+heading+'</h1></div><h4>'+description+'</h4>')
			   .append(btn);
			
			p = div.popup({
					dismissible : false,
					theme : "b",
					overlyaTheme : "b",
					transition : "pop"
			 	})
			 	.on("popupafterclose", function() {
					  $(this).remove();
			 	 });

			return p;
		};

		function closePopup(e) {
			$(e.target).parent().popup("close");
		};

		function showConfigDialog() {	
			loadingIn();
			$.getJSON(CONFIG.SERVER.base+CONFIG.SERVER.timetable+"/cal")
			 .done(function (data, status, jqXHR) {
					CONFIG.TIMETABLE.semester = data.semester;
					$.getJSON(CONFIG.SERVER.base+CONFIG.SERVER.timetable+data.semester)
			 		 .done(function (data, status, jqXHR) {
			 			var popUp = getPopup("Einrichtung", "Bitte wählen Sie ihren Studiengang aus!");
						var ul = '<ul id="chooseCourse" data-func="course" data-role="listview" data-inset="true" data-filter="true" data-filter-reveal="true" data-filter-placeholder="Suche Studiengang...">';
						
						for(var k in data) {
							for(var s in data[k].courses) {
								var course = data[k].courses[s];
								ul += '<li class="ui-screen-hidden" data-course="'+course.id+'" data-faculty="'+data[k].id+'"><a href="#">'+course.name+'</a></li>';
							}
						}

						ul += '</ul>';
						
						ul = $(ul).on("click", "a", facultyChosen);
						
						popUp.find("a.popup-abort").before(ul);
						popUp.trigger("create");
						popUp.popup("open");
						
						loadingOut();
					});
			});
		};

		function facultyChosen(e) {
			var li = $(e.target).parent("li");
			var id = li.jqmData("course");
			var fac = li.jqmData("faculty");
			
			loadingIn();
			CONFIG.TIMETABLE.faculty.push({"id": id, "groups": []});
			
			li.closest("div:jqmData(role='popup')").popup("close");
			
			$.getJSON(CONFIG.SERVER.base+CONFIG.SERVER.timetable+CONFIG.TIMETABLE.semester)
		 		.done(function (data, status, jqXHR) {
		 			var popUp = getPopup("Einrichtung", "Bitte wählen Sie ihren Kurs aus!");
		 			
		 			// watch out
					var sel = '<label for="selectBittenichtTagNamenalsID">Kurs:</label><select id="selectBittenichtTagNamenalsID"><option>Wählen...</option>';
					
					for(var k in data) {
						for(var s in data[k].courses) {
							var course = data[k].courses[s];
							
							if(course.id === id) {
								for(var p in course.semGroups) {
									sel += '<option>'+course.semGroups[p]+'</option>';
								}
							}
						}
					}
					
					sel += '</select>';
					
					sel = $(sel).on("change", courseChosen); 
					
					popUp.find("a.popup-abort").before(sel);
					popUp.trigger("create");
					popUp.popup("open");
					
					loadingOut();
				});
		};

		function courseChosen(e){
			var element = $(e.target);
			var course = element.val();
			console.log(course);
			$(e.target).parents("div", {"data-role": "popup"}).eq(0).popup("close");
		}

		/**
		 * Loading the available Weeks and fill the preselected Timetable.
		 */
		function initTimetableView() {
			var date = new Date();
			var day = getWeekDay(date).id;
			
			fillTimetableSelect();
			
			$( "#timetable_week_label" )
			 	.html("Aktuelle Woche von "+ formatDate(GLOBAL.DATE.currentWeek[0], GLOBAL.DATE.formats.de)+
					  " bis "+formatDate(GLOBAL.DATE.currentWeek[4], GLOBAL.DATE.formats.de));
			
			// open the tab for current day
			$( "#timetable_nav a:jqmData(day='"+day+"')" )
				.addClass("ui-btn-active")
				.click();
			
			loadingOut();//TODO Falsch
			GLOBAL.INIT.timetable = true;
		};

		/**
		 * Loading the selected Week into the Timetable.
		 */
		function fillTimetable() {
			var tbs = $("#timetable_days table tbody");
			var week = $("#timetable_week_select").val();
			var deferreds = [];
			var fac;
			
			loadingIn();
			for(var f in CONFIG.TIMETABLE.faculty) 
			{
				fac = CONFIG.TIMETABLE.faculty[f];
				for(var g in fac.groups)
				{
					deferreds[deferreds.length] = fillTimetableWeek(tbs, week, fac.id, fac.groups[g]);
				}
			}
			
			$.when.apply($, deferreds)
			 .then(function() {
				 for(var i=0;i<tbs.length;i++)
				 {
					var trs = tbs.eq(i).find("tr").detach();
					
					if(trs.length>0)
					{
						trs = trs.sort(function(a,b) {
							var o1 = $(a).find("td").first().text();
							var o2 = $(b).find("td").first().text();
							
							if(o1.length==4) o1 = "0"+o1;
							if(o2.length==4) o2 = "0"+o2;
							
							console.log(o1+" "+o2);
							
							if(o1==o2) return 0;
							else if(o1>o2) return 1;
							else return -1;
						});
						 
						 tbs.eq(i).append(trs);
					}
					else
					{
						tbs.eq(i)
						   .append('<tr><td colspan="8">Keine Veranstaltungen.</td></tr>')
						   .trigger("create");
					}
				 }
				 
				 loadingOut();
			 });
		};
		
		/**
		 * Fill the Timetable Day by Day for the given Faculty and Group in the given Week.
		 * 
		 * @param jQuery-Object tbs ... TBody's of Timetable
		 * @param String week ... Week Number
		 * @param String faculty ... Faculty ID (e.g. "FIMN")
		 * @param Array[Object] group ... Courses and Group ID from Settings
		 * 
		 * @return jQuery-Deferred
		 * 
		 * @see CONFIG.TIMETABLE
		 */
		function fillTimetableWeek(tbs, week, faculty, group) {
			return $.getJSON(CONFIG.SERVER.base+CONFIG.SERVER.timetable+CONFIG.TIMETABLE.semester+"/"+faculty+"/week/"+week+"?semgroup="+group.id)
			 		.done(function (data, status, jqXHR) {
			 				if(!isEmpty(data))
			 				{
			 					for(var k in data)
			 					{	
			 						addTimetableWeekday(tbs.eq(k), data[k].dayContent, group);
			 					}
			 				}
			 		 });
				   //.fail(ajaxErrorHandler);
		};
		
		/**
		 * Adding Courses from the Request to the Weekday.
		 * 
		 * @param jQuery-Object tb ... TBody-Element (TBody representing the Day)
		 * @param Array courses ... all Courses for the Day
		 * @param Array[Object] group ... Courses and Group ID from Settings
		 * 
		 * @see CONFIG.TIMETABLE
		 */
		function addTimetableWeekday(tb, courses, group) {
			var trs = "";
			var n, c, d;

			if(!isEmpty(tb) && !isEmpty(courses))
			{
				for(var i=0;i<courses.length;i++)
				{	
					c = courses[i];
					n = group.courses[c.suid];
					d = (CONFIG.TIMETABLE.showDocentFullName && !isEmpty(c.docentDetailed))?c.docentDetailed:c.docent;
					
					if(!isEmpty(n))
					{	
						trs += 	'<tr>'+
									'<td>'+c.begin+'</td>'+
									'<td>'+c.end+'</td>'+
									'<td>'+c.kw+'</td>'+
									'<td>'+c.location+'</td>'+
									'<td>'+c.type+'</td>'+
									'<td>'+n+'</td>'+
									'<td>'+d+'</td>'+
									'<td>'+c.notes+'</td>'+
								'</tr>';
					}
				}
				
				tb.append(trs)
				  .trigger("create");
			}
		};
		
		/**
		 * Loading all Weeks for the Timetable.
		 */
		function fillTimetableSelect() {
			$.getJSON(CONFIG.SERVER.base+CONFIG.SERVER.timetable+"cal")
			 .done(function(data, status, jqXHR) {
			 		var opts = "";
			 		
			 		for(var k in data)
			 		{	
			 			if(k.search(/^\d+$/)==0)
			 			{
			 				opts += '<option value="'+k+'">'+data[k]+'</option>';
			 			}
			 		}
			 		
			 		// TODO move to Settings
			 		CONFIG.TIMETABLE.semester = data.semester;

			 		$( "#timetable_week_select" )
			 			.append(opts)
			 			.find("option[value='"+data.current+"']")
			 			.prop("selected", true).end()
			 			.selectmenu("refresh");
			 		
			 		fillTimetable();
			   });
			//.fail(ajaxErrorHandler);
		};
	</script>
</div>

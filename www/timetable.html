<div id="timetable_page" data-role="page" data-theme='b' data-dom-cache="true">
	<!--- HEADER --->
	<div data-role="header" data-position="fixed" data-theme='b' class="header toblur">
		<a data-role="button" data-iconpos='left' class="btn_menu"><span class="icon-ellipsis-vertical"></span></a>
		<h1>HTWK App</h1>
		<a href="#timetableInfoPopup" data-role="button" data-icon="info" data-iconpos='right' data-rel="popup" data-position-to="window" data-transition="pop">&nbsp</a>
	</div>
	<!--- HEADER --->
	<div data-position="fixed" data-role="footer" data-theme='b'> <!--data-tap-toggle="true" setzen falls gewünscht--> 
		<div class="center">
			<a data-role="button" href="#" id="extendTimetable">Kalender erweitern...</a>
		</div>
	</div>
	<div data-role="content">   
		<div class="inset">
			<h1 id="actualWeek" data-week="">Woche wird geladen</h1>
			<h1 id="actualDay" data-day=""></h1><hr/>
			<ul id="dayCards" data-nativedroid-plugin='cards' class="nativeDroidCards">
			</ul>
		</div>
	</div>
	<div id="timetableDialog" data-role="popup" data-dismissible="false" data-theme="b" data-overlyaTheme="b" data-transition="pop">
		<style>
			h2, h3, h4, a, label, ul, li{color: white;}
		</style>
    		<div id="timetableDialogHeader" data-role="header" data-theme="b">
   	 	</div>
   	 	<div id="timetableDialogContent" data-role="content" data-theme='b' class="inset">
   	 	</div>
	</div>
	<div id="timetableInfoPopup" data-role="popup" data-dismissible="true" data-theme="b" data-overlyaTheme="b" data-transition="pop">
    		<div data-role="header" data-theme="b">
			<h2>Informationen</h2>
   	 	</div>
   	 	<div data-role="content" data-theme='b' class="inset">
			<p>Leider bietet die App es bisher nicht, den von dir zusammgenstellten Stundenplan in den Systemkalender zu übernehmen. Du kannst das aber komfortable auf einer Website machen. Dort ist auch erklärt, wie man den Kalender fast überall einbindet.<br/>Du kommst über folgenden Button zur Website: </p>
			<a href="http://www.htwk-stundenplan.de" class="external" data-role="button" data-icon="forward" data-mini="true" data-inline="true">Zur Website</a>
			<hr/>
			<a href="#" data-role="button" data-icon="back" data-mini="true" data-rel="back" data-inline="true" class="ui-corner-all ui-shadow">Zurück</a>
   	 	</div>
	</div>

	<script>		
	/*TODO
	 * timetableInfoPopup Button "zur website" doesn't open
	 * Add function do delete timetable, when semester has changed (+ inform/request user)
	*/
		$( "#timetable_page" )
			.on("pagecreate", initTimetableView)
			.on("pageshow", function() {
				if(!GLOBAL.INIT.timetable) loadingIn();
				if(CONFIG.TIMETABLE.faculty.length == 0) showConfigDialog();
			 })
			.on("swipeleft", function() { //next day
				var aDay = $("#actualDay");
				var aWeek = $("#actualWeek");
				var day = parseInt(aDay.attr("data-day"))+1;
				var week = parseInt(aWeek.attr("data-week"));
				if(day > 7){
					day = 1;
					week += 1;
					aWeek.attr("data-week", week);
				}
				aDay.attr("data-day", day);
				timetableGetDayData();
			 })
			.on("swiperight", function() { //previous day
				var aDay = $("#actualDay");
				var aWeek = $("#actualWeek");
				var day = parseInt(aDay.attr("data-day"))-1;
				var week = parseInt(aWeek.attr("data-week"));
				if(day < 1){
					day = 7;
					week -= 1;
					aWeek.attr("data-week", week);
				}
				aDay.attr("data-day", day);
				timetableGetDayData();
			 });
			
		$("#extendTimetable")
			.on("click", showConfigDialog);

		/*********************************************************************************************************************
		  * This Area is used for Timetable Configuration Dialogs
		*/

		var popupOpen = false;

		/**
		 * Get a Popup with a Heading and a Description
		 * 
		 * @param String heading ... Heading of the Popup
		 * @param String description ... Text to display in the Popup
		 * @param Optional String btn_text ... If set, another button with btn_text as text will be displayd
		 * @param Optional Function func ... Callbackfunction for optional button
		 * 
		 * @return jQueryMobile Popup
		 */
		function fillPopup(heading, description, btn_text, func){
			$("#timetableDialogHeader").empty().append('<h3 style="padding: 5% 0 0 10%;">'+heading+'</h3>'); //TODO renew design
			$("#timetableDialogContent").empty().append('<p>'+description+'</p>');
			$("#timetableDialogContent").append('<a id="timetableDialogAbort" href="#" data-role="button" data-icon="back" data-mini="true" data-inline="true" class="ui-corner-all ui-shadow">Abbrechen</a>');

			if(!isEmpty(btn_text)){
				$("#timetableDialogContent").append('<a id="timetableDialogSave" href="#" data-role="button" data-icon="check" data-mini="true" data-rel="back" data-inline="true" class="ui-corner-all ui-shadow">'+btn_text+'</a>');
			}
			$.mobile.activePage.trigger("create");
			$("#timetableDialog")
				.popup().off()
				.on("popupafteropen", function() {popupOpen = true;})
				.on("popupafterclose", function() {
					popupOpen = false;
			 	 });
			$("#timetableDialogAbort").off().on("click", abortSetup);
			$("#timetableDialogSave").off().on("click", func);
		}

		/**
		 * Aborts the displayed Dialog and resets configurations (if not completed)
		 * 
		 * @param Event e ... Click-Event of Link
		 */
		function abortSetup(e) {
			$("#timetableDialog").popup("close")
			CONFIG.TIMETABLE.temporary= [];
			if(CONFIG.TIMETABLE.faculty.length != 0) timetableGetDayData();
		};

		/**
		 * Opens the given Popup whenever another Popup is closed
		 * 
		 * @param JQueryMobile Popub popUp ... Popup to open
		 */
		function open(popUp){
			if(popupOpen == true){
				setTimeout(function(){open(popUp);}, 50);
				return;
			}
			loadingOut();
			$("#timetableDialog").popup("open");
		}

		function noContent(text){
			loadingOut();
			loadingIn(text,true);
			setTimeout(loadingOut, 3000);
			CONFIG.TIMETABLE.temporary= [];
		}

		/**
		 * Starts Configuration Dialog for Timetable.
		 * 
		 * @param Optional Event e ... Click-Event of Link
		 */
		function showConfigDialog(e) {	
			loadingIn();
			$.getJSON(CONFIG.SERVER.base+CONFIG.SERVER.timetable+"/cal")
			 .done(function (data, status, jqXHR) {
				if(!isEmpty(data.message)){ajaxErrorHandler(data, status, jqXHR, abortSetup); return;}
				CONFIG.TIMETABLE.semester = data.semester;
				$.getJSON(CONFIG.SERVER.base+CONFIG.SERVER.timetable+data.semester)
		 		 .done(function (data, status, jqXHR) {
					if(!isEmpty(data.message)){ajaxErrorHandler(data, status, jqXHR, abortSetup); return;}

					var ul = '<ul id="chooseCourse" data-func="course" data-role="listview" data-inset="true" data-filter="true" data-filter-reveal="true" data-filter-placeholder="Suche Studiengang...">';
					
					for(var k in data) {
						for(var s in data[k].courses) {
							var course = data[k].courses[s];
							ul += '<li class="ui-screen-hidden" data-course="'+course.id+'" data-faculty="'+data[k].id+'"><a href="#">'+course.name+'</a></li>';
						}
					}

					ul += '</ul>';
					ul = $(ul).on("click", "a", facultyChosen);

					fillPopup("Einrichtung", "Bitte wählen Sie ihren Studiengang aus!");
					$("#timetableDialogAbort").before(ul);
					$("#timetableDialog").trigger("create");
					$("#timetableDialog").popup();
					
					setTimeout(function(){open($("#timetableDialog"));}, 50);
					
					loadingOut();
				})
				.fail(ajaxErrorHandler);
			})
			.fail(ajaxErrorHandler);
		};

		/**
		 * Called by Configuration Dialog. At this point, a faculty was chosen.
		 * 
		 * @param Event e ... Click-Event of Link
		 */
		function facultyChosen(e) {
			var li = $(e.target).parent("li");
			var id = li.jqmData("course");
			var fac = li.jqmData("faculty");
			
			loadingIn();
			CONFIG.TIMETABLE.temporary.push({"id": id, "groups": []});
			
			li.closest("div:jqmData(role='popup')").popup("close");
			
			$.getJSON(CONFIG.SERVER.base+CONFIG.SERVER.timetable+CONFIG.TIMETABLE.semester)
		 		.done(function (data, status, jqXHR) {
					if(!isEmpty(data.message)){ajaxErrorHandler(data, status, jqXHR, abortSetup); return;}

					var empty = true;
					var lis = '<ul data-role="listview">';
					
					for(var k in data) {
						for(var s in data[k].courses) {
							var course = data[k].courses[s];
							
							if(course.id === id) {
								for(var p in course.semGroups) {
									lis += '<li><a href="#">'+course.semGroups[p]+'</a></li>';
									empty = false;
								}
							}
						}
					}
					
					lis += '</ul>';
					lis = $(lis).on("click", "a", courseChosen); 
					
					fillPopup("Einrichtung", "Bitte wählen Sie ihren Kurs aus!");
					$("#timetableDialogAbort").before(lis);
					$("#timetableDialog").trigger("create");
					$("#timetableDialog").popup();
					
					if(empty == true) {noContent("Es existieren keine Matrikel bzgl. Ihres Studiengangs!"); return;}
					
					setTimeout(function(){open($("#timetableDialog"));}, 50);
				})
				.fail(ajaxErrorHandler);
		};

		/**
		 * Called by Configuration Dialog. At this point, a course was chosen.
		 * 
		 * @param Event e ... Click-Event of Link
		 */
		function courseChosen(e){
			var element = $(e.target);
			var course = element.text();

			loadingIn();
			CONFIG.TIMETABLE.temporary[0].groups.push({"id": course, "courses": {}});
			$("#timetableDialog").popup("close");

			$.getJSON(CONFIG.SERVER.base+CONFIG.SERVER.timetable+CONFIG.TIMETABLE.semester+"/"+CONFIG.TIMETABLE.temporary[0].id+"/courses?semgroup="+course)
		 		.done(function (data, status, jqXHR) {
					if(!isEmpty(data.message)){ajaxErrorHandler(data, status, jqXHR, abortSetup); return;}

					var empty = true;
					var check = '<form><fieldset data-role="controlgroup">';
					
					for(var k in data) {
						var course = data[k];
							
						check += '<input type="checkbox" name="'+course+'" id="'+course+'" data-hash="'+k+'"><label for="'+course+'">'+course+'</label>';
						empty = false;
					}
					
					check += '</fieldset></form>';

					if(empty == true) {noContent("Es existieren keine Fächer bzgl. Ihres Matrikels!"); return;}
					
					check = $(check); 
					fillPopup("Einrichtung", "Bitte kreuzen Sie alle Kurse an, die Sie in ihrem Stundenplan möchten!","Ok", setCourses);
					$("#timetableDialogAbort").before(check);
					$("#timetableDialog").trigger("create");
					$("#timetableDialog").popup();
					
					setTimeout(function(){open($("#timetableDialog"));}, 50);
				})
				.fail(ajaxErrorHandler);
		}

		/**
		 * Called by Configuration Dialog. At this point, all needed subjects were marked.
		 * 
		 * @param Event e ... Click-Event of Link
		 */
		function setCourses(e){
			var element = $(e.target);
			var boxes = element.siblings("form").find("input");
			for(var k = 0; k < boxes.length; k++){
				var box = boxes.eq(k);
				if(box.prop("checked")){
					CONFIG.TIMETABLE.temporary[0].groups[0].courses[box.attr("data-hash")] = box.attr("name")
				}
			}
			$("#timetableDialog").popup("close");
			var courses = CONFIG.TIMETABLE.temporary[0].groups[0].courses;
			var ins = '<form>';
			for(var k in courses){
				ins += '<input type="text" name="text-'+k+'" id="text-'+k+'" value="'+courses[k]+'">';
			}
			ins += '</form>';
			ins = $(ins);

			fillPopup("Einrichtung", "Benennen Sie bitte alle Kurse so um, wie es Ihnen am besten gefällt","Ok", renameCourses);
			$("#timetableDialogAbort").before(ins);
			$("#timetableDialog").trigger("create");
			$("#timetableDialog").popup();
			
			setTimeout(function(){open($("#timetableDialog"));}, 50);
		}

		/**
		 * Called by Configuration Dialog. At this point, subjects were renamed. In this step, made configurations are saved permenantly.
		 * 
		 * @param Event e ... Click-Event of Link
		 */
		function renameCourses(e){
			var element = $(e.target);
			var boxes = element.siblings("form");
			var courses = CONFIG.TIMETABLE.temporary[0].groups[0].courses;

			for(var k in courses){
				var box = boxes.find('#text-'+k);
				courses[k] = box.val();
			}

			$("#timetableDialog").popup("close");

			//save courses
			var pushedc = false; var pushedg = false;
			for(var k in CONFIG.TIMETABLE.faculty){
				var faculty = CONFIG.TIMETABLE.faculty[k];
				if(faculty.id == CONFIG.TIMETABLE.temporary[0].id){
					for(var s in CONFIG.TIMETABLE.faculty[k].groups){
						var group = CONFIG.TIMETABLE.faculty[k].groups[s];
						if(group.id == CONFIG.TIMETABLE.temporary[0].groups[0].id){
							for(var l in courses){
								CONFIG.TIMETABLE.faculty[k].groups[s].courses[l] = courses[l]; //Add/Rename Courses
							}
							pushedc = true;
						}
					}
					if(pushedc == false) { //Nothing was pushed
						CONFIG.TIMETABLE.faculty[k].groups.push(CONFIG.TIMETABLE.temporary[0].groups[0]);//Add group
						pushedg = true;
					}
				}
			}
			if(pushedc == false && pushedg == false){//Nothing was pushed
				CONFIG.TIMETABLE.faculty.push(CONFIG.TIMETABLE.temporary[0]);//Add faculty
			}
			saveParameters();
			CONFIG.TIMETABLE.temporary = [];

			fillPopup("Einrichtung", "Wollen Sie weitere Kurse hinzufügen?","Ja", showConfigDialog);
			
			setTimeout(function(){open($("#timetableDialog"));}, 50);
		}

		/*********************************************************************************************************************
		  * END of "This Area is used for Timetable Configuration Dialogs"
		*/

		/**
		 * Loading the available Weeks and fill the preselected Timetable.
		 */
		function initTimetableView() {
			var date = new Date();
			var today = date.getDay();

			$("#actualDay").attr("data-day",today);
			timetableFill();
			
			GLOBAL.INIT.timetable = true;
		};
		
		/**
		 * 
		 */
		function timetableFill() {

			$.getJSON(CONFIG.SERVER.base+CONFIG.SERVER.timetable+"cal")
			 .done(function(data, status, jqXHR) {
					if(!isEmpty(data.message)){ajaxErrorHandler(data, status, jqXHR); return;}

			 		CONFIG.TIMETABLE.semester = data.semester;
					$("#actualWeek").attr("data-week", data.current);
			 		
			 		if(CONFIG.TIMETABLE.faculty.length != 0) timetableGetDayData();
			})
			.fail(ajaxErrorHandler);
		}

		function timetableGetDayData(){

			var aWeek = $("#actualWeek"); 
			var aDay = $("#actualDay");
			var week = aWeek.attr("data-week");
			aWeek.empty().append(''+week+'. Planungswoche');
			var day = aDay.attr("data-day");
			var weekday = ["abc", "Montag", "Dienstag", "Mittwoch", "Donnerstag", "Freitag", "Samstag", "Sonntag"];
			aDay.empty().append(weekday[day]);

			for(var k in CONFIG.TIMETABLE.faculty){
				var faculty = CONFIG.TIMETABLE.faculty[k];
				for(var s in faculty.groups){
					var group = faculty.groups[s];
					$.getJSON(CONFIG.SERVER.base+CONFIG.SERVER.timetable+CONFIG.TIMETABLE.semester+"/"+faculty.id+"/week/"+week+"/"+day+"?semgroup="+group.id)
					.done(function(data, status, jqXHR) {
						if(!isEmpty(data.message)){ajaxErrorHandler(data, status, jqXHR); return;}

						timetableFillDay(data);
					})
					.fail(ajaxErrorHandler);
				}
			}
		}

		function timetableFillDay(data){

			$("#dayCards").empty();

			var added = false;
			for(var k in CONFIG.TIMETABLE.faculty){
				var faculty = CONFIG.TIMETABLE.faculty[k];
				for(var s in faculty.groups){
					var group = faculty.groups[s];
					for(var m in data.dayContent){
						dayCourse = data.dayContent[m];
						if(!isEmpty(group.courses[dayCourse.suid])){
							timetableAddDayCourse(dayCourse,group.courses[dayCourse.suid])
							added = true;
						}
					}	
				}
			}
			if(added == false){
				$("#dayCards").append('<li data-cards-type="text"><h1>Keine Veranstaltungen!</h1></li>').trigger("create");	
			}
		}
		function timetableAddDayCourse(course, name){
			
			var li ='<li data-cards-type="text">';

			li += '<h1>'+name+'</h1><hr/>'+
				'<p><strong>'+course.begin+'-'+course.end+'</strong><br/>'+
				'<strong>Dozent:</strong> '+course.docentDetailed+'<br/>'+
				'<strong>Ort:</strong> '+course.location+'<br/>'+
				'<strong>Typ:</strong> '+course.type+'</p>';

			li += '</li>';
			$("#dayCards").append(li).trigger("create");
		}
	</script>
</div>

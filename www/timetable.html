<div id="timetable_page" data-role="page" data-dom-cache="true" data-title="Stundenplan" data-theme="a" data-content-theme="a">
	<div data-role="content" class="toblur">
		<div data-role="navbar">
			<p>
				<select id="timetable_week_select"></select>
			</p>
		    <ul id="timetable_nav">
		        <li><a href="#" data-day="Mon">Montag</a></li>
		        <li><a href="#" data-day="Tue">Dienstag</a></li>
		        <li><a href="#" data-day="Wed">Mittwoch</a></li>
		        <li><a href="#" data-day="Thu">Donnerstag</a></li>
		        <li><a href="#" data-day="Fri">Freitag</a></li>
		    </ul>
		</div>
		<div id="timetable_days">
			<table class="timetable_content">
				<thead>
					<tr>
						<th>Beginn</th>
						<th>Ende</th>
						<th>KW</th>
						<th>Ort</th>
						<th>Typ</th>
						<th>Name</th>
						<th>Dozent</th>
						<th>Hinweise</th>
					</tr>
				</thead>
				<tbody data-day="Mon"></tbody>
				<tbody data-day="Tue"></tbody>
				<tbody data-day="Wed"></tbody>
				<tbody data-day="Thu"></tbody>
				<tbody data-day="Fri"></tbody>
			</table>
		</div>
	</div>
	<footer data-role="footer" data-position="fixed" class="toblur">
		<div class="center">
			<a data-role="button" href="#" id="extendTimetable">Kalender erweitern...</a>
		</div>
	</footer>

	<script>		
		$( "#timetable_page" )
			.on("pagecreate", initTimetableView)
			.on("pageshow", function() {
				if(!GLOBAL.INIT.timetable) loadingIn();
    				$("#btn_refresh")
					.off()
					.on("click", function() {
						$("#timetable_week_select").change(); 
					 });
				if(CONFIG.TIMETABLE.faculty.length == 0) showConfigDialog();
			 })
			.on("click", "#timetable_nav a", function(e) {
				$("#timetable_days table")
					.find("tbody")
					.hide().end()
					.find("tbody:jqmData(day='"+$(e.target).jqmData("day")+"')")
					.show();
			 })
			.on("swipeleft", "#timetable_days tbody", function() {
					var o = $(this);	
					
					if(o.index()<5)
					{	
						$("#timetable_nav a").eq(o.index()).not(".ui-disabled").click();
					}
			 })
			.on("swiperight", "#timetable_days tbody", function() {
					var o = $(this);	
					
					if(o.index()>1)
					{
						$("#timetable_nav a").eq(o.index()-2).not(".ui-disabled").click();
					}
			 });
			
		$( "#timetable_week_select" )
			.on("change", function() {
				$("#timetable_days table tbody").empty();
				fillTimetable();
			 });
		$("#extendTimetable")
			.on("click", showConfigDialog);

		/**
		 * Get a Popup with a Heading and a Description
		 * 
		 * @param String heading ... Heading of the Popup
		 * @param String description ... Text to display in the Popup
		 * @param Optional String btn_text ... If set, another button with btn_text as text will be displayd
		 * @param Optional Function func ... Callbackfunction for optional button
		 * 
		 * @return jQueryMobile Popup
		 */
		function getPopup(heading, description, btn_text, func){
			var p;
			var div = $('<div data-role="popup" id="timetablePopup'+Math.random()+'"></div>');
			var btn = $('<a class="popup-abort">Abbrechen</a>')
						.buttonMarkup({inline : true, icon : "back"})
						.on("click", abortSetup);
			var btn_save = ""
			if(!isEmpty(btn_text)){
				btn_save = $('<a>'+btn_text+'</a>')
						.buttonMarkup({inline : true, icon : "check"})
						.on("click", func);
			}
				
			div.append('<div data-role="header" data-theme="a"><h1>'+heading+'</h1></div><h4>'+description+'</h4>')
			   .append(btn)
			   .append(btn_save);
			
			p = div.popup({
					dismissible : false,
					theme : "b",
					overlyaTheme : "b",
					transition : "pop"
			 	})
			 	.on("popupafterclose", function() {
					popupOpen = false;
					$(this).remove();
			 	 });

			return p;
		};

		/**
		 * Aborts the displayed Dialog and resets configurations (if not completed)
		 * 
		 * @param Event e ... Click-Event of Link
		 */
		function abortSetup(e) {
			CONFIG.TIMETABLE.temporary= [];
			if(CONFIG.TIMETABLE.faculty.length != 0) $("#timetable_week_select").change();
			$(e.target).parent().popup("close");
		};

		var popupOpen = false;

		/**
		 * Opens the given Popup whenever another Popup is closed
		 * 
		 * @param JQueryMobile Popub popUp ... Popup to open
		 */
		function open(popUp){
			if(popupOpen == true){
				setTimeout(function(){open(popUp);}, 50);
				return;
			}
			loadingOut();
			popUp.popup("open").popup({afteropen: function() {popupOpen = true;}});
		}

		/**
		 * Starts Configuration Dialog for Timetable.
		 * 
		 * @param Optional Event e ... Click-Event of Link
		 */
		function showConfigDialog(e) {	
			if(!isEmpty(e)){
				var popUp = $(e.target).parents("div", {"data-role": "popup"}).eq(0);
				console.log(popUp);
				if(popUp.data("role") == "popup") popUp.popup("close");
			}
			loadingIn();
			$.getJSON(CONFIG.SERVER.base+CONFIG.SERVER.timetable+"/cal")
			 .done(function (data, status, jqXHR) {
					CONFIG.TIMETABLE.semester = data.semester;
					$.getJSON(CONFIG.SERVER.base+CONFIG.SERVER.timetable+data.semester)
			 		 .done(function (data, status, jqXHR) {
			 			var popUp = getPopup("Einrichtung", "Bitte wählen Sie ihren Studiengang aus!");
						var ul = '<ul id="chooseCourse" data-func="course" data-role="listview" data-inset="true" data-filter="true" data-filter-reveal="true" data-filter-placeholder="Suche Studiengang...">';
						
						for(var k in data) {
							for(var s in data[k].courses) {
								var course = data[k].courses[s];
								ul += '<li class="ui-screen-hidden" data-course="'+course.id+'" data-faculty="'+data[k].id+'"><a href="#">'+course.name+'</a></li>';
							}
						}

						ul += '</ul>';
						
						ul = $(ul).on("click", "a", facultyChosen);
						
						popUp.find("a.popup-abort").before(ul);
						popUp.trigger("create").popup({afteropen: function() {popupOpen = true;}});
						setTimeout(function(){open(popUp);}, 50);
						
						loadingOut();
					});
			});
		};

		/**
		 * Called by Configuration Dialog. At this point, a faculty was chosen.
		 * 
		 * @param Event e ... Click-Event of Link
		 */
		function facultyChosen(e) {
			var li = $(e.target).parent("li");
			var id = li.jqmData("course");
			var fac = li.jqmData("faculty");
			
			loadingIn();
			CONFIG.TIMETABLE.temporary.push({"id": id, "groups": []});
			
			li.closest("div:jqmData(role='popup')").popup("close");
			
			$.getJSON(CONFIG.SERVER.base+CONFIG.SERVER.timetable+CONFIG.TIMETABLE.semester)
		 		.done(function (data, status, jqXHR) {
		 			var popUp = getPopup("Einrichtung", "Bitte wählen Sie ihren Kurs aus!");
		 			
		 			// watch out
					var lis = '<ul data-role="listview">';
					
					for(var k in data) {
						for(var s in data[k].courses) {
							var course = data[k].courses[s];
							
							if(course.id === id) {
								for(var p in course.semGroups) {
									lis += '<li><a href="#">'+course.semGroups[p]+'</a></li>';
								}
							}
						}
					}
					
					lis += '</ul>';
					
					lis = $(lis).on("click", "a", courseChosen); 
					
					popUp.find("a.popup-abort").before(lis);
					popUp.trigger("create").popup({afteropen: function() {popupOpen = true;}});
					setTimeout(function(){open(popUp);}, 50);
				});
		};

		/**
		 * Called by Configuration Dialog. At this point, a course was chosen.
		 * 
		 * @param Event e ... Click-Event of Link
		 */
		function courseChosen(e){
			var element = $(e.target);
			var course = element.text();

			loadingIn();
			CONFIG.TIMETABLE.temporary[0].groups.push({"id": course, "courses": {}});
			$(e.target).parents("div", {"data-role": "popup"}).eq(0).popup("close");

			$.getJSON(CONFIG.SERVER.base+CONFIG.SERVER.timetable+CONFIG.TIMETABLE.semester+"/"+CONFIG.TIMETABLE.temporary[0].id+"/courses?semgroup="+course)
		 		.done(function (data, status, jqXHR) {
		 			var popUp = getPopup("Einrichtung", "Bitte kreuzen Sie alle Kurse an, die Sie in ihrem Stundenplan möchten!","Ok", setCourses);
		 			
					var check = '<form><fieldset data-role="controlgroup">';
					
					for(var k in data) {
						var course = data[k];
							
						check += '<input type="checkbox" name="'+course+'" id="'+course+'" data-hash="'+k+'"><label for="'+course+'">'+course+'</label>';
					}
					
					check += '</fieldset></form>';
					
					check = $(check); 
					popUp.find("a.popup-abort").before(check);
					popUp.trigger("create").popup({afteropen: function() {popupOpen = true;}});
					setTimeout(function(){open(popUp);}, 50);
				});
		}

		/**
		 * Called by Configuration Dialog. At this point, all needed subjects were marked.
		 * 
		 * @param Event e ... Click-Event of Link
		 */
		function setCourses(e){
			var element = $(e.target);
			var boxes = element.siblings("form").find("input");
			for(var k = 0; k < boxes.length; k++){
				var box = boxes.eq(k);
				if(box.prop("checked")){
					CONFIG.TIMETABLE.temporary[0].groups[0].courses[box.attr("data-hash")] = box.attr("name")
				}
			}
			$(e.target).parents("div", {"data-role": "popup"}).eq(0).popup("close");
			var popUp = getPopup("Einrichtung", "Benennen Sie bitte alle Kurse so um, wie es Ihnen am besten gefällt","Ok", renameCourses);
			var courses = CONFIG.TIMETABLE.temporary[0].groups[0].courses;
			var ins = '<form>';
			for(var k in courses){
				ins += '<input type="text" name="text-'+k+'" id="text-'+k+'" value="'+courses[k]+'">';
			}
			ins += '</form>';
			ins = $(ins);
			popUp.find("a.popup-abort").before(ins);
			popUp.trigger("create").popup({afteropen: function() {popupOpen = true;}});
			setTimeout(function(){open(popUp);}, 50);
		}

		/**
		 * Called by Configuration Dialog. At this point, subjects were renamed. In this step, made configurations are saved permenantly.
		 * 
		 * @param Event e ... Click-Event of Link
		 */
		function renameCourses(e){
			var element = $(e.target);
			var boxes = element.siblings("form");
			var courses = CONFIG.TIMETABLE.temporary[0].groups[0].courses;
			for(var k in courses){
				var box = boxes.find('#text-'+k);
				courses[k] = box.val();
			}
			$(e.target).parents("div", {"data-role": "popup"}).eq(0).popup("close");
			CONFIG.TIMETABLE.faculty.push(CONFIG.TIMETABLE.temporary[0]);
			CONFIG.TIMETABLE.temporary = [];
			saveParameters();
			var popUp = getPopup("Einrichtung", "Wollen Sie weitere Kurse hinzufügen?","Ja", showConfigDialog);
			popUp.trigger("create").popup({afteropen: function() {popupOpen = true;}});
			setTimeout(function(){open(popUp);}, 50);
		}

		/**
		 * Loading the available Weeks and fill the preselected Timetable.
		 */
		function initTimetableView() {
			var date = new Date();
			var day = getWeekDay(date).id;
			
			fillTimetableSelect();
			
			/*$( "#timetable_week_label" )
			 	.html("Aktuelle Woche von "+ formatDate(GLOBAL.DATE.currentWeek[0], GLOBAL.DATE.formats.de)+
					  " bis "+formatDate(GLOBAL.DATE.currentWeek[4], GLOBAL.DATE.formats.de));*/// --> TODO iwie sinnlos...den Platz kann ich besser fürn Button gebrauchen
			
			// open the tab for current day
			$( "#timetable_nav a:jqmData(day='"+day+"')" )
				.addClass("ui-btn-active")
				.click();
			
			GLOBAL.INIT.timetable = true;
		};

		/**
		 * Loading the selected Week into the Timetable.
		 */
		function fillTimetable() {
			var tbs = $("#timetable_days table tbody");
			var week = $("#timetable_week_select").val();
			var deferreds = [];
			var fac;
			
			loadingIn();
			for(var f in CONFIG.TIMETABLE.faculty) 
			{
				fac = CONFIG.TIMETABLE.faculty[f];
				for(var g in fac.groups)
				{
					deferreds[deferreds.length] = fillTimetableWeek(tbs, week, fac.id, fac.groups[g]);
				}
			}
			
			$.when.apply($, deferreds)
			 .then(function() {
				 for(var i=0;i<tbs.length;i++)
				 {
					var trs = tbs.eq(i).find("tr").detach();
					
					if(trs.length>0)
					{
						trs = trs.sort(function(a,b) {
							var o1 = $(a).find("td").first().text();
							var o2 = $(b).find("td").first().text();
							
							if(o1.length==4) o1 = "0"+o1;
							if(o2.length==4) o2 = "0"+o2;
							
							console.log(o1+" "+o2);
							
							if(o1==o2) return 0;
							else if(o1>o2) return 1;
							else return -1;
						});
						 
						 tbs.eq(i).append(trs);
					}
					else
					{
						tbs.eq(i)
						   .append('<tr><td colspan="8">Keine Veranstaltungen.</td></tr>')
						   .trigger("create");
					}
				 }
				 
				 loadingOut();
			 });
		};
		
		/**
		 * Fill the Timetable Day by Day for the given Faculty and Group in the given Week.
		 * 
		 * @param jQuery-Object tbs ... TBody's of Timetable
		 * @param String week ... Week Number
		 * @param String faculty ... Faculty ID (e.g. "FIMN")
		 * @param Array[Object] group ... Courses and Group ID from Settings
		 * 
		 * @return jQuery-Deferred
		 * 
		 * @see CONFIG.TIMETABLE
		 */
		function fillTimetableWeek(tbs, week, faculty, group) {
			return $.getJSON(CONFIG.SERVER.base+CONFIG.SERVER.timetable+CONFIG.TIMETABLE.semester+"/"+faculty+"/week/"+week+"?semgroup="+group.id)
			 		.done(function (data, status, jqXHR) {
			 				if(!isEmpty(data))
			 				{
			 					for(var k in data)
			 					{	
			 						addTimetableWeekday(tbs.eq(k), data[k].dayContent, group);
			 					}
			 				}
							loadingOut();
			 		 });
				   //.fail(ajaxErrorHandler);
		};
		
		/**
		 * Adding Courses from the Request to the Weekday.
		 * 
		 * @param jQuery-Object tb ... TBody-Element (TBody representing the Day)
		 * @param Array courses ... all Courses for the Day
		 * @param Array[Object] group ... Courses and Group ID from Settings
		 * 
		 * @see CONFIG.TIMETABLE
		 */
		function addTimetableWeekday(tb, courses, group) {
			var trs = "";
			var n, c, d;

			if(!isEmpty(tb) && !isEmpty(courses))
			{
				for(var i=0;i<courses.length;i++)
				{	
					c = courses[i];
					n = group.courses[c.suid];
					d = (CONFIG.TIMETABLE.showDocentFullName && !isEmpty(c.docentDetailed))?c.docentDetailed:c.docent;
					
					if(!isEmpty(n))
					{	
						trs += 	'<tr>'+
									'<td>'+c.begin+'</td>'+
									'<td>'+c.end+'</td>'+
									'<td>'+c.kw+'</td>'+
									'<td>'+c.location+'</td>'+
									'<td>'+c.type+'</td>'+
									'<td>'+n+'</td>'+
									'<td>'+d+'</td>'+
									'<td>'+c.notes+'</td>'+
								'</tr>';
					}
				}
				
				tb.append(trs)
				  .trigger("create");
			}
		};
		
		/**
		 * Loading all Weeks for the Timetable.
		 */
		function fillTimetableSelect() {
			$.getJSON(CONFIG.SERVER.base+CONFIG.SERVER.timetable+"cal")
			 .done(function(data, status, jqXHR) {
			 		var opts = "";
			 		
			 		for(var k in data)
			 		{	
			 			if(k.search(/^\d+$/)==0)
			 			{
			 				opts += '<option value="'+k+'">'+data[k]+'</option>';
			 			}
			 		}
			 		
			 		// TODO move to Settings
			 		CONFIG.TIMETABLE.semester = data.semester;

			 		$( "#timetable_week_select" )
			 			.append(opts)
			 			.find("option[value='"+data.current+"']")
			 			.prop("selected", true).end()
			 			.selectmenu("refresh");
			 		
			 		if(CONFIG.TIMETABLE.faculty.length != 0) fillTimetable();
			   });
			//.fail(ajaxErrorHandler);
		};
	</script>
</div>

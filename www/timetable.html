<div id="timetable_page" data-role="page" data-title="Stundenplan" data-theme='b' data-dom-cache="true">

	<div data-role="header" data-position="fixed" data-tap-toggle="false" data-theme='b' class="header">
		<a href="#panelMenu" class="ui-btn-left ui-btn ui-btn-inline ui-mini ui-corner-all btn_menu"><i class="fa fa-bars fa-lg"></i></a>
		<h1>HTWK App</h1>
		<a href="#timetableInfoPopup" data-rel="popup" data-position-to="window" data-transition="pop" class="ui-btn-right ui-btn ui-btn-inline ui-mini ui-corner-all"><i class="fa fa-info fa-lg"></i></a>
	</div>

	<div role="main" class="ui-content">   
		<h1 id="actualWeek" data-week="-1">Woche wird geladen...</h1>
		<h1 id="actualDay" data-day=""></h1>
		<a id="prevDay" href="#" class="ui-btn ui-btn-icon-notext ui-icon-carat-l ui-corner-all ui-shadow ui-btn-inline"></a>
		<a id="nextDay" href="#" class="ui-btn ui-btn-icon-notext ui-icon-carat-r ui-corner-all ui-shadow ui-btn-inline"></a>
		<hr/>
		<ul id="dayCards" class="nativeDroidCards"></ul>
	</div>

	<div data-role="footer" data-position="fixed" data-tap-toggle="false" data-theme="b">
		<a id="extendTimetable" href="#" class="ui-btn ui-mini ui-corner-all ui-shadow" style="margin-left: 10px;">Kalender erweitern</a>
	</div>

	<div id="timetableDialog" data-role="popup" data-dismissible="false" data-theme="a" data-overlay-theme="a" data-content-theme="a" data-transition="pop" class="ui-corner-all">
		<div id="timetableDialogHeader" data-role="header">
			<h1>bla</h1>
		</div>
		<div id="timetableDialogContent" role="main" class="ui-content">
		</div>
	</div>

	<div id="timetableInfoPopup" data-role="popup" data-theme="a" data-overlay-theme="a" class="ui-corner-all">
		<div data-role="header" data-theme='a'>
			<h1>Informationen</h1>
		</div>
		<div role="main" class="ui-content">
			<p>Leider bietet die App es bisher nicht, den von dir zusammgenstellten Stundenplan in den Systemkalender zu übernehmen. Du kannst das aber komfortabel auf einer Website machen. Dort ist auch erklärt, wie man den Kalender fast überall einbindet.<br/>Du kommst über folgende Adresse zur Website:
				<br/><br/>http://www.htwk-stundenplan.de/<br/><br/>
				Leider musst du den Link noch manuell in den Browser kopieren. An einer Lösung wird gearbeitet.
			</p>
			<a href="#" data-rel="back" class="ui-btn ui-btn-inline ui-mini ui-corner-all ui-shadow">Zurück</a>
		</div>
	</div>

	<script>		
	/*TODO
	 * timetableInfoPopup Button "zur website" doesn't open
	 * Add function do delete timetable, when semester has changed (+ inform/request user)
	 * sort timetable list
	*/
		$( "#timetable_page" )
			.on("pagecreate", initTimetableView)
			.on("pageshow", function() {
				if(!GLOBAL.INIT.timetable) loadingIn();
				if(CONFIG.TIMETABLE.faculty.length === 0) {
					showConfigDialog();
				} else if($("#actualWeek").attr("data-week") != -1){
					timetableGetDayData();
				}
				if(WURFL.is_mobile){
					analytics.trackView('timetable');
				}
			 })
			.on("swipeleft", nextDay)
			.on("swiperight", prevDay);
			
		$('#nextDay').on("click", nextDay);
		$('#prevDay').on("click", prevDay);
			 
		function nextDay(){
			var aDay = $("#actualDay");
			var aWeek = $("#actualWeek");
			var day = parseInt(aDay.attr("data-day"))+1;
			var week = parseInt(aWeek.attr("data-week"));
			if(day > 7){
				day = 1;
				week += 1;
				aWeek.attr("data-week", week);
			}
			aDay.attr("data-day", day);
			timetableGetDayData();
		}
		
		function prevDay(){
			var aDay = $("#actualDay");
			var aWeek = $("#actualWeek");
			var day = parseInt(aDay.attr("data-day"))-1;
			var week = parseInt(aWeek.attr("data-week"));
			if(day < 1){
				day = 7;
				week -= 1;
				aWeek.attr("data-week", week);
			}
			aDay.attr("data-day", day);
			timetableGetDayData();
		}
			
		$("#extendTimetable")
			.on("click", showConfigDialog);

		/*********************************************************************************************************************
		  * This Area is used for Timetable Configuration Dialogs
		*/

		var popupOpen = false;

		/**
		 * Get a Popup with a Heading and a Description
		 * 
		 * @param String heading ... Heading of the Popup
		 * @param String description ... Text to display in the Popup
		 * @param Optional String btn_text ... If set, another button with btn_text as text will be displayd
		 * @param Optional Function func ... Callbackfunction for optional button
		 * 
		 * @return jQueryMobile Popup
		 */
		function fillPopup(heading, description, btn_text, func, btn_abr_text){
			if(isEmpty(btn_abr_text)) btn_abr_text = "Abbrechen";
			$("#timetableDialogHeader").empty().append('<h3>'+heading+'</h3>');
			$("#timetableDialogContent").empty().append('<p>'+description+'</p>');
			$("#timetableDialogContent").append('<a id="timetableDialogAbort" href="#" data-role="button" data-icon="back" data-mini="true" data-inline="true" class="ui-corner-all ui-shadow">'+btn_abr_text+'</a>');

			if(!isEmpty(btn_text)){
				$("#timetableDialogContent").append('<a id="timetableDialogSave" href="#" data-role="button" data-icon="check" data-mini="true" data-rel="back" data-inline="true" class="ui-corner-all ui-shadow">'+btn_text+'</a>');
			}
			$.mobile.activePage.trigger('popup').trigger("create");
			$("#timetableDialog")
				.popup().off()
				.on("popupafteropen", function() {popupOpen = true;})
				.on("popupafterclose", function() {
					popupOpen = false;
			 	 });
			$("#timetableDialogAbort").off().on("click", abortSetup);
			$("#timetableDialogSave").off().on("click", func);
		}

		/**
		 * Aborts the displayed Dialog and resets configurations (if not completed)
		 * 
		 * @param Event e ... Click-Event of Link
		 */
		function abortSetup() {
			$("#timetableDialog").popup("close");
			CONFIG.TIMETABLE.temporary= [];
			if(CONFIG.TIMETABLE.faculty.length !== 0) initTimetableView();
		}

		/**
		 * Opens the given Popup whenever another Popup is closed
		 * 
		 * @param JQueryMobile Popub popUp ... Popup to open
		 */
		function open(popUp){
			if(popupOpen === true){
				setTimeout(function(){open(popUp);}, 50);
				return;
			}
			loadingOut();
			$("#timetableDialog").popup("open");
		}

		function noContent(text){
			loadingOut();
			loadingIn(text,true);
			setTimeout(loadingOut, 3000);
			CONFIG.TIMETABLE.temporary= [];
		}

		/**
		 * Starts Configuration Dialog for Timetable.
		 * 
		 * @param Optional Event e ... Click-Event of Link
		 */
		function showConfigDialog() {	
			loadingIn();
			$.getJSON(CONFIG.SERVER.base+CONFIG.SERVER.timetable+"/cal")
			 .done(function (data, status, jqXHR) {
				if(!isEmpty(data.message)){ajaxErrorHandler(data, status, jqXHR, abortSetup); return;}
				CONFIG.TIMETABLE.semester = data.semester;
				$.getJSON(CONFIG.SERVER.base+CONFIG.SERVER.timetable+data.semester)
		 		 .done(function (data, status, jqXHR) {
					if(!isEmpty(data.message)){ajaxErrorHandler(data, status, jqXHR, abortSetup); return;}

					var ul = '<ul id="chooseCourse" data-func="course" data-role="listview" data-inset="true" data-filter="true" data-filter-reveal="true" data-filter-placeholder="Suche Studiengang...">';
					
					for(var k in data) {
						for(var s in data[k].courses) {
							var course = data[k].courses[s];
							ul += '<li class="ui-screen-hidden" data-course="'+course.id+'" data-faculty="'+data[k].id+'"><a href="#">'+course.name+'</a></li>';
						}
					}

					ul += '</ul>';
					ul = $(ul).on("click", "a", facultyChosen);

					fillPopup("Einrichtung", "Bitte wählen Sie ihren Studiengang aus!");
					$("#timetableDialogAbort").before(ul);
					$("#timetableDialog").trigger("create").popup();
					
					setTimeout(function(){open($("#timetableDialog"));}, 50);
					
					loadingOut();
				})
				.fail(ajaxErrorHandler);
			})
			.fail(ajaxErrorHandler);
		}

		/**
		 * Called by Configuration Dialog. At this point, a faculty was chosen.
		 * 
		 * @param Event e ... Click-Event of Link
		 */
		function facultyChosen(e) {
			var li = $(e.target).parent("li");
			var id = li.jqmData("course");
			
			loadingIn();
			CONFIG.TIMETABLE.temporary.push({"id": id, "groups": []});
			
			li.closest("div:jqmData(role='popup')").popup("close");
			
			$.getJSON(CONFIG.SERVER.base+CONFIG.SERVER.timetable+CONFIG.TIMETABLE.semester)
		 		.done(function (data, status, jqXHR) {
					if(!isEmpty(data.message)){ajaxErrorHandler(data, status, jqXHR, abortSetup); return;}

					var empty = true;
					var lis = '<ul data-role="listview" id="timetableSemGroupChoose">';
					
					for(var k in data) {
						for(var s in data[k].courses) {
							var course = data[k].courses[s];
							
							if(course.id === id) {
								for(var p in course.semGroups) {
									lis += '<li><a href="#">'+course.semGroups[p]+'</a></li>';
									empty = false;
								}
							}
						}
					}
					
					lis += '</ul>';
					lis = $(lis).on("click", "a", courseChosen); 
					
					fillPopup("Einrichtung", "Bitte wählen Sie ihren Kurs aus!");
					$("#timetableDialogAbort").before(lis);
					$("#timetableDialog").trigger("create");
					$("#timetableDialog").popup();
					
					if(empty === true) {noContent("Es existieren keine Matrikel bzgl. Ihres Studiengangs!"); return;}
					
					setTimeout(function(){open($("#timetableDialog"));}, 50);
				})
				.fail(ajaxErrorHandler);
		}

		/**
		 * Called by Configuration Dialog. At this point, a course was chosen.
		 * 
		 * @param Event e ... Click-Event of Link
		 */
		function courseChosen(e){
			var element = $(e.target);
			var course = element.text();

			loadingIn();
			CONFIG.TIMETABLE.temporary[0].groups.push({"id": course, "courses": {}});
			$("#timetableDialog").popup("close");

			$.getJSON(CONFIG.SERVER.base+CONFIG.SERVER.timetable+CONFIG.TIMETABLE.semester+"/"+CONFIG.TIMETABLE.temporary[0].id+"/courses?semgroup="+course)
		 		.done(function (data, status, jqXHR) {
					if(!isEmpty(data.message)){ajaxErrorHandler(data, status, jqXHR, abortSetup); return;}

					var empty = true;
					var check = '<form><fieldset data-role="controlgroup">';
					
					for(var k in data) {
						var course = data[k];
							
						check += '<input type="checkbox" name="'+course+'" id="'+course+'" data-hash="'+k+'"><label for="'+course+'">'+course+'</label>';
						empty = false;
					}
					
					check += '</fieldset></form>';

					if(empty === true) {noContent("Es existieren keine Fächer bzgl. Ihres Matrikels!"); return;}
					
					check = $(check); 
					fillPopup("Einrichtung", "Bitte kreuzen Sie alle Kurse an, die Sie in ihrem Stundenplan möchten!","Ok", setCourses);
					$("#timetableDialogAbort").before(check);
					$("#timetableDialog").trigger("create");
					$("#timetableDialog").popup();
					
					setTimeout(function(){open($("#timetableDialog"));}, 50);
				})
				.fail(ajaxErrorHandler);
		}

		/**
		 * Called by Configuration Dialog. At this point, all needed subjects were marked.
		 * 
		 * @param Event e ... Click-Event of Link
		 */
		function setCourses(e){
			var element = $(e.target);
			var boxes = element.siblings("form").find("input");
			for(var k = 0; k < boxes.length; k++){
				var box = boxes.eq(k);
				if(box.prop("checked")){
					CONFIG.TIMETABLE.temporary[0].groups[0].courses[box.attr("data-hash")] = box.attr("name");
				}
			}
			$("#timetableDialog").popup("close");
			var courses = CONFIG.TIMETABLE.temporary[0].groups[0].courses;
			var ins = '<form>';
			for(var i in courses){
				ins += '<input type="text" name="text-'+i+'" id="text-'+i+'" value="'+courses[i]+'">';
			}
			ins += '</form>';
			ins = $(ins);

			fillPopup("Einrichtung", "Benennen Sie bitte alle Kurse so um, wie es Ihnen am besten gefällt","Ok", renameCourses);
			$("#timetableDialogAbort").before(ins);
			$("#timetableDialog").trigger("create");
			$("#timetableDialog").popup();
			
			setTimeout(function(){open($("#timetableDialog"));}, 50);
		}

		/**
		 * Called by Configuration Dialog. At this point, subjects were renamed. In this step, made configurations are saved permenantly.
		 * 
		 * @param Event e ... Click-Event of Link
		 */
		function renameCourses(e){
			var element = $(e.target);
			var boxes = element.siblings("form");
			var courses = CONFIG.TIMETABLE.temporary[0].groups[0].courses;

			for(var i in courses){
				var box = boxes.find('#text-'+i);
				courses[i] = box.val();
			}

			$("#timetableDialog").popup("close");

			//save courses
			var pushedc = false; var pushedg = false;
			for(var k in CONFIG.TIMETABLE.faculty){
				var faculty = CONFIG.TIMETABLE.faculty[k];
				if(faculty.id == CONFIG.TIMETABLE.temporary[0].id){
					for(var s in CONFIG.TIMETABLE.faculty[k].groups){
						var group = CONFIG.TIMETABLE.faculty[k].groups[s];
						if(group.id == CONFIG.TIMETABLE.temporary[0].groups[0].id){
							for(var l in courses){
								CONFIG.TIMETABLE.faculty[k].groups[s].courses[l] = courses[l]; //Add/Rename Courses
							}
							pushedc = true;
						}
					}
					if(pushedc === false) { //Nothing was pushed
						CONFIG.TIMETABLE.faculty[k].groups.push(CONFIG.TIMETABLE.temporary[0].groups[0]);//Add group
						pushedg = true;
					}
				}
			}
			if(pushedc === false && pushedg === false){//Nothing was pushed
				CONFIG.TIMETABLE.faculty.push(CONFIG.TIMETABLE.temporary[0]);//Add faculty
			}
			CONFIG.TIMETABLE.temporary = [];
			saveParameters();

			fillPopup("Einrichtung", "Wollen Sie weitere Kurse hinzufügen?","Ja", showConfigDialog, "Nein");
			
			setTimeout(function(){open($("#timetableDialog"));}, 50);
		}

		/*********************************************************************************************************************
		  * END of "This Area is used for Timetable Configuration Dialogs"
		*/

		/**
		 * Sets the day to the actual day and then fetches the calendar data
		 */
		function initTimetableView() {
			var date = new Date();
			var today = date.getDay();

			$("#actualDay").attr("data-day",today);
			timetableFill();
			
			GLOBAL.INIT.timetable = true;
		}
		
		/**
		 * Fetches the calendar data, sets the actual week und then fills the timetable for the actual day
		 */
		function timetableFill() {

			$.getJSON(CONFIG.SERVER.base+CONFIG.SERVER.timetable+"cal")
			 .done(function(data, status, jqXHR) {
					if(!isEmpty(data.message)){ajaxErrorHandler(data, status, jqXHR); return;}

			 		if(isEmpty(CONFIG.TIMETABLE.semester))
						CONFIG.TIMETABLE.semester = data.semester;
					else if(CONFIG.TIMETABLE.semester != data.semester){
						//TODO Delete Plan and ask for new one
					} else {
						$("#actualWeek").attr("data-week", data.current);
				 		
				 		if(CONFIG.TIMETABLE.faculty.length !== 0) timetableGetDayData();
					}
			})
			.fail(ajaxErrorHandler);
		}

		/**
		 * Fetchas all courses for the actual day/week that are configured by the user
		 */
		function timetableGetDayData(){

			loadingIn();

			var aWeek = $("#actualWeek"); 
			var aDay = $("#actualDay");
			var week = aWeek.attr("data-week");
			var day = aDay.attr("data-day");
			var weekdays = ["abc", "Montag", "Dienstag", "Mittwoch", "Donnerstag", "Freitag", "Samstag", "Sonntag"];
			aWeek.empty().append(''+week+'. Planungswoche');
			aDay.empty().append(weekdays[day]);

			$("#dayCards").empty().append('<li id="nothingToShow"><h1>Keine Veranstaltungen!</h1></li>').trigger("create");

			for(var k in CONFIG.TIMETABLE.faculty){
				var faculty = CONFIG.TIMETABLE.faculty[k];
				for(var s in faculty.groups){
					var group = faculty.groups[s];
					$.getJSON(CONFIG.SERVER.base+CONFIG.SERVER.timetable+CONFIG.TIMETABLE.semester+"/"+faculty.id+"/week/"+week+"/"+day+"?semgroup="+group.id)
					.done(function(data, status, jqXHR) {
						if(!isEmpty(data.message)){ajaxErrorHandler(data, status, jqXHR); return;}

						timetableFillDay(data);
					})
					.fail(ajaxErrorHandler);
				}
			}
		}

		/**
		 * Filters for courses, configured by the user and than adds them to the view
		 *
		 * @param JSON-Object data
		 */
		function timetableFillDay(data){

			var li = '';
			var added = false;

			for(var k in CONFIG.TIMETABLE.faculty){
				var faculty = CONFIG.TIMETABLE.faculty[k];
				for(var s in faculty.groups){
					var group = faculty.groups[s];
					for(var m in data.dayContent){
						dayCourse = data.dayContent[m];
						if(!isEmpty(group.courses[dayCourse.suid])){
							li += timetableAddDayCourse(dayCourse,group.courses[dayCourse.suid]);
							added = true;
						}
					}	
				}
			}
			if(added === true && $("#nothingToShow").length !== 0){
				$("#dayCards").empty();
			}

			$("#dayCards").append(li);
			sortDayList();
			loadingOut(); //TODO if there are more than one faculty, this is called too early
		}

		/**
		 * Adds an specific course to the view
		 *
		 * @param JSON-Object course
		 * @param String name ... name of the course (configured by the user)
		 */
		function timetableAddDayCourse(course, name){
			
			var li ='<li data-begin="'+course.begin.split(":")[0]+'">'+
					'<h1>'+name+'</h1><hr/>'+
					'<p><strong>'+course.begin+'-'+course.end+'</strong><br/>'+
					'<strong>Dozent:</strong> '+course.docentDetailed+'<br/>'+
					'<strong>Ort:</strong> '+course.location+'<br/>'+
					'<strong>Typ:</strong> '+course.type+'</p>'+
				'</li>';
			return li;
		}

		function sortDayList() {
			$("#dayCards li").sort(asc_sort).appendTo("#dayCards").trigger("create");
			// accending sort
			function asc_sort(a, b){
				var first = parseInt($(a).attr("data-begin"));
				var second = parseInt($(b).attr("data-begin"));
			    return (first < second) ? -1 : (first > second) ? 1 : 0;
			}
		}
	</script>
</div>

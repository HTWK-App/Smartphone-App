<div id="qis_page" data-role="page" data-title="QIS" data-dom-cache="true" data-theme='b'>
    <!--- HEADER --->
    <div data-role="header" data-position="fixed" data-theme='b' class="header">
    	<a data-role="button" data-iconpos='left' class="btn_menu"><span class="icon-ellipsis-vertical"></span></a>
    	<h1>HTWK App</h1>
    </div>
	<!--- HEADER --->

	<div data-role="content">
		<div id="qis_list" data-role="collapsible-set" data-content-theme="b"></div>
	</div>

	<script>
	    $( "#qis_page" )
	    	.on("pagecreate", initQISView)
	    	.on("pageshow", function() {
	    			/*$("#btn_refresh")
	    				.off()
	    				.on("click", initQISView);*/
	    			
	    			if(isEmpty(CONFIG.AUTH.credentials)) {
	    				openSignInDialog(initQISView);
	    			} else {
	    				if(!GLOBAL.INIT.qis) loadingIn();	
	    			}
	    	 });

		/**
		 * Fetches Data from the Server to fill the QIS-View.
		 */
		function initQISView() {
			if(!isEmpty(CONFIG.AUTH.credentials)) {
				loadingIn();

				$.getJSON(CONFIG.SERVER.base+CONFIG.SERVER.qis, {credentials: CONFIG.AUTH.credentials, salt: CONFIG.AUTH.salt})
				 .done(function(data, status, jqXHR) {
					if(!isEmpty(data.exception))
						{ ajaxErrorHandler(data, status, jqXHR); return; }

					fillQIS(data);

					loadingOut();
					GLOBAL.INIT.qis = true;
				})
			   .fail(ajaxErrorHandler);
			}
		};
		
		/**
		 * Fill QIS Collapsible Widget.
		 *
		 * @param JSON data
		 */
		function fillQIS(data) {
			var sem, module;
			var divs = "";
			
			if(!isEmpty(data)) {
				for(var k in data) {
					sem = data[k];
					
					divs += '<div id="sem'+sem.id+'" data-role="collapsible" data-collapsed-icon="carat-d" data-expanded-icon="carat-u" '+
							'data-iconpos="right" data-theme="b" data-content-theme="b"><h4>'+sem.description+'</h4>';
					
					if(!isEmpty(sem.modules)) {
						divs += '<ul data-nativedroid-plugin="cards" class="nativeDroidCards">';
	    					for(var l in sem.modules) {
	    						module = sem.modules[l];
	    						
	    						divs += '<li data-cards-type="text" >'+'<div class="inset">'+
								'	<h1>'+module.title+'</h1><hr>'+
								'	<p>'+
								'		'+module.description+
								'		<br/><br/><b>ECTS-Punkte: </b>'+module.ects+
								'		<br/><b>Note: </b>'+module.mark+
								'	</p>'+
								'</li>';
	    					}
					} else {
						divs += '<ul data-nativedroid-plugin="cards" class="nativeDroidCards">'+
							'	<li data-cards-type="text" >'+'<div class="inset">'+
							'		<h1>Keine Informationen verf√ºgbar!</h1>'+
							'	</li>'+
							'</ul>';
					}
					
					divs += '</ul></div>';
				}
				
				$( "#qis_list" )
					.empty()
					.append(divs)
					.collapsibleset("refresh");
			}
		};
	</script>
</div>
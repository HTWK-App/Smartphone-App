<div id="room_page" data-role="page" data-title="Leerer Raum" data-theme="a" data-content-theme="a">
	<div id="roomContent" data-role="content" class="toblur">
		<p>
			<div data-role="fieldcontain">
				<label for="room_select">Gebäude:</label>
				<select id="room_select" name="room_select" data-mini="true">
					<option selected="selected">Liste der nächsten Gebäude wird geladen...</option>
				</select>
			</div>
			<h3>Leere Seminarräume, aufbauend auf ihrer aktuellen Position, sind:<br></h3>
			<ul id="#roomList" data-role="listview">
			</ul>
			<br>
		</p>
	</div>
	<script>
		$( "#room_page" )
			.on("pagecreate", function(){})
			.on("pageshow", function () {
				$("#btn_refresh").hide();
				GLOBAL.INIT.room = true;
				loadingIn("Ihre aktuelle Position wird bestimmt. Bitte haben Sie einen Moment Geduld!");
				getLocation();
			 })
			.on("pagehide", function() {
				$("#btn_refresh").show();
			 });

		var roomCount = 0;

		function getLocation() {
			roomCount = roomCount + 1;
			if(roomCount <= 10)
				navigator.geolocation.getCurrentPosition(locationFound, locationError, { maximumAge: 7000, timeout: 30000, enableHighAccuracy: true });
			else
				locationError();
		}

		function locationFound(position){
			if(position.coords.accuracy > 13) {
				getLocation();
			}else{
				roomCount = 0;
				loadingOut();
				loadingIn();
				$.getJSON(CONFIG.SERVER.base+CONFIG.SERVER.room+'location?location='+position.coords.latitude+','+position.coords.longitude)
				 .done(function(data, status, jqXHR) {
					console.log(data);
					fillBuildingsList(data);
					$("#roomContent").append('<p><iframe src="http://maps.google.de/maps?hl=de&q='+position.coords.latitude+','+position.coords.longitude+'&ie=UTF8&z=16&output=embed" width="90%" height="300" name="GoogleMaps"></iframe></p>');
				  });
			}
		}

		function locationError(){
			loadingOut();
			loadingIn("Ihre Position konnte nicht bestimmt werden!",true);
			setTimeout(loadingOut, 3000);
			$( "#menu" ).panel( "open");
		}

		function fillBuildingsList(data) {
			var tmp, name, id, opts;

			opts = "";
			
			for(var k in data){
				id = data[k].id;
				tmp = "";
				name = data[k].fullName;
				if(k == 0)
					tmp = 'selected="selected"';
				opts += '<option value="'+id+'" '+tmp+'>'+name+'</option>'; 
			}	
			
			$( "#room_select" )
			.empty()
			.append(opts)
			.selectmenu("refresh");

			$.getJSON(CONFIG.SERVER.base+CONFIG.SERVER.room+'http://localhost:8080/app/room/ss/13/1')
				.done(function(data, status, jqXHR) {
					fillRoomList(data, $( "#room_select" ).first.val());
				})
				.fail(function(){
					loadingOut();
					loadingIn("Die Raumliste konnte nicht abgerufen werden!",true);
					setTimeout(lodingOut, 3000);
				});
		}

		function fillRoomList(data, id){
			var room = "";
			var lis = "";
			for(var k in data[id]){
				room = data[id][k];
				lis += 	'<li><h4>'+room.name+'</h4><p>Typ: '+room.type+', Größe: '+room.size+' Plätze</p></li>';
			}
			
			$( "#roomList" )
			.off()
			.empty()
			.append(lis)
			.listview("refresh")
			.trigger("updatelayout");
			loadingOut();
		}
	</script>
</div>

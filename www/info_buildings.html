<div id="building_page" data-role="page" data-dom-cache="true" data-title="Gebäudeplan" data-theme='b' data-display="push">
    <!--- HEADER --->
    <div data-role="header" data-position="fixed" data-theme='b' class="header">
    	<a data-role="button" data-iconpos='left' class="btn_menu"><span class="icon-ellipsis-vertical"></span></a>
    	<h1>HTWK App</h1>
    </div>
    <!--- HEADER --->
    
	<div data-role="content">
		<br/>
		<ul id="buidling_content_list" data-role="listview" data-filter-placeholder="Suche Gebäude..." data-filter="true" data-inset="true">
		</ul>
	</div>
	<style>
		.map-canvas{
			float:left;width:70%; height:100%;
		}
		.mapcontainer{
			float:right;width:30%;height 100%;
		}
	</style>
	<script>
		
		/*TODO
		 *
		 */
	    	$( "#building_page" )
	    		.on("pagecreate", buildingInitBuildingsView)
	    		.on("pageshow", function() {
	    			if(!GLOBAL.INIT.builds) loadingIn();
	    			/*$("#btn_refresh")
						.off()
						.on("click", buildingInitBuildingsView);*/
	    		 });

		/**
		 * Fetches buildings from the Server. Will call buildingFillBuildingsList
		 *
		 */
		function buildingInitBuildingsView() {

			loadingIn();

			$.getJSON(CONFIG.SERVER.base+CONFIG.SERVER.builds)
				.done(function(data, status, jqXHR) {
					if(!isEmpty(data.exception))
						{ ajaxErrorHandler(data, status, jqXHR); return; }

					buildingFillBuildingsList(data);

					loadingOut();
					GLOBAL.INIT.builds = true;
				})
				.fail(ajaxErrorHandler);
		}
		
		/**
		 * Fills the building list widget.
		 *
		 * @ param JSON-Object data
		 *
		 */
		function buildingFillBuildingsList(data) {

			var building, lis = "", desc = "";
			
			for(var k in data){
				building = data[k];
				
				for(var d in building.description){
					if(!isEmpty(building.description[d]))
						desc += building.description[d];
				}
				
				lis += 	'<li data-bid='+building.id+'><a href="#" class="building">'+
							'<h3>'+building.fullName+'</h3>'+
							'<p>'+desc+'</p>'+
							'<p>'+building.address+'</p>'+
						'</a></li>';
			}
				
			$( "#buidling_content_list" )
				.off()
				.empty()
				.append(lis)
				.on("click", "a.building", buildingLoadBuildingDetails)
				.listview("refresh")
				.trigger("updatelayout");
			
			$( "body" )
				.find("div.buildingdetails")
				.remove();
		}

		/**
		 * Fetches building detail data from the Server and initalizes a new page in document to change to.
		 *
		 * @ param Event e
		 *
		 */
		function buildingLoadBuildingDetails(e) {

			var id = $(e.target).parents("li").first().data("bid");

			if($("#building_"+id).length>0) {
				$.mobile.initializePage();
				$.mobile.changePage("#building_"+id);
				return;
			}
			
			loadingIn();
			
			$.getJSON(CONFIG.SERVER.base+CONFIG.SERVER.builds+"/"+id)
				.done(function(data, status, jqXHR) {
					if(!isEmpty(data.exception))
						{ ajaxErrorHandler(data, status, jqXHR); return; }

					var desc = "";
				
					for(var d in data.description){
						if(!isEmpty(data.description[d]))
							desc += data.description[d] + "</br>";
					}
				
					var div ='<div id="building_'+id+'" data-role="page" data-theme="b" data-subpage="true" data-title="Gebäude" class="building_page" data-destination="'+data.latLng.replace(/ /, '')+'">'+
								'<div data-role="header" data-position="fixed" data-tap-toggle="false" data-theme="b" class="header">'+
									'<a href="#" data-rel="back" data-role="button" data-transition="slide" data-direction="reverse"><span class="icon-angle-left"></span></a>'+
									'<h1>HTWK App</h1>'+
								'</div>'+
								'<div data-role="content">'+
									'<div class="inset">'+
										'<h1>'+data.fullName+'</h1>'+
										'<ul data-nativedroid-plugin="cards" class="nativeDroidCards">'+
											'<li data-cards-type="text" >'+
												'<p><img src="'+data.pictureLink+'"/></p>'+
											'</li>'+
											'<li data-cards-type="text" >'+
												'<h1>Info</h1><hr>'+
												'<strong>Abkürzung: </strong>'+data.id+'<br/>'+
												'<strong>Adresse:</strong><br/>'+data.address+'<br/>'+
												'<p><br/>'+desc+'</p>'+
											'</li>'+
											'<li id="building_'+id+'_map" data-cards-type="traffic">'+
											//"<li data-cards-type='traffic' data-cards-traffic-route='{\"from\":\"0.00000,0.000000\",\"to\":\""+data.latLng.replace(/ /, '')+"\",\"type\" : \"geolocation\"}'>"+
												'<div class="map-canvas"></div><div class="mapcontainer"></div>'+
												'<a class="" href="maps:q='+data.address+'"><i class="icon-screenshot"></i>Navigation </a>'+
											'</li>'+
										'</ul>'+
										'<br/>'+
										'<p>'+
											'<h5>'+
												'<strong>'+
													'Letzte Änderung:'+
												'</strong> '+
												createDateTimeStamp(new Date(data.lastChange))+
											'</h5>'+
										'</p>'+
									'</div>'+
								'</div>';

					div = $(div);
					div.find("div[data-role='content'] a").addClass("external");
				
					$( "body" )
						.append(div)
						.trigger("create");
				
					$(".building_page").on("pageshow",function(){
						t = $(this)
						c = t.attr('data-destination').split(',');
						toLat = c[0];
						toLng = c[1];
						mapcontainer = t;
					
						initGmap();

						//alert("pageload");
					});
				
					$.mobile.initializePage();
					$.mobile.changePage("#building_"+id);
				
					loadingOut();
				})
				.fail(ajaxErrorHandler);
		}
	</script>
</div>

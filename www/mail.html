<div id="mail_page" data-role="page" data-dom-cache="true" data-title="Postfach" data-theme="a" data-content-theme="a">
	<div id="inbox" data-role="content" class="toblur">
		<ul id="mail_list" data-role="listview" data-inset="true">
		</ul>
	</div>
	<div id="reply" data-role="content" class="toblur">
		<form>
			<input type="email" data-clear-btn="false" name="email_to" id="email_to" value="" placeholder="EmpfÃ¤nger">
			<input type="text" name="email_subject" id="email_subject" value="" placeholder="Betreff">
			<textarea name="email_content" id="email_content" placeholder="Inhalt"></textarea>
		</form>
	</div>
	<div data-role="popup" id="mail_popupDialog" data-overlay-theme="b" data-theme="b" data-dismissible="false" style="max-width:400px;">
	    <div data-role="header" data-theme="a">
		    <h1>Wirklich senden?</h1>
	    </div>
	    <div role="main" class="ui-content">
		<h3 class="ui-title">Sind Sie sich sicher, dass Sie die Nachricht versenden wollen?</h3>
		<a href="#" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-b" data-rel="back">Abbrechen</a>
		<a href="#" id="btn_mail_really" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-b" data-transition="flow">Senden</a>
	    </div>
	</div>
	<footer id="mail_footer" data-role="footer" data-position="fixed" class="toblur">
		<div data-role="navbar">
            		<ul>
			<li><a id="btn_mail_write" href="#" data-role="button" data-icon="forward" data-mini="true" back="false">E-Mail schreiben ...</a></li>
			<li><a id="btn_mail_send" href="#" data-role="button" data-icon="mail" data-mini="true">Senden</a></li>
			</ul>
		</div>
	</footer>
	<script>
	
		$( "#mail_page" )
			.on("pagecreate", function(){
				initMailView();
				$("#reply").hide();
				$("#btn_mail_send").hide();
			})
			.on("pageshow", function() {
				if(!GLOBAL.INIT.mail) loadingIn();
				$("#btn_refresh")
					.off()
					.on("click", initMailView);
			 });

		$("#btn_mail_write").on("click", function(){
				if($(this).attr("back") == "false")
					showWrite();
				else
					showInbox();
			});

		$("#btn_mail_send").on("click", function(){
			if($("#email_to").val() != "" && $("#email_subject").val() != "")
				$("#mail_popupDialog").popup( "open", { positionTo: "window", transition: "pop" });
			else{
				loadingIn("Sie haben keine Adresse oder keinen Betreff eingegeben!", true);
				setTimeout(loadingOut, 3000);
			}
			});

		$("#btn_mail_really").on("click", function(){
			$("#mail_popupDialog").popup( "close");
			var mail = $("#email_to").val();
			var subject = $("#email_subject").val();
			var content = $("#email_content").val();
			loadingIn("Ihre Mail wird versendet...");
			$.post(CONFIG.SERVER.base+CONFIG.SERVER.mails+"?credentials="+GLOBAL.DEMO.credentials+"&salt="+GLOBAL.DEMO.salt+"&to="+mail+"&subject="+subject+"&message="+content)
				.done(function(data, status, jqXHR) {
					loadingOut();
					loadingIn("Ihre Mail wurde versendet", true);
					setTimeout(loadingOut, 3000);
					showInbox();
				});
			});

		function answer(){
			var help = $(this).parent();
			$("#email_to").val(help.attr("data-from"));
			$("#email_subject").val("Re: "+help.attr("data-subject"));
			showWrite();
			$("#btn_back").click();
		}

		function showInbox(){
			$("#email_to").val("");
			$("#email_subject").val("");
			$("#email_content").val("");
			$("#reply").hide();
			$("#inbox").show();
			$("#btn_mail_write").html("E-Mail schreiben ...").attr( "data-icon", "forward" ).attr("back", "false").addClass("ui-icon-forward").removeClass("ui-icon-back ui-btn-active");
			$("#btn_mail_send").hide();
		}

		function showWrite(){
			$("#inbox").hide();
			$("#reply").show();
			$("#btn_mail_write").html("Abbrechen").attr( "data-icon", "back" ).attr("back", "true").addClass("ui-icon-back").removeClass("ui-icon-forward ui-btn-active");
			$("#btn_mail_send").show();
		}

		function initMailView() {
			loadingIn();
			$.getJSON(CONFIG.SERVER.base+CONFIG.SERVER.mailg+"?credentials="+GLOBAL.DEMO.credentials+"&salt="+GLOBAL.DEMO.salt)
			 .done(function(data, status, jqXHR) {
					if(data.message != "message number < 1"){
					 	fillMailList(data);
						loadingOut();
					}else{
						loadingIn("Es konnten keine Mails abgerufen werden!", true);
						setTimeout(fetchMailsFail, 3000);
					}
				 	GLOBAL.INIT.mail = true;
			  });
			// TODO fail
		};

		function fetchMailsFail(){
			loadingOut();
			$( "#menu" ).panel( "open");
		}
		
		function fillMailList(data) {
			var mail, sdate = new Date(0);
			var lis = "";
			var divs = "";
			
			if(!isEmpty(data)){
				for(var k in data){
					mail = data[k];

					// Format: Thu Oct 09 14:54:21 <CEST,CET> 2008
					// CEST is Summer UTC +2h -> for reference see http://www.timeanddate.com/library/abbreviations/timezones/eu/cest.html
					// CET is Winter UTC +1h -> for reference see http://www.timeanddate.com/library/abbreviations/timezones/eu/cet.html
					mail.sendDate = new Date(mail.sendDate.replace(/CEST/, "+0200").replace(/CET/, "+0100"));
					
					lis += createMailEntry(mail, sdate);
					divs += createMailDetails(mail);
					
					sdate = mail.sendDate;
				}
				
				$( "#mail_list" )
					.empty()
					.append(lis)
					.find("li")
					.first().addClass("ui-first-child").end()
					.last().addClass("ui-last-child").end()
					.end()
					.trigger("create");
				
				$( "body" )
					.find("div.maildetails")
					.remove().end()
					.append(divs)
					.trigger("create");

				$("a.btn_mail_answer").on("click", answer);
			}
		};

		function createMailEntry(mail, sdate) {
			var li = "";
			var time = mail.sendDate.getHours()+":"+mail.sendDate.getMinutes();
			
			if(sdate.getTime()!=mail.sendDate.getTime()) {
				li += '<li data-role="list-divider" role="heading" class="ui-li-divider ui-bar-inherit ui-li-has-count">'+createDateStamp(mail.sendDate)+'</li>';
			}

			li += 	'<li><a href="#mail_'+mail.id+'" class="ui-btn ui-btn-icon-right ui-icon-carat-r" rel="external">'+
					'<h2>'+escape(mail.from)+'</h2>'+
					'<p><strong>'+mail.subject+'</strong></p>'+
					'<p class="ui-li-aside">'+time+'<strong></strong></p>'+
					'</a></li>';
			
			return li;
		};
		
		function createMailDetails(mail) {
			var toList = "";
			var div = "";
			
			// TODO better?
			for(var i = 0; i < mail.toList.length; i++) {
				if(!isEmpty(mail.toList[i])) 
					toList += mail.toList[i]+", ";
			}

			toList = toList.slice(0, toList.lastIndexOf(",")).replace(/[;:]/g, "");
			
			div += '<div id="mail_'+mail.id+'" data-role="page" data-title="Mail" data-subpage="true" class="maildetails" data-theme="a" data-content-theme="a">'+
					'<div data-role="content" data-from="'+escape(mail.from)+'" data-subject="'+escape(mail.subject)+'">'+
						'<p><strong>Von: </strong>'+escape(mail.from)+'</br>'+
						'<strong>An: </strong>'+escape(toList)+'</br>'+
						'<strong>Betreff: </strong>'+escape(mail.subject)+'</br>'+
						'</p><hr>'+escape(mail.message)+
						'<a href="#" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-b btn_mail_answer" data-icon="forward">Antworten</a>'+
					'</div>'+
				'</div>';

			//div = $(div);
			//div.find("a").addClass("external");

			return div;
		};
		
		/*function createNewMailHeader(item, last) {
			var sendDate = getDateFromString(item.sendDate)
			var sendDateFormatted = formatDate(sendDate);
			var pattern = "";

			if (currentDate == "") {
				pattern = '<li data-role="list-divider" role="heading" class="ui-li-divider ui-bar-inherit ui-li-has-count ui-first-child">'+sendDateFormatted+'</li>';
			} else if(sendDateFormatted != currentDate) {
				pattern = '<li data-role="list-divider" role="heading" class="ui-li-divider ui-bar-inherit ui-li-has-count">'+sendDateFormatted+'</li>';
			}
			$( '#mail_set' ).append(pattern).trigger("create");
			currentDate = sendDateFormatted;

			var time = sendDate.getHours()+':'+sendDate.getMinutes();
			var mailHeader = "";
			if (last == 1) {
				mailHeader = '<li class="ui-last-child">';
			} else {
				mailHeader = '<li>';
			}
			mailHeader = mailHeader + '<a href="#mail_'+item.id+'" class="ui-btn ui-btn-icon-right ui-icon-carat-r" rel="external">'+
				'<h2>'+item.from+'</h2>'+
				'<p><strong>'+item.subject+'</strong></p>'+
				'<p class="ui-li-aside">'+time+'<strong></strong></p>'+
				'</a></li>';
			$('#mail_set').append(mailHeader).trigger("create");

			var toList = "";
			for (var i = 0; i < item.toList.length; i++) {
				toList += ', '+item.toList[i];
			};

			pattern = 
					'<div data-role="page" class="newpage" id="mail_'+item.id+' data-title="back" data-theme="a" data-content-theme="a">'+
						'<div data-role="content" id="mail_content">'+
							'<p><strong>Von: </strong>'+item.from+'<br>'+
							'<strong>An: </strong>'+toList+'<br>'
							'<strong>Betreff: </strong>'+item.subject+'<br>'+
							'</p><hr>'+item.message+
						'</div>'+
					'</div>';
				$("body").append(pattern).trigger("create");
		}*/

		/*function getDateFromString(dateString) {
			//	Thu Oct 09 14:54:21 CEST 2008
			var dateParts = dateString.split(" ");
			var cDate = new Date(''+dateParts[1]+' '+dateParts[2]+', '+dateParts[5]+' '+dateParts[3]);
			return cDate;
		}*/
	</script>
</div>

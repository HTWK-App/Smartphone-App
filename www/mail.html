<div id="mail_page" data-role="page" data-dom-cache="true" data-title="Postfach" data-theme="a" data-content-theme="a">
	<div data-role="content" class="toblur">
		<ul id="mail_list" data-role="listview" data-inset="true">
		<! -- TODO remove, just demo -->	
		<li data-role="list-divider">Friday, October 8, 2010 <span class="ui-li-count">2</span></li>
			<li><a href="#">
				<h2>Stephen Weber</h2>
				<p><strong>You've been invited to a meeting at Filament Group in Boston, MA</strong></p>
				<p>Hey Stephen, if you're available at 10am tomorrow, we've got a meeting with the jQuery team.</p>
				<p class="ui-li-aside"><strong>6:24</strong>PM</p>
			</a></li>
			<li><a href="#">
				<h2>jQuery Team</h2>
				<p><strong>Boston Conference Planning</strong></p>
				<p>In preparation for the upcoming conference in Boston, we need to start gathering a list of sponsors and speakers.</p>
				<p class="ui-li-aside"><strong>9:18</strong>AM</p>
			</a></li>
			<li data-role="list-divider">Thursday, October 7, 2010 <span class="ui-li-count">1</span></li>
			<li><a href="#">
				<h2>Avery Walker</h2>
				<p><strong>Re: Dinner Tonight</strong></p>
				<p>Sure, let's plan on meeting at Highland Kitchen at 8:00 tonight. Can't wait! </p>
				<p class="ui-li-aside"><strong>4:48</strong>PM</p>
			</a></li>
		</ul>
	</div>

	<script>
		//var currentDate = "";
	
		/*$( document )
			.on("pagecreate", "#mail", initMailView)
			.on("pageshow", "#mail", function() {
				//loadingIn();
				//$("#qispage").detach();
			 });*/
		/*.on( "pagecreate", '[id="mail"]', function() {
			$("#mail_set").empty();
			fillMailView();
		});*/
	
		$( "#mail_page" )
			.on("pagecreate", initMailView)
			.on("pageshow", function() {
				if(!GLOBAL.INIT.mail) loadingIn();
				$("#btn_refresh")
					.off()
					.on("click", initMailView);
			 });

		function initMailView() {
			loadingIn();
			$.getJSON(CONFIG.SERVER.base+CONFIG.SERVER.mailg+"?credentials="+GLOBAL.DEMO.credentials+"&salt="+GLOBAL.DEMO.salt)
			 .done(function(data, status, jqXHR) {
				 	fillMailList(data);
				 	loadingOut();
				 	GLOBAL.INIT.mail = true;
			  });
			// TODO fail
			/*$.getJSON(SERVER_URL+'/mailbox/get?credentials='+CREDENTIALS+'&salt='+SALT).done(function(data) {
				var elements = data.length;
				var count = 1;
				$.each(data, function(key, item) {
					((count == elements) ? createNewMailHeader(item,1) : createNewMailHeader(item,0));
					count++;
				});
				$.mobile.loading('hide'); 
				showLoading = false;
			});*/
		};
		
		function fillMailList(data) {
			var mail, sdate = new Date(0);
			var lis = "";
			var divs = "";
			
			if(!isEmpty(data))
			{
				for(var k in data)
				{
					mail = data[k];

					// Format: Thu Oct 09 14:54:21 <CEST,CET> 2008
					// CEST is Summer UTC +2h -> for reference see http://www.timeanddate.com/library/abbreviations/timezones/eu/cest.html
					// CET is Winter UTC +1h -> for reference see http://www.timeanddate.com/library/abbreviations/timezones/eu/cet.html
					mail.sendDate = new Date(mail.sendDate.replace(/CEST/, "+0200").replace(/CET/, "+0100"));
					
					lis += createMailEntry(mail, sdate);
					divs += createMailDetails(mail);
					
					sdate = mail.sendDate;
				}
				
				$( "#mail_list" )
					.empty()
					.append(lis)
					.find("li")
					.first().addClass("ui-first-child").end()
					.last().addClass("ui-last-child").end()
					.end()
					/*.listview('refresh')
					.trigger('updatelayout');*/
					.trigger("create");
				
				$( "body" )
					.find("div.maildetails")
					.remove().end()
					.append(divs)
					.trigger("create");
			}
		};

		function createMailEntry(mail, sdate) {
			var li = "";
			var time = mail.sendDate.getHours()+":"+mail.sendDate.getMinutes();
			
			if(sdate.getTime()!=mail.sendDate.getTime()) {
				li += '<li data-role="list-divider" role="heading" class="ui-li-divider ui-bar-inherit ui-li-has-count">'+createDateStamp(mail.sendDate)+'</li>';
			}

			li += 	'<li><a href="#mail_'+mail.id+'" class="ui-btn ui-btn-icon-right ui-icon-carat-r" rel="external">'+
					'<h2>'+escape(mail.from)+'</h2>'+
					'<p><strong>'+mail.subject+'</strong></p>'+
					'<p class="ui-li-aside">'+time+'<strong></strong></p>'+
					'</a></li>';
			
			return li;
		};
		
		function createMailDetails(mail) {
			var toList = "";
			
			// TODO better?
			for(var i = 0; i < mail.toList.length; i++) {
				if(!isEmpty(mail.toList[i])) 
					toList += mail.toList[i]+", ";
			}

			toList = toList.slice(0, toList.lastIndexOf(",")).replace(/[;:]/g, "");
			
			return 	'<div id="mail_'+mail.id+'" data-role="page" data-title="Mail" data-subpage="true" class="maildetails" data-theme="a" data-content-theme="a">'+
						'<div data-role="content">'+
							'<p><strong>Von: </strong>'+escape(mail.from)+'</br>'+
							'<strong>An: </strong>'+escape(toList)+'</br>'+
							'<strong>Betreff: </strong>'+escape(mail.subject)+'</br>'+
							'</p><hr>'+escape(mail.message)+
						'</div>'+
					'</div>';
		};
		
		/*function createNewMailHeader(item, last) {
			var sendDate = getDateFromString(item.sendDate)
			var sendDateFormatted = formatDate(sendDate);
			var pattern = "";

			if (currentDate == "") {
				pattern = '<li data-role="list-divider" role="heading" class="ui-li-divider ui-bar-inherit ui-li-has-count ui-first-child">'+sendDateFormatted+'</li>';
			} else if(sendDateFormatted != currentDate) {
				pattern = '<li data-role="list-divider" role="heading" class="ui-li-divider ui-bar-inherit ui-li-has-count">'+sendDateFormatted+'</li>';
			}
			$( '#mail_set' ).append(pattern).trigger("create");
			currentDate = sendDateFormatted;

			var time = sendDate.getHours()+':'+sendDate.getMinutes();
			var mailHeader = "";
			if (last == 1) {
				mailHeader = '<li class="ui-last-child">';
			} else {
				mailHeader = '<li>';
			}
			mailHeader = mailHeader + '<a href="#mail_'+item.id+'" class="ui-btn ui-btn-icon-right ui-icon-carat-r" rel="external">'+
				'<h2>'+item.from+'</h2>'+
				'<p><strong>'+item.subject+'</strong></p>'+
				'<p class="ui-li-aside">'+time+'<strong></strong></p>'+
				'</a></li>';
			$('#mail_set').append(mailHeader).trigger("create");

			var toList = "";
			for (var i = 0; i < item.toList.length; i++) {
				toList += ', '+item.toList[i];
			};

			pattern = 
					'<div data-role="page" class="newpage" id="mail_'+item.id+' data-title="back" data-theme="a" data-content-theme="a">'+
						'<div data-role="content" id="mail_content">'+
							'<p><strong>Von: </strong>'+item.from+'<br>'+
							'<strong>An: </strong>'+toList+'<br>'
							'<strong>Betreff: </strong>'+item.subject+'<br>'+
							'</p><hr>'+item.message+
						'</div>'+
					'</div>';
				$("body").append(pattern).trigger("create");
		}*/

		/*function getDateFromString(dateString) {
			//	Thu Oct 09 14:54:21 CEST 2008
			var dateParts = dateString.split(" ");
			var cDate = new Date(''+dateParts[1]+' '+dateParts[2]+', '+dateParts[5]+' '+dateParts[3]);
			return cDate;
		}*/
	</script>
</div>
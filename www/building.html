<div id="building_page" data-role="page" data-dom-cache="true" data-title="Gebäude" data-theme="a" data-content-theme="a">
	<div data-role="content" class="toblur">
		<ul data-role="listview" id="buidling_content_list" data-filter-placeholder="Suche Gebäude..." data-filter="true" data-inset="true"></ul>
	</div>

	<script>
	
    	$( "#building_page" )
    		.on("pagecreate", initBuildingsView)
    		.on("pageshow", function() {
    			if(!GLOBAL.INIT.builds) loadingIn();
    			$("#btn_refresh")
					.off()
					.on("click", initBuildingsView);
    		 });

		function initBuildingsView() {
			loadingIn();
			$.getJSON(CONFIG.SERVER.base+CONFIG.SERVER.builds)
			 .done(function(data, status, jqXHR) {
				fillBuildingsList(data);
				loadingOut();
				GLOBAL.INIT.builds = true;
			});
			// TODO fail
		};
		
		function fillBuildingsList(data) {
			var building, lis = "", desc = "";
			
			if(!isEmpty(data))
			{				
				for(var k in data)
				{
					building = data[k];
					
					// TODO better?
					for(var d in building.description)
					{
						if(!isEmpty(building.description[d]))
							desc += building.description[d];
					}
					
					lis += 	'<li data-bid='+building.id+'><a href="#" class="building">'+
								'<h3>'+building.fullName+'</h3>'+
								'<p>'+desc+'</p>'+
								'<p>'+building.address+'</p>'+
							'</a></li>';
				}
				
				$( "#buidling_content_list" )
					.off()
					.empty()
					.append(lis)
					.on("click", "a.building", loadBuildingDetails)
					.listview("refresh")
					.trigger("updatelayout");
				
				$( "body" )
					.find("div.buildingdetails")
					.remove();
			}
		};
		
		function loadBuildingDetails(e) {
			var id = $(e.target).parents("li").first().data("bid");

			if($("#building_"+id).length>0) {
				$.mobile.initializePage();
				$.mobile.changePage("#building_"+id);
				return;
			}
			
			loadingIn();
			
			$.getJSON(CONFIG.SERVER.base+CONFIG.SERVER.builds+"/"+id)
			 .done(function(data, status, jqXHR) {
				var desc = "";
				
				// TODO better?
				for(var d in data.description)
				{
					if(!isEmpty(data.description[d]))
						desc += data.description[d] + "</br>";
				}
				
				var div =	'<div id="building_'+id+'" data-role="page" data-title="Gebäude" data-subpage="true" class="buildingdetails" data-theme="a" data-content-theme="a">'+
								'<div data-role="content">'+
									'<h1>'+data.fullName+'<img src="'+data.pictureLink+'" style="float:right;"/></h1>'+
									'<p><b>Abkürzung:</b> '+data.id+'</p>'+
									'<p><b>Beschreibung:</b> '+desc+'<hr></p>'+
									'<p><b>Adresse:</b> '+data.address+'</p>'+
									//'<p><iframe src="http://maps.google.de/maps?hl=de&q='+data.latLng.replace(/ /, '')+'&ie=UTF8&t=&z=16&iwloc=B&output=embed" width="90%" height="500" name="GoogleMaps"></iframe></p>'+
									'<p><iframe src="http://maps.google.de/maps?hl=de&q='+data.latLng.replace(/ /, '')+'&ie=UTF8&z=16&output=embed" width="90%" height="500" name="GoogleMaps"></iframe></p>'+
									'<p><small><b>Letzte Änderung:</b> '+createDateTimeStamp(new Date(data.lastChange))+'</small></p>'+
								'</div>'+
							'</div>';

				div = $(div);
				div.find("a").addClass("external");
				
				$( "body" )
					.append(div)
					.trigger("create");
				
				$.mobile.initializePage();
				$.mobile.changePage("#building_"+id);
				
				loadingOut();
			  });
			// TODO fail
		};
	</script>
</div>

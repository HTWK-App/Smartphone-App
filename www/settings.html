<div id="settings_page" data-role="page" data-title="Einstellungen" data-theme="a" data-content-theme="a">
	<div data-role="content" class="toblur">
		<h3>Sprache</h3>
		<hr>
		<label for="default_language_select"><strong>Standardsprache:</strong></label>
		<select id="default_language_select" name="default_language_select" data-mini="true">
			<option selected="selected" value="de_DE">Deutsch</option>
			<option value="en_EN">English</option>
		</select>
		<h3>Login-Daten</h3>
		<hr>
		<label for="username"><strong>Nutzername:</strong></label>
		<input type="text" name="username" id="username" value="" placeholder="Nutzername">
		<label for="password"><strong>Passwort:</strong></label>
		<input type="password" name="password" id="password" value="" autocomplete="off" placeholder="******">
		<br><a id="save"data-role="button" data-mini="true" >Speichern</a>
		<h3>Fakultät</h3>
		<hr>
		<form>
		    <input type="checkbox" name="prof_checkbox" id="prof_checkbox" data-mini="true" >
		    <label for="prof_checkbox">Ich bin Professor</label>
		</form>
		<label for="default_fac_select"><strong>Ihre Fakultät</strong>:</label>
		<select id="default_fac_select" name="default_fac_select" data-mini="true">
			<option selected="selected">Liste der verfügbaren Fakultäten wird geladen...</option>
			<option>abc</option>
		</select>
		<label for="default_mat_select"><strong>Ihr Matrikel</strong>:</label>
		<select id="default_mat_select" name="default_mat_select" data-mini="true" disabled="true">
			<option selected="selected">Matrikel</option>
		</select>
		<h3>News</h3>
		<hr>
		<label for="default_news_select"><strong>Standard Newsfeed</strong>:</label>
		<select id="default_news_select" name="default_news_select" data-mini="true">
			<option selected="selected">Liste der verfügbaren News-Feeds wird geladen...</option>
		</select>
		<h3>Mensa</h3>
		<hr>
		<label for="default_canteen_select"><strong>Standard Mensa:</strong></label>
		<select id="default_canteen_select" name="default_canteen_select" data-mini="true">
			<option selected="selected">Liste der verfügbaren Mensen wird geladen...</option>
		</select>
	</div>

	<script>
		//TODO autofill languages
		$( "#settings_page" )
			.on("pagecreate", function () {
				getNewsFeeds(); 
				getCanteens();
			})
			.on("pageshow", function () {
				if(!GLOBAL.INIT.settings) loadingIn();
				$("#btn_refresh").hide();
				GLOBAL.INIT.settings = true;
			 })
			.on("pagehide", function() {
				$("#btn_refresh").show();
			 });

		function getNewsFeeds() {

			$.getJSON(CONFIG.SERVER.base+CONFIG.SERVER.news)
			 .done(function(data, status, jqXHR) {
					var tmp, name, id, opts;

					opts = "";
					
					for(var k in data)
					{
						id = data[k].id;
						tmp = id.split(".");
						name = capitalize(tmp[1])+(tmp.length==3?" "+tmp[2]:"");
						if(id == CONFIG.NEWS.defaultFeed)
							tmp = 'selected="selected"';
						else 
							tmp = "";
						opts += '<option value="'+id+'" '+tmp+'>'+name+'</option>'; 
					}	
					
					$( "#default_news_select" )
						.empty()
						.append(opts)
						.selectmenu("refresh");
					
					loadingOut();
			 });
		};

		function getCanteens() {

			$.getJSON(CONFIG.SERVER.base+CONFIG.SERVER.mensa)
			 	.done(function(data, status, jqXHR) {
			 		var opts = "";
			 		
			 		for(var k in data.location)
			 		{	
			 			opts += '<option value="'+k+'" ';
			 			
			 			if(k == CONFIG.MENSA.defaultCanteen.id)
			 				opts += 'selected="selected"';
			 			
			 			opts += '>'+data.location[k]+'</option>';
			 		}

			 		$( "#default_canteen_select" )
						.empty()
			 			.append(opts)
			 			.selectmenu("refresh");
			   });
		};

		$( "#default_language_select")
			.change(function() {
				CONFIG.LANGUAGE.set = $(this).val();
				localStorage.setItem("language", CONFIG.LANGUAGE.set);
			});

		$( "#default_news_select" )
			.change(function() {
				CONFIG.NEWS.defaultFeed = $(this).val();
				localStorage.setItem("defaultFeed", CONFIG.NEWS.defaultFeed);
			});

		$( "#default_canteen_select" )
			.on("change", function() {
				CONFIG.MENSA.defaultCanteen.id = $(this).val();
				CONFIG.MENSA.defaultCanteen.name = $(this).innerHTML; //TODO Correct it....resolves in "undefined"
				localStorage.setItem("defaultCanteen", CONFIG.MENSA.defaultCanteen.name);
				localStorage.setItem("defaultCanteenID", CONFIG.MENSA.defaultCanteen.id);
				alert(""+localStorage.getItem("defaultCanteen")+"\n"+localStorage.getItem("defaultCanteenID"));
			});

		$( "#prof_checkbox")
			.on("change", function() {
				CONFIG.FACULTY.prof = !CONFIG.FACULTY.prof;
				localStorage.setItem("prof", CONFIG.FACULTY.prof);
				if(CONFIG.FACULTY.prof == true){
					$("#default_mat_select").selectmenu( "disable" ).selectmenu("refresh");
					localStorage.removeItem("matrikel");
				}else{
					$("#default_mat_select").selectmenu( "enable" ).selectmenu("refresh");
					//TODO reset matrikel
				}
		});

		$("#default_fac_select")
			.on("change", function () {
				if(!$("#prof_checkbox").prop("checked")){
					$("#default_mat_select").selectmenu( "enable" ).selectmenu("refresh");
					CONFIG.FACULTY.name = $(this).innerHTML;
					localStorage.setItem("facultyName", CONFIG.FACULTY.name);
				}
			});
		
		$("#save")
			.on("click", function () {
				$.mobile.loading( "show", {
				  text: "Ihre Einstellungen werden gespeichert",
				  textVisible: true,
				  theme: "b"
				});
				GLOBAL.DEMO.username = $("#username").val();
				GLOBAL.DEMO.password = $("#password").val();
				localStorage.setItem("username", GLOBAL.DEMO.username);
				localStorage.setItem("password", GLOBAL.DEMO.password);
				$.post(CONFIG.SERVER.base+CONFIG.SERVER.auth+"?username="+GLOBAL.DEMO.username+"&password="+GLOBAL.DEMO.password)
				.done(function(data, status, jqXHR) {
					GLOBAL.DEMO.credentials = data.encryptedCredentials;
					GLOBAL.DEMO.salt = data.salt;
					localStorage.setItem("credentials", GLOBAL.DEMO.credentials);
					localStorage.setItem("salt", GLOBAL.DEMO.salt);
					loadingOut();
				});
			});
	</script>
</div>

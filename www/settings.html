<div id="settings_page" data-role="page" data-title="Einstellungen" data-theme='b'>
    <!--- HEADER --->
    <div data-role="header" data-position="fixed" data-theme='b' class="header toblur">
    	<a data-role="button" data-iconpos='left' class="btn_menu"><span class="icon-ellipsis-vertical"></span></a>
    	<h1>HTWK App</h1>
    </div>
    <!--- HEADER --->
    
	<div data-role="content"  class="toblur">
		<div class='inset'>
			<h1>Einstellungen</h1>
			<br/>
			<h2>Login-Daten</h2>
			<br/>
			<div class='inset'>
				<label for="input_username"><strong>Nutzername:</strong></label>
				<input type="text" name="input_username" id="input_username" value="" placeholder="Nutzername"/>
				<label for="input_password"><strong>Passwort:</strong></label>
				<input type="password" name="input_password" id="input_password" value="" autocomplete="off" placeholder="******"/>
				<br>
				<a id="settings_login_save"data-role="button" data-mini="true">Speichern</a>
			</div>
			<hr/>
			<!--<h2>Sprache</h2>
			<br/>
			<div class='inset'>
				<label for="default_language_select"><strong>Standardsprache:</strong></label>
				<select id="default_language_select" data-native-menu="true" name="default_language_select"></select>
			</div>
			<hr/>-->
			<h2>News</h2>
			<br/>
			<div class='inset'>
				<label for="default_news_select"><strong>Standard Newsfeed:</strong></label>
				<select id="default_news_select" name="default_news_select">
					<option selected="selected">Liste der verfügbaren News-Feeds wird geladen...</option>
				</select>
			</div>
			<hr/>
			<h2>Stundenplan</h2>
			<br/>
			<div class='inset'>
				<a href="#popup_timetable_delete" data-role="button" data-mini="true" data-rel="popup" data-position-to="window" data-transition="pop">Stundenplan löschen...</a>
			</div>
			<hr/>
			<h2>Mensa</h2>
			<br/>
			<div class='inset'>
				<label for="default_canteen_select"><strong>Standard Mensa:</strong></label>
				<select id="default_canteen_select" name="default_canteen_select" data-mini="true">
					<option selected="selected">Liste der verfügbaren Mensen wird geladen...</option>
				</select>
			</div>
			<br/>
		</div>
	</div>
	<div id="popup_timetable_delete" data-role="popup" data-theme="b">
		<div data-role="header" data-theme="b">
			<h3>Wirklich Löschen?</h3>
		</div>
		<div role="main" class="ui-content" data-theme="b">
			<h4>Wollen Sie wirklich ihre gemachten Einstellung bezüglich des Stundenplans löschen?</h4>
			<p>Diese Aktion kann nicht rückgängig gemacht werden!</p><br>
			<a href="#" data-role="button" data-icon="back" data-mini="true" data-rel="back" data-inline="true" class="ui-corner-all ui-shadow">Abbrechen</a>
			<a id="settings_timetable_delete" href="#" data-role="button" data-icon="check" data-mini="true" data-rel="back" data-inline="true" data-transition="flow" class="ui-corner-all ui-shadow">Löschen</a>
		</div>
	</div>

	<script>

		/*TODO
		 * There are two requests send to the server --> loadingOut has to be called, when both of them are finished.
		 * Functions GetNewsFeeds and GetCanteens are the same functions, used in Mensa and News. --> Refactoring, so that it is not copy and pasted
		 */
		$( "#settings_page" )
			.on("pagecreate", function () {
				settingsGetNewsFeeds(); 
				settingsGetCanteens();
				settingsFillFields();
			})
			.on("pageshow", function () {
				$("#btn_refresh").hide();
			 })
			.on("pagehide", function() {
				$("#btn_refresh").show();
			 });

		/**
		 * Get all Newsfeeds from the Server and fill them into the select widget. Default Feed will be selected.
		 *
		 */
		function settingsGetNewsFeeds() {
			
			loadingIn();

			$.getJSON(CONFIG.SERVER.base+CONFIG.SERVER.news)
				 .done(function(data, status, jqXHR) {
					if(!isEmpty(data.exception))
						{ ajaxErrorHandler(data, status, jqXHR); return; }

					var tmp, name, id, opts;
					opts = "";
				
					for(var k in data){
						id = data[k].id;
						tmp = id.split(".");
						name = capitalize(tmp[1])+(tmp.length==3?" "+tmp[2]:"");

						if(id == CONFIG.NEWS.defaultFeed)
							tmp = 'selected="selected"';
						else
							tmp = "";
						opts += '<option value="'+id+'" '+tmp+'>'+GLOBAL.NEWS.titles[id]+'</option>'; 
					}
				
					$( "#default_news_select" )
						.empty()
						.append(opts)
						.selectmenu("refresh");
					loadingOut();
				 })
				.fail(ajaxErrorHandler);
		};

		/**
		 * Get all Canteens from the Server and fill them into the select widget. Default Canteen will be selected.
		 *
		 */
		function settingsGetCanteens() {

			$.getJSON(CONFIG.SERVER.base+CONFIG.SERVER.mensa)
				 .done(function(data, status, jqXHR) {
					if(!isEmpty(data.exception))
						{ ajaxErrorHandler(data, status, jqXHR); return; }

			 		var opts = "";
			 		
			 		for(var k in data.location){	
			 			opts += '<option value="'+k+'" ';
			 			
			 			if(k == CONFIG.MENSA.defaultCanteen)
			 				opts += 'selected="selected"';
			 			
			 			opts += '>'+data.location[k]+'</option>';
			 		}

			 		$( "#default_canteen_select" )
						.empty()
			 			.append(opts)
			 			.selectmenu("refresh");
				})
				.fail(ajaxErrorHandler);
		};

		/**
		 * Fill existing widgets with data, if present. To be filled: Username textbox, Language select
		 *
		 */
		function settingsFillFields(){

			var opts = "";

			if(CONFIG.AUTH.username != undefined && CONFIG.AUTH.username != ""){
				$("#input_username")
					.attr("placeholder", CONFIG.AUTH.username)
					.val(CONFIG.AUTH.username);
			}
			/*
			for(var k in CONFIG.LANGUAGE.availableShort){
	 			opts += '<option value="'+CONFIG.LANGUAGE.availableShort[k]+'" ';

	 			if(CONFIG.LANGUAGE.availableShort[k] == CONFIG.LANGUAGE.set)
	 				opts += 'selected="selected"';

	 			opts += '>'+CONFIG.LANGUAGE.availableLong[k]+'</option>';
	 		}

	 		$( "#default_language_select" )
				.empty()
	 			.append(opts)
	 			.selectmenu("refresh");
			*/
		};
/*
		$( "#default_language_select")
			.change(function() {
				CONFIG.LANGUAGE.set = $(this).val();
				saveParameters();
			});
*/
		$("#settings_login_save")
			.on("click", function () {
				var pass = $("#input_password").val();
				var user = $("#input_username").val();

				if(pass == "" || user == ""){
					loadingIn("Tragen Sie bitte Ihren Nutzernamen und ihr Passwort ein!", true);
					setTimeout(loadingOut, 2500);
				}else{
					saveUsernamePassword(user,pass);
				}
			});

		$( "#default_news_select" )
			.change(function() {
				CONFIG.NEWS.defaultFeed = $(this).val();
				saveParameters();
			});

		$( "#settings_timetable_delete" )
			.on("click", function() {
				CONFIG.TIMETABLE.faculty = [];
				CONFIG.TIMETABLE.temporary = [];
				saveParameters();
				
			});

		$( "#default_canteen_select" )
			.on("change", function() {
				CONFIG.MENSA.defaultCanteen = $(this).val();
				saveParameters();
			});
	</script>
</div>

<div id="settings_page" data-role="page" data-title="Einstellungen" data-theme='b'>

  <div data-role="header" data-position="fixed" data-theme='b' data-tap-toggle="false" class="header">
		<a href="#" class="ui-btn-left ui-btn ui-btn-inline ui-mini ui-corner-all btn_menu"><i class="fa fa-bars fa-lg"></i></a>
		<h1>HTWK App</h1>
	</div>

	<div role="main" class="ui-content">
		<h2>Login-Daten</h2>
		<label for="input_username"><strong>Nutzername:</strong></label> 
			<input type="text" name="input_username" id="input_username" value="" placeholder="Nutzername" /> 
		<label for="input_password"><strong>Passwort:</strong> </label>
			<input type="password" name="input_password" id="input_password" value="" autocomplete="off" placeholder="Passwort" /> 
		<br> 
		<a id="settings_login_save" class="ui-btn ui-corner-all ui-shadow ui-btn-b">Speichern</a>
		<br />
		<hr />
		<h2>PushNotifications</h2>
		<br />
		<label for="enable_pushNotifications"><strong> Enable:</strong>
			<input type="checkbox" name="enable_pushNotifications" id="enable_pushNotifications"/> 
		</label> 
		<div id="app-status-div">
			<div id="app-status"></div>
			<ul id="app-status-ul" style="">
				<li></li>
			</ul>
		</div>
		<hr /> 
		<!--<h2>Sprache</h2>
		<br/>
		<label for="default_language_select"><strong>Standardsprache:</strong></label>
		<select id="default_language_select" data-native-menu="true" name="default_language_select"></select>
		<hr/>-->
		<h2>News</h2>
		<label for="default_news_select"><strong>Standard Newsfeed:</strong></label>
		<select id="default_news_select" name="default_news_select">
			<option selected="selected">Liste der verfügbaren News-Feeds wird geladen...</option>
		</select>
		<br />
		<hr />
		<h2>Stundenplan</h2>
		<a href="#popup_timetable_delete" data-rel="popup" data-position-to="window" class="ui-btn ui-corner-all ui-shadow ui-btn-b">Stundenplan löschen...</a>
		<br />
		<hr />
		<h2>Mensa</h2>
		<label for="default_canteen_select"><strong>Standard Mensa:</strong></label>
		<select id="default_canteen_select" name="default_canteen_select">
			<option selected="selected">Liste der verfügbaren Mensen wird geladen...</option>
		</select>
		<br />
	</div>

	<div id="popup_timetable_delete" data-role="popup" data-theme="a" data-overlay-theme="a" data-transition="pop" class="ui-corner-all">
		<div data-role="header">
			<h3>Wirklich Löschen?</h3>
		</div>
		<div role="main" class="ui-content">
			<h4>Wollen Sie wirklich ihre gemachten Einstellung bezüglich des Stundenplans löschen?</h4>
			<p>Diese Aktion kann nicht rückgängig gemacht werden!</p>
			<br> 
			<a id="settings_timetable_delete" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-a ui-btn-icon-left ui-icon-check">Löschen</a>
			<a data-rel="back" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-a ui-btn-icon-left ui-icon-back">Abbrechen</a>
		</div>
	</div>

	<script>
		/*TODO
		 * There are two requests send to the server --> loadingOut has to be called, when both of them are finished.
		 * Functions GetNewsFeeds and GetCanteens are the same functions, used in Mensa and News. --> Refactoring, so that it is not copy and pasted
		 */
		$("#settings_page").on("pagecreate", function() {
			settingsGetNewsFeeds();
			settingsGetCanteens();
			settingsFillFields();
		});

		/**
		 * Get all Newsfeeds from the Server and fill them into the select widget. Default Feed will be selected.
		 *
		 */
		function settingsGetNewsFeeds() {
			analytics.trackView('settings');
			loadingIn();

			$.getJSON(CONFIG.SERVER.base + CONFIG.SERVER.news).done(
					function(data, status, jqXHR) {
						if (!isEmpty(data.exception)) {
							ajaxErrorHandler(data, status, jqXHR);
							return;
						}

						var tmp, name, id, opts;
						opts = "";

						for ( var k in data) {
							id = data[k].id;
							tmp = id.split(".");
							name = capitalize(tmp[1])
									+ (tmp.length == 3 ? " " + tmp[2] : "");

							if (id == CONFIG.NEWS.defaultFeed)
								tmp = 'selected="selected"';
							else
								tmp = "";
							opts += '<option value="'+id+'" '+tmp+'>'
									+ GLOBAL.NEWS.titles[id] + '</option>';
						}

						$("#default_news_select").empty().append(opts)
								.selectmenu("refresh");
						loadingOut();
					}).fail(ajaxErrorHandler);
		};

		/**
		 * Get all Canteens from the Server and fill them into the select widget. Default Canteen will be selected.
		 *
		 */
		function settingsGetCanteens() {

			$.getJSON(CONFIG.SERVER.base + CONFIG.SERVER.mensa).done(
					function(data, status, jqXHR) {
						if (!isEmpty(data.exception)) {
							ajaxErrorHandler(data, status, jqXHR);
							return;
						}

						var opts = "";

						for ( var k in data.location) {
							opts += '<option value="' + k + '" ';

							if (k == CONFIG.MENSA.defaultCanteen)
								opts += 'selected="selected"';

							opts += '>' + data.location[k] + '</option>';
						}

						$("#default_canteen_select").empty().append(opts)
								.selectmenu("refresh");
					}).fail(ajaxErrorHandler);
		};

		/**
		 * Fill existing widgets with data, if present. To be filled: Username textbox, Language select
		 *
		 */
		function settingsFillFields() {

			var opts = "";

			if (CONFIG.AUTH.username != undefined && CONFIG.AUTH.username != "") {
				$("#input_username").attr("placeholder", CONFIG.AUTH.username)
						.val(CONFIG.AUTH.username);
			}
			/*
			for(var k in CONFIG.LANGUAGE.availableShort){
				opts += '<option value="'+CONFIG.LANGUAGE.availableShort[k]+'" ';

				if(CONFIG.LANGUAGE.availableShort[k] == CONFIG.LANGUAGE.set)
					opts += 'selected="selected"';

				opts += '>'+CONFIG.LANGUAGE.availableLong[k]+'</option>';
			}

			$( "#default_language_select" )
				.empty()
				.append(opts)
				.selectmenu("refresh");
			 */
		};
		/*
		 $( "#default_language_select")
		 .change(function() {
		 CONFIG.LANGUAGE.set = $(this).val();
		 saveParameters();
		 });
		 */
		$("#settings_login_save")
				.on(
						"click",
						function() {
							var pass = $("#input_password").val();
							var user = $("#input_username").val();

							if (pass == "" || user == "") {
								loadingIn(
										"Tragen Sie bitte Ihren Nutzernamen und ihr Passwort ein!",
										true);
								setTimeout(loadingOut, 2500);
							} else {
								saveUsernamePassword(user, pass);
							}
						});

		$("#default_news_select").change(function() {
			CONFIG.NEWS.defaultFeed = $(this).val();
			saveParameters();
		});

		$("#settings_timetable_delete").on("click", function() {
			CONFIG.TIMETABLE.faculty = [];
			CONFIG.TIMETABLE.temporary = [];
			saveParameters();
			$("#popup_timetable_delete").popup("close");
			loadingIn("Ihr Stundenplan wurde gelöscht!", true);
			setTimeout(loadingOut, 2000);
		});

		$("#default_canteen_select").on("change", function() {
			CONFIG.MENSA.defaultCanteen = $(this).val();
			saveParameters();
		});

		$("#enable_pushNotifications").on("change", function(){
			checkPushStatus();
		});

		function checkPushStatus(){
			var isChecked =  $('#enable_pushNotifications').is(':checked');
			CONFIG.PUSH.enabled = isChecked;
			if (isChecked) {
				registerDevice();
  			} else {
 				unregisterDevice();
 			}
		}
		if (CONFIG.PUSH.enabled) {
			$('#enable_pushNotifications').prop('checked', true)
		}else{
			$('#enable_pushNotifications').prop('checked', false)
		}
	</script>
</div>

<div id="mail_page" data-dom-cache="true" data-title="Postfach" data-role="page" data-theme='b'>
	<div data-role="panel" id="menue_postfach" data-theme="a" data-display="push">
		<ul data-role="listview">
			<li data-role="list-divider">Hauptmenü</li>
			<li data-icon="fire"><a href="index.html" >Startseite</a></li>
			<li data-icon="fire"><a href="news.html" >News</a></li>
			<li data-icon="trophy"><a href="stundenplan.html" >Stundenplan</a></li>
			<li data-icon="trophy"><a href="mensa.html" >Mensa</a></li>
			<li data-icon="trophy"><a href="postfach.html" >Postfach</a></li>
			<li data-icon="trophy"><a href="qis.html" >QIS</a></li>
			<li data-icon="trophy"><a href="sport.html" >Hochschulsport</a></li>
			
		</ul>
		<!--<div data-role="collapsible"><h4>Info-Center</h4> -->
		<ul data-role="listview">
			<li data-role="list-divider">Info-Center</li>
			<li data-icon="trophy"><a href="info_allgemein.html" >Allgemein</a></li>
			<li data-icon="trophy"><a href="info_mitarbeiter.html" >Mitarbeiter</a></li>
			<li data-icon="trophy"><a href="info_gebaeudeplan.html" >Gebäudeplan</a></li>
			<li data-icon="trophy"><a href="info_wlan.html" >WLAN-Konfiguration</a></li>
		</ul>
		<!--</div> -->
		<ul data-role="listview">
			<li data-role="list-divider">Tools</li>
			<li data-icon="trophy"><a href="tools_leeren-raum.html" >Leeren Raum finden</a></li>
			<li data-icon="trophy"><a href="tools_buch.html" >Buchausleihe</a></li>
		</ul>
		<ul data-role="listview">
			<li data-role="list-divider">Einstellungen</li>
			<li data-icon="trophy"><a href="einstellungen_htwk-app.html" >HTWK-App</a></li>
		</ul>
	</div>
	<div data-role="header" data-position="fixed" data-tap-toggle="false" data-theme='b'>
		<a href="#menue_postfach" data-role='button' role="button" data-iconpos='left' data-inline='true'><i class="icon-ellipsis-vertical"></i>&nbsp;</a>
		<h1>&nbsp;HTWK App</h1>
	</div>
	<style>
		.ui-btn-icon-top {
			padding-top: 0.75em !important;
		}
	</style>
	<div id="mail_footer" data-role="footer" data-position="fixed" data-theme="b">
		<div data-role="navbar">
            <ul>
				<li><a id="btn_mail_write" href="#" data-icon="forward"  back="false">E-Mail schreiben ...</a></li>
				<li><a id="btn_mail_send" href="#" data-icon="mail" >Senden</a></li>
			</ul>
		</div>
	</div>
	<div data-role="content" >
		<div data-role="popup" id="mail_popupDialog" data-overlay-theme="b" data-theme="b" data-dismissible="false" style="max-width:400px;">
			<div data-role="header" data-theme="a">
				<h1>Wirklich senden?</h1>
			</div>
			<h3 class="ui-title">Sind Sie sich sicher, dass Sie die Nachricht versenden wollen?</h3>
			<a href="#" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-b" data-rel="back">Abbrechen</a>
			<a href="#" id="btn_mail_really" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-b" data-transition="flow">Senden</a>
		</div>
		<div id="reply" >
			<form>
				<input type="email" data-clear-btn="false" name="email_to" id="email_to" value="" placeholder="Empfänger">
				<input type="text" name="email_cc" id="email_cc" value="" placeholder="Kopie an">
				<input type="text" name="email_subject" id="email_subject" value="" placeholder="Betreff">
				<textarea name="email_content" id="email_content" placeholder="Ihr Text ..."></textarea>
			</form>
		</div>
		<div id="inbox" >
			<ul id="mail_list" data-role="listview" data-inset="true">
			</ul>
		</div>
	</div>
	
	<script>
	
		$( "#mail_page" )
			.on("pagecreate", function(){
				$("#reply")
					.hide();
				$("#btn_mail_send")
					.hide();
				initMailView();
			})
			.on("pageshow", function() {
				$("#btn_refresh")
					.off()
					.on("click", initMailView);
				if(isEmpty(CONFIG.AUTH.credentials)) {
	    				openSignInDialog(initMailView);
	    			}
				else {
	    				if(!GLOBAL.INIT.mail) loadingIn();	
	    			}
			 });

		$("#btn_mail_write").on("click", function(){
				if($(this).attr("back") == "false")
					showWrite();
				else
					showInbox();
			});

		$("#btn_mail_send").on("click", function(){
			if($("#email_to").val() != "" && $("#email_subject").val() != "")
				$("#mail_popupDialog").popup( "open", { positionTo: "window", transition: "pop" });
			else{
				loadingIn("Sie haben keine Adresse oder keinen Betreff eingegeben!", true);
				setTimeout(loadingOut, 3000);
			}
		});

		$("#btn_mail_really").on("click", function(){
			$("#mail_popupDialog").popup( "close");
			var mail = $("#email_to").val().replace(" ","").split(",");
			console.log(mail);
			var cc = $("#email_cc").val().replace(" ","").split(",");
			var subject = $("#email_subject").val();
			var content = $("#email_content").val();
			loadingIn("Ihre Mail wird versendet...");
			$.post(CONFIG.SERVER.base+CONFIG.SERVER.mails+"?credentials="+CONFIG.AUTH.credentials+"&salt="+CONFIG.AUTH.salt+"&to="+mail+"&cc="+cc+"&subject="+subject+"&message="+content)
				.done(function(data, status, jqXHR) {
					console.log(data);
					loadingOut();
					loadingIn("Ihre Mail wurde versendet", true);
					setTimeout(loadingOut, 3000);
					showInbox();
				});
			});

		function answer(){
			var help = $(this).parent().parent();
			var mail = help.attr("data-from");
			//Regex to filter the text for an valid mail adress
			mail = mail.match(/(?:[a-z0-9!#$%&'*+/=?^_`{|}~-]+(?:\.[a-z0-9!#$%&'*+/=?^_`{|}~-]+)*|"(?:[\x01-\x08\x0b\x0c\x0e-\x1f\x21\x23-\x5b\x5d-\x7f]|\\[\x01-\x09\x0b\x0c\x0e-\x7f])*")@(?:(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\.)+[a-z0-9](?:[a-z0-9-]*[a-z0-9])?|\[(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?|[a-z0-9-]*[a-z0-9]:(?:[\x01-\x08\x0b\x0c\x0e-\x1f\x21-\x5a\x53-\x7f]|\\[\x01-\x09\x0b\x0c\x0e-\x7f])+)\])/g);
			$("#email_to").val(mail);
			$("#email_subject").val("Re: "+help.attr("data-subject"));
			showWrite();
			//$("#btn_back").click();
			$.mobile.back();
		}

		function showInbox(){
			$("#btn_refresh").show();
			$("#email_to").val("");
			$("#email_cc").val("");
			$("#email_subject").val("");
			$("#email_content").val("");
			$("#reply").hide();
			$("#inbox").show();
			$("#btn_mail_write").html("E-Mail schreiben ...").attr( "data-icon", "forward" ).attr("back", "false").addClass("ui-icon-forward").removeClass("ui-icon-back ui-btn-active");
			$("#btn_mail_send").hide();
		}

		function showWrite(){
			$("#btn_refresh").hide();
			$("#inbox").hide();
			$("#reply").show();
			$("#btn_mail_write").html("Abbrechen").attr( "data-icon", "back" ).attr("back", "true").addClass("ui-icon-back").removeClass("ui-icon-forward ui-btn-active");
			$("#btn_mail_send").show();
		}

		function initMailView() {
			if(!isEmpty(CONFIG.AUTH.credentials))
			{
				loadingIn();
				$.getJSON(CONFIG.SERVER.base+CONFIG.SERVER.mailg+"?credentials="+CONFIG.AUTH.credentials+"&salt="+CONFIG.AUTH.salt)
				 .done(function(data, status, jqXHR) {
						if(data.message != "message number < 1"){
						 	fillMailList(data);
							loadingOut();
							GLOBAL.INIT.mail = true;
						}else{
							loadingIn("Es konnten keine Mails abgerufen werden!", true);
							setTimeout(fetchMailsFail, 3000);
						}
				  });
			}
			// TODO fail
		};

		function fetchMailsFail(){
			loadingOut();
			$( "#menu" ).panel( "open");
		}
		
		function fillMailList(data) {
			var mail, sdate = new Date(0);
			var lis = "";
			var divs = "";
			
			if(!isEmpty(data)){
				for(var k in data){
					mail = data[k];

					// Format: Thu Oct 09 14:54:21 <CEST,CET> 2008
					// CEST is Summer UTC +2h -> for reference see http://www.timeanddate.com/library/abbreviations/timezones/eu/cest.html
					// CET is Winter UTC +1h -> for reference see http://www.timeanddate.com/library/abbreviations/timezones/eu/cet.html
					mail.sendDate = new Date(mail.sendDate.replace(/CEST/, "+0200").replace(/CET/, "+0100"));
					
					lis += createMailEntry(mail, sdate);
					divs += createMailDetails(mail);
					
					sdate = mail.sendDate;
				}
				
				$( "#mail_list" )
					.empty()
					.append(lis)
					.find("li")
					.first().addClass("ui-first-child").end()
					.last().addClass("ui-last-child").end()
					.end()
					.trigger("create");
				
				$( "body" )
					.find("div.maildetails")
					.remove().end()
					.append(divs)
					.trigger("create");

				$("a.btn_mail_answer").on("click", answer);
			}
		};

		function createMailEntry(mail, sdate) {
			var li = "";
			var time = mail.sendDate.getHours()+":"+mail.sendDate.getMinutes();
			
			if(sdate.getTime()!=mail.sendDate.getTime()) {
				li += '<li data-role="list-divider" role="heading" class="ui-li-divider ui-bar-inherit ui-li-has-count">'+createDateStamp(mail.sendDate)+'</li>';
			}

			li += 	'<li><a href="#mail_'+mail.id+'" class="ui-btn ui-btn-icon-right ui-icon-carat-r" rel="external">'+
					'<h2>'+escape(mail.from)+'</h2>'+
					'<p><strong>'+mail.subject+'</strong></p>'+
					'<p class="ui-li-aside">'+time+'<strong></strong></p>'+
					'</a></li>';
			
			return li;
		};
		
		function createMailDetails(mail) {
			var toList = "";
			var div = "";
			
			// TODO better?
			for(var i = 0; i < mail.toList.length; i++) {
				if(!isEmpty(mail.toList[i])) 
					toList += mail.toList[i]+", ";
			}
			var tmp = document.createElement("DIV");
			tmp.innerHTML = mail.message;
			var message = tmp.textContent || tmp.innerText || "";

			toList = toList.slice(0, toList.lastIndexOf(",")).replace(/[;:]/g, "");
			
			div += '<div id="mail_'+mail.id+'" data-role="page" data-title="Mail" data-subpage="true" class="maildetails" data-theme="b" data-content-theme="b">'+
					'<div data-role="content" data-from="'+escape(mail.from)+'" data-subject="'+escape(mail.subject)+'">'+
							'<div data-role="header" data-position="fixed" data-theme="b">'+
								'<a href="#" data-rel="back" data-role="button" data-transition="slide" data-direction="reverse"><i class="icon-angle-left"></i></a>'+
								'<h1>&nbsp;HTWK App</h1>'+
							'</div>'+
						'<div class="inset">'+
						'<p><strong>Von: </strong>'+escape(mail.from)+'</br>'+
						'<strong>An: </strong>'+escape(toList)+'</br>'+
						'<strong>Betreff: </strong>'+escape(mail.subject)+'</br>'+
						'</p><hr/>'+message+
						'<hr/><a href="#" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-b btn_mail_answer" data-icon="forward">Antworten</a>'+
						'</div>'+
					'</div>'+
				'</div>';

			//div = $(div);
			//div.find("a").addClass("external");

			return div;
		};
	</script>
</div>
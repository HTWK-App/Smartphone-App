<div id="mail_page" data-dom-cache="true" data-title="Postfach" data-role="page" data-theme='b'>
	<div data-role="panel" id="menue_postfach" data-theme="a" data-display="push">
		<ul data-role="listview">
			<li data-role="list-divider">Hauptmen체</li>
			<li data-icon="fire"><a href="index.html" >Startseite</a></li>
			<li data-icon="fire"><a href="news.html" >News</a></li>
			<li data-icon="trophy"><a href="stundenplan.html" >Stundenplan</a></li>
			<li data-icon="trophy"><a href="mensa.html" >Mensa</a></li>
			<li data-icon="trophy"><a href="postfach.html" >Postfach</a></li>
			<li data-icon="trophy"><a href="qis.html" >QIS</a></li>
			<li data-icon="trophy"><a href="sport.html" >Hochschulsport</a></li>
			
		</ul>
		<!--<div data-role="collapsible"><h4>Info-Center</h4> -->
		<ul data-role="listview">
			<li data-role="list-divider">Info-Center</li>
			<li data-icon="trophy"><a href="info_allgemein.html" >Allgemein</a></li>
			<li data-icon="trophy"><a href="info_mitarbeiter.html" >Mitarbeiter</a></li>
			<li data-icon="trophy"><a href="info_gebaeudeplan.html" >Geb채udeplan</a></li>
			<li data-icon="trophy"><a href="info_wlan.html" >WLAN-Konfiguration</a></li>
		</ul>
		<!--</div> -->
		<ul data-role="listview">
			<li data-role="list-divider">Tools</li>
			<li data-icon="trophy"><a href="tools_leeren-raum.html" >Leeren Raum finden</a></li>
			<li data-icon="trophy"><a href="tools_buch.html" >Buchausleihe</a></li>
		</ul>
		<ul data-role="listview">
			<li data-role="list-divider">Einstellungen</li>
			<li data-icon="trophy"><a href="einstellungen_htwk-app.html" >HTWK-App</a></li>
		</ul>
	</div>
	<div data-role="header" data-position="fixed" data-tap-toggle="false" data-theme='b'>
		<a href="#menue_postfach" data-role='button' role="button" data-iconpos='left' data-inline='true'><i class="icon-ellipsis-vertical"></i>&nbsp;</a>
		<h1>&nbsp;HTWK App</h1>
	</div>
	<style>
		.ui-btn-icon-top {
			padding-top: 0.75em !important;
		}
	</style>
	<div data-role="content" >
		<div id="mail_inbox" data-role="content" class="toblur">
			<ul id="mail_list" data-role="listview" data-inset="true"></ul>
			<a data-role="button" id="mail_more" data-icon="arrow-d">Mehr</a>
		</div>
		<div id="mail_sendForm" data-role="content" class="toblur">
			<form>
				<input type="email" data-clear-btn="false" name="mail_new_to" id="mail_new_to" value="" placeholder="Empf채nger" />
				<input type="text" name="mail_new_cc" id="mail_new_cc" value="" placeholder="Kopie an" />
				<input type="text" name="mail_new_subject" id="mail_new_subject" value="" placeholder="Betreff" />
				<textarea name="mail_new_content" id="mail_new_content" placeholder="Inhalt"></textarea>
			</form>
		</div>
		<div data-role="popup" id="mail_popupDialog" data-overlay-theme="b" data-theme="b" data-dismissible="false">
		    <div data-role="header" data-theme="a">
			    <h1>Wirklich senden?</h1>
		    </div>
		    <div role="main" class="ui-content">
				<h3 class="ui-title">Sind Sie sich sicher, dass Sie die Nachricht versenden wollen?</h3>
				<a href="#" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-b" data-rel="back">Abbrechen</a>
				<a href="#" id="btn_mail_really" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-b" data-transition="flow">Senden</a>
		    </div>
		</div>
		<footer id="mail_footer" data-role="footer" data-position="fixed" class="toblur">
			<div data-role="navbar">
				<ul>
					<li><a id="btn_mail_abort" href="#" data-role="button" data-icon="back" data-mini="true">Abbrechen</a></li>
					<li><a id="btn_mail_write" href="#" data-role="button" data-icon="forward" data-mini="true">Neue Mail</a></li>
					<li><a id="btn_mail_send" href="#" data-role="button" data-icon="mail" data-mini="true">Senden</a></li>
				</ul>
			</div>
		</footer>
		<div id="mail_footer" data-role="footer" data-position="fixed" data-theme="b">
			<div data-role="navbar">
		    <ul>
					<li><a id="btn_mail_write" href="#" data-icon="forward"  back="false">E-Mail schreiben ...</a></li>
					<li><a id="btn_mail_send" href="#" data-icon="mail" >Senden</a></li>
				</ul>
			</div>
		</div>
	</div>
	
	<script>
		$( "#mail_page" )
			.on("pagecreate", function() {
				$("#mail_sendForm")
					.hide();
				$("#btn_mail_abort")
					.hide();				
				$("#btn_mail_send")
					.hide();
				initMailView(false);
			})
			.on("pageshow", function() {
				$("#btn_refresh")
					.off()
					.on("click", initMailView);
				if(isEmpty(CONFIG.AUTH.credentials)) {
	    			openSignInDialog(initMailView);
	    		}
				else {
	    			if(!GLOBAL.INIT.mail) loadingIn();	
	    		}
			 });

		$("#btn_mail_write").on("click", showMailSendForm);
		$("#btn_mail_abort").on("click", showMailInBox);
		
		$("#mail_more").click(function () {
			initMailView(true);
		});

		$("#btn_mail_send").on("click", function() {
			if(!isEmpty($("#mail_new_to").val()) && !isEmpty($("#mail_new_content").val())) {
				$("#mail_popupDialog").popup("open", { positionTo: "window", transition: "pop" });
			}
			else {
				loadingIn("Sie haben keinen Empf채nger oder keinen Inhalt eingegeben!", true);
				setTimeout(loadingOut, 3000);
			}
		});

		$("#btn_mail_really").on("click", function() {
			var to = $("#mail_new_to").val().match(GLOBAL.MAIL.filter).toString();
			var cc = $("#mail_new_cc").val();
			var subject = $("#mail_new_subject").val();
			var content = $("#mail_new_content").val();
			
			cc = isEmpty(cc)?"":cc.match(GLOBAL.MAIL.filter).toString();
			
			$("#mail_popupDialog").popup("close");
			
			loadingIn("Ihre Mail wird versendet ...");
			
			$.post(CONFIG.SERVER.base+CONFIG.SERVER.mails, {credentials: CONFIG.AUTH.credentials,
															salt: CONFIG.AUTH.salt, 
															to: to, cc: cc, 
															subject: subject, message: content})
				.done(function(data, status, jqXHR) {
					loadingOut();
					if(!isEmpty(data.exception)) {
						loadingIn("Beim Versenden der Mail ist ein Fehler aufgetreten!", true);
					}
					else {
						loadingIn("Ihre Mail wurde erfolgreich versendet!", true);
					}
					setTimeout(loadingOut, 3000);
					showMailInBox();
				});
			//.fail(ajaxErrorHandler);
		});

		/**
		 * Handler for Answering Mails, called by Answer-Button.
		 * 
		 * @param Event-Object e ... Click-Event
		 */
		function answerMail(e) {
			var tmp = $(e.target).parent();
			var from = tmp.find("span.mail-from")
						  .text()
						  .match(GLOBAL.MAIL.filter);
			var subj = tmp.find("span.mail-subject")
						  .text();
			
			$("#mail_new_to").val(from);
			$("#mail_new_subject").val("Re: "+subj);
			
			$("#btn_back").click();
			showMailSendForm();
		};

		/**
		 * Display Mail Inbox.
		 */
		function showMailInBox() {	
			$("#mail_sendForm").hide();
			$("#mail_inbox").show();
			
			$("#btn_refresh").show();
			$("#btn_mail_abort").hide();
			$("#btn_mail_write").show();
			$("#btn_mail_send").hide();
		};

		/**
		 * Display Mail Send-Formular.
		 */
		function showMailSendForm() {
			$("#mail_new_to").val("");
			$("#mail_new_cc").val("");
			$("#mail_new_subject").val("");
			$("#mail_new_content").val("");
			
			$("#mail_inbox").hide();
			$("#mail_sendForm").show();
			
			$("#btn_refresh").hide();
			$("#btn_mail_abort").show();
			$("#btn_mail_write").hide();
			$("#btn_mail_send").show();
		};

		/**
		 * Loading the Mails.
		 * 
		 * @param Boolean more ... indicates whether additional Mails should be loaded
		 */
		function initMailView(more) {
			var offset = 0;
			var remove = true;
			
			if(more == true) { 
				remove = false;
				offset = $('#mail_list li').length;
			}
			
			if(!isEmpty(CONFIG.AUTH.credentials))
			{
				loadingIn();
				$.getJSON(CONFIG.SERVER.base+CONFIG.SERVER.mailg, {credentials: CONFIG.AUTH.credentials, salt: CONFIG.AUTH.salt, offset: offset})
				 .done(function(data, status, jqXHR) {
						if(isEmpty(data.exception)) {
						 	fillMailList(data, remove);
							loadingOut();
							GLOBAL.INIT.mail = true;
						} 
						else {
							loadingOut();
							loadingIn("Es konnten keine Mails abgerufen werden!", true);
							setTimeout(loadingOut, 3000);
						}
				  });
			}
			//.fail(ajaxErrorHandler);
		};
		
		function fillMailList(data, remove) {
			var mail, sdate = new Date(0);
			var lis = "";
			var divs = $();
			
			var body = $("body");
			var list = $("#mail_list");
			
			if(!isEmpty(data)) {
				if(remove) {
					list.empty();
					body.find("div.maildetails")
						.remove();
				}
				
				for(var k in data) {
					mail = data[k];

					// Format: Thu Oct 09 14:54:21 <CEST,CET> 2008
					// CEST is Summer UTC +2h -> for reference see http://www.timeanddate.com/library/abbreviations/timezones/eu/cest.html
					// CET is Winter UTC +1h -> for reference see http://www.timeanddate.com/library/abbreviations/timezones/eu/cet.html
					mail.sendDate = new Date(mail.sendDate.replace(/CEST/, "+0200").replace(/CET/, "+0100"));
					
					lis += createMailEntry(mail, sdate);
					divs = divs.add(createMailDetails(mail));
					
					sdate = mail.sendDate;
				}
				
				list.append(lis)
					.find("li")
					.removeClass("ui-last-child")
					.first().addClass("ui-first-child").end()
					.last().addClass("ui-last-child").end()
					.end()
					.trigger("create");
				
				body.append(divs)
					.trigger("create");
			}
		};

		/**
		 * Creating Mail-List Entry for given Mail.
		 * 
		 * @param Object mail ... Mail Data
		 * @param Date sdate ... Sending Date of last processed Mail
		 * 
		 * @return String
		 */
		function createMailEntry(mail, sdate) {
			var li = "";
			var time = mail.sendDate.getHours()+":"+mail.sendDate.getMinutes();
			
			if(sdate.getTime()!=mail.sendDate.getTime()) {
				li += '<li data-role="list-divider" role="heading" class="ui-li-divider ui-bar-inherit ui-li-has-count">'+createDateStamp(mail.sendDate)+'</li>';
			}
			
			li += 	'<li><a href="#mail_'+mail.id+'" class="ui-btn ui-btn-icon-right ui-icon-carat-r">'+
					'<h2>'+mail.subject+'</h2>'+
					'<p><strong>'+escape(mail.from)+'</strong></p>'+
					'<p class="ui-li-aside"><strong>'+time+'</strong></p>'+
					'</a></li>';
			
			return li;
		};
		
		/**
		 * Creating Mail-Details for given Mail.
		 * 
		 * @param Object mail ... Mail Data
		 */
		function createMailDetails(mail) {
			var toList, subj, from;
			var div, msg;

			from = escape(mail.from);
			
			subj = escape(mail.subject);
			
			toList = mail.toList?mail.toList.toString():"";
			toList = toList.slice(0, toList.lastIndexOf(",")).replace(/[;:]/g, "");
			toList = escape(toList);
			
			msg = $.parseHTML(mail.message);
			msg = $('<pre class="mail-content-iframe" />').append(msg).html();
			
			div = $('<div id="mail_'+mail.id+'" data-role="page" data-title="Mail" data-subpage="true" class="maildetails" data-theme="a" data-content-theme="a">'+
					'<div data-role="content">'+
						'<p><strong>Von: </strong><span class="mail-from">'+from+'</span></br>'+
						'<strong>An: </strong>'+toList+'</br>'+
						'<strong>Betreff: </strong><span class="mail-subject">'+subj+'</span></br>'+
						'</p><hr>'+msg+
						'<hr><a href="#" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-b btn_mail_answer" data-icon="forward">Antworten</a>'+
					'</div>'+
				'</div>');
			
			//msg.contents().find("html").find("a").addClass("external");
			
			div.find("a.btn_mail_answer").click(answerMail);
			
			return div;
		};
	</script>
</div>

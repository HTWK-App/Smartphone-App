<!DOCTYPE html>
<html>
	<head>
        <title>HTWK App</title>
		
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
        
	<link rel="stylesheet" href="css/font-awesome.min.css" />
        <link rel="stylesheet" href="css/jquerymobile-1.4.2.min.css" />
        <link rel="stylesheet" href="css/design-1.4.2.css" />
        <link rel="stylesheet" href="css/design.htwk-1.4.2.css"  id='jQMnDTheme' />
        <link rel="stylesheet" href="css/design.color.htwk.css" id='jQMnDColor' />
        
	<!--<script type="application/javascript" src="js/lib/fastclick.min.js"></script>-->
	<script type="application/javascript" src="js/lib/jquery-2.1.0.min.js"></script>
        <script type="application/javascript" src="js/lib/jquery.mobile-1.4.2.min.js"></script>
        <script type="application/javascript" src="js/lib/jquery.i18n-1.0.min.js" defer></script>
        
        <script type="application/javascript" src="js/lib/device.js" defer></script>
        <script type="application/javascript" src="js/lib/PushNotification.js" defer></script>
        
        <script type="text/javascript" src="https://maps.google.com/maps/api/js?v=3.exp&sensor=true" defer></script>
        
        <script type="application/javascript" src="cordova.js"></script>
        
	<script type="application/javascript" src="js/config.js"></script>
	<script type="application/javascript" src="js/fn.js"></script>
	<script type="application/javascript" src="js/gmaps.js" defer></script>
	<script type="application/javascript" src="js/pushnotification_support.js" defer></script>
	
		
	<style>
		.map-canvas{
			height:250px;
		}
		.blur { 
			-webkit-filter: blur(2px);
			-moz-filter: blur(2px);
			-ms-filter: blur(2px);
			-o-filter: blur(2px);
			filter: blur(2px);
		}
	</style>
	</head>
	<body>
		<div id="index" data-role="page" data-theme='b'>
			<!--- HEADER --->
			<div data-role="header" data-position="fixed" data-theme='b' class="header toblur">
				<a data-role="button" data-iconpos='left' class="btn_menu"><span class="icon-ellipsis-vertical"></span></a>
				<h1>HTWK App</h1>
			</div>
			<!--- HEADER --->
			
			<!--- MENU --->
			<div data-role="panel" data-theme="a" data-display="push" class="menu">
				<ul data-role="listview">
					<li data-role="list-divider" role="heading">Hauptmenü</li>
					<li data-icon="fire"><a href="index.html">Startseite</a></li>
					<li data-icon="fire"><a href="news.html">News</a></li>
					<li data-icon="trophy"><a href="timetable.html">Stundenplan</a></li>
					<li data-icon="trophy"><a href="canteen.html">Mensa</a></li>
					<li data-icon="trophy"><a href="mail.html">Postfach</a></li>
					<li data-icon="trophy" class="menu_item_qis"><a href="qis.html">QIS</a></li>
					<li data-icon="trophy"><a href="sport.html">Hochschulsport</a></li>
					
				</ul>
				<!--<div data-role="collapsible"><h4>Info-Center</h4> -->
				<ul data-role="listview">
					<li data-role="list-divider" role="heading">Info-Center</li>
					<li data-icon="trophy"><a href="info_general.html">Allgemein</a></li>
					<li data-icon="trophy"><a href="info_staff.html">Mitarbeiter</a></li>
					<li data-icon="trophy"><a href="info_buildings.html">Gebäudeplan</a></li>
					<li data-icon="trophy"><a href="info_wlan.html">WLAN-Konfiguration</a></li>
				</ul>
				<!--</div> -->
				<ul data-role="listview">
					<li data-role="list-divider" role="heading">Tools</li>
					<li data-icon="trophy"><a href="room_search.html" >Leeren Raum finden</a></li>
					
				</ul>
				<ul data-role="listview">
					<li data-role="list-divider" role="heading">Einstellungen</li>
					<li data-icon="trophy"><a href="settings.html">HTWK-App</a></li>
				</ul>
			</div>
			<!--- MENU --->
			
			<div data-role="content" class="toblur">   
				<div class='inset cardAnimated'>
					<h1>Willkommen ...</h1>
					<ul data-nativedroid-plugin='cards' class="nativeDroidCards">
						<li id="weatherCard" data-cards-type='weather'>
						</li>
						<li id="HTWKNews" data-cards-type='text'>
						</li>
						<li id="HTWKEvents" data-cards-type='text'>
						</li>
						<li id="LVZNews" data-cards-type='text'>
						</li>
					</ul>
				</div>
			</div>
		</div>
		<!-- ## SIGNIN DIALOG ## -->
		<div id="signInDialog" data-role="popup" data-dismissible="false" data-theme="b" data-overlyaTheme="b" data-transition="pop">
			<style>
				h2, h4, a, label{color: white;}
			</style>
	    		<div data-role="header" data-theme="b">
	   	 		<h2>Authentifizierung</h2>
	   	 	</div>
	   	 	<div data-role="content" data-theme="b" class="inset">
	   	 		<h4>Damit Sie diesen Dienst nutzen können, müssen Sie sich zunächst anmelden!</h4>
	   	 		
	   	 		<label for="username"><strong>Nutzername:</strong></label>
	   	 		<input type="text" name="username" id="signInDialogUsername" value="" placeholder="Nutzername">
	   	 		
	   	 		<label for="password"><strong>Passwort:</strong></label>
	   	 		<input type="password" name="password" id="signInDialogPassword" value="" autocomplete="off" placeholder="******">
	   	 		
	   	 		<a id="signInDialog_Btn_Abort" href="#" data-role="button" data-inline="true" data-rel="back">Abbrechen</a>
	   	 		<a id="signInDialog_Btn_Save" href="#" data-role="button" data-inline="true">Speichern</a>
	   	 	</div>
		</div>
		<!-- ## SIGNIN DIALOG ## -->

		<!---------------------------------------------------------------------------------------------------->
		<script>

			/*TODO
			 * Blur effect is very expensive! Even the desktop browser begans to be laggy :/
			 * Placing of images at fillCard (by card LVZ) isn't the best for Smartphones
			 */

			// AJAX Setup
			$.ajaxSetup(CONFIG.AJAX);
		
			// GENERAL Setup
			$( document )
				.ready(function() {
					$.mobile.defaultPageTransition   = "fade";
					$.mobile.defaultDialogTransition = "fade";
					$.mobile.buttonMarkup.hoverDelay = 0;
					$.mobile.changePage.defaults.allowSamePageTransition = true;

					// swipe Event
					GLOBAL.SCREEN.height = window.screen.height;
					GLOBAL.SCREEN.width = window.screen.width;
					$.event.special.swipe.scrollSupressionThreshold=Math.round(0.3*GLOBAL.SCREEN.width);
					$.event.special.swipe.horizontalDistanceThreshold = 5; // Swipe horizontal displacement must be more than this.
					$.event.special.swipe.durationThreshold = 5000;  // More time than this, and it isn't a swipe.
					$.event.special.swipe.verticalDistanceThreshold = 75; // Swipe vertical displacement must be less than this.
					//$.event.special.swipe.durationThreshold=1000;
					//$.event.special.swipe.horizontalDistanceThreshold=Math.round(0.2*GLOBAL.SCREEN.width);
					//$.event.special.swipe.verticalDistanceThreshold=Math.round(GLOBAL.SCREEN.height);

					// Add EventListener for Fastclick Framework//
					//window.addEventListener("load", function() {
					//	FastClick.attach(document.body);
					//}, false);
				
					loadParameters();
				
					if(!CONFIG.GENERAL.student) {
						$("div.menu li.menu_item_qis").hide();
					}

					GLOBAL.DATE.currentWeek = getWeek(new Date());
					$("#signInDialog").trigger("create").popup();
				})
				//TODO Blur effect is very expensive! Even the desktop browser begans to be laggy :/
				.on("panelbeforeopen", function( event, ui ) {
					$(".toblur").addClass("blur");
				})
				.on("panelbeforeclose", function( event, ui ) {
					$(".toblur").removeClass("blur");
				})
				// Copy Menu to new Pages
				.on("pagebeforecreate", "div:jqmData(role='page')", function() {
					var m = $("#index div.menu").eq(0).clone();
					var o = $(this);
					
					if(o.find("div.menu").length==0 && isEmpty(o.jqmData("subpage"))) {	
						o.prepend(m.panel());
					}
				})
			
				// Header Update on Page Switch
				.on("pageshow", "div:jqmData(role='page')", function() {
						var o = $("body").pagecontainer("getActivePage");
		    			var title = o.jqmData("title");
		    			//var subpage = !isEmpty(o.jqmData("subpage"));
		    			var h = o.find("div.header");
		    			
		    			h.find("h1").text(title);
				})
				// External Link Handling
				.on("click", "a.external", openInExternalBrowser)
				// Button Menu
				.on("click", "a.btn_menu", function(e) {
					var o = $("body").pagecontainer("getActivePage");
					o.find("div.menu").panel("toggle");
				})
				// Swipe Event Menu
				.on("swiperight", function(e) {
					var start = e.swipestart.coords;
					var stop = e.swipestop.coords;
					alert(e.swipestart.coords+" "+e.swipestop.coords);
					if(start[0] <= 0.1*GLOBAL.SCREEN.width){
						var o = $("body").pagecontainer("getActivePage");
						o.find("div.menu").panel("open");
					}
				});

			// SignIn Dialog
			$( "#signInDialog_Btn_Abort" )
				.on("click", function () {
					$( "#signInDialog" ).popup("close");
					var o = $("body").pagecontainer("getActivePage");
					o.find("div.menu").panel("open");
				});

		// ## Index Page #############################################################
			$("#index")
				.on("pagecreate", function() {})
				.on("pageshow", function () {
					if(!GLOBAL.INIT.index) loadingIn();
					fillCards();
				});

			/**
			 * Fills all corresponding cards (named as arguments) with content
			 *
			 */
			function fillCards(){
				getWeatherLocation();
				fillCard("rss.lvz.news", "LVZNews", "News der LVZ Leipzig");
				fillCard("rss.htwk.1", "HTWKEvents", "Kommende HTWK Veranstaltungen");
				fillCard("rss.htwk.3", "HTWKNews", "Neuste HTWK Nachrichten");
			};

			/**
			 * Gets the user location and calls on succes: fillWeatherCard, on fail: onGeoGetFail
			 *
			 */
			function getWeatherLocation(){
				navigator.geolocation.getCurrentPosition(fillWeatherCard, weatherLocationError, { maximumAge: 7000, timeout: 30000});
			};

			function weatherLocationError(){
				$("#weatherCard").empty().append("<p>Ihre Position konnte leider nicht bestimmt werden</p>");
			};

			/**
			 * Fills the weather card, with the weather for the specified location
			 *
			 * @param GeoData-Object positon ... Geo Position Object, See W3C documentation
			 */
			function fillWeatherCard(position){
				
				loadingIn();

				var weathercard = $("#weatherCard");
			
				$.getJSON(CONFIG.SERVER.base+CONFIG.SERVER.weather+position.coords.latitude+','+position.coords.longitude+"&days=5")
					 .done(function(data, status, jqXHR) {
						if(!isEmpty(data.exception))
							{ ajaxErrorHandler(data, status, jqXHR); return; }

						var div = "";
						var count = 0;
						var weekday = new Array(7); weekday[0] = "So"; weekday[1] = "Mo"; weekday[2] = "Di"; weekday[3] = "Mi"; weekday[4] = "Do"; weekday[5] = "Fr"; weekday[6] = "Sa";

						for(var k in data){
							var day = data[k];
							var date = new Date(day.dt*1000);
							date = date.getDay();
							var temp;

							if(k == 0){
								div += '<h1>'+day.name+'</h1><h2>'+day.country+'</h2>';
							}

							if(count == 1 && k != 0){
								temp = day.temp.day.toFixed(1);
								div += '<ul class="detail">'+
									'	<li>'+
									'		<span><img src="'+day.weather[0].iconData+'" style="margin: -10px 0 -17px 0;"></span>'+
									'		<span>'+day.weather[0].descriptionDe+'</span>'+
									'		<span class="icon-flag"> '+day.speed+' m/s</span>'+
									'	</li>'+
									'	<li>'+temp+'&deg;</li>'+
									'</ul>';
							}else if(k != 0){
								temp = [day.temp.max.toFixed(1),day.temp.min.toFixed(1)];
								if(count == 2){
									div+= '<ul class="week">'
								}
								div += '<li>'+
									'	<span>'+weekday[date]+'</span>'+
									'	<span><img src="'+day.weather[0].iconData+'" style="margin: -10px 0 -17px 0;"></span>'+
									'	<strong>'+temp[0]+'&deg;</strong>'+
									'	<span>'+temp[1]+'&deg;</span>'+
									'</li>';
							}
							count += 1;
						}
						div += '</ul>';

						weathercard.empty().append(div).trigger("create");

						loadingOut();
						GLOBAL.INIT.index = true;
					})
					.fail(ajaxErrorHandler);
			};

			/**
			 * Fills a card, given by parameter card, with one of the specified news feeds
			 *
			 * @ param String feed ... a valid feed name to fetch from the Server
			 * @ param String card ... the id of the card to be filled
			 * @ param String heading ... the heading of the card
			 */
			function fillCard(feed, card, heading) {
				loadingIn();

				$.getJSON(CONFIG.SERVER.base+CONFIG.SERVER.news+'/get?feed='+feed+'&limit=2')
				 .done(function(data, status, jqXHR) {
						if(!isEmpty(data.exception))
							{ ajaxErrorHandler(data, status, jqXHR); return; }

						var divs = "<h1>"+heading+"</h1><hr>";
						
						for(var k in data.responseData.feed.entries) {
							entry = data.responseData.feed.entries[k];
							
							//var img = entry.content.match(/^(.*)<img ([a-zA-Z0-9\-]=("|')?(.*)("|')?)+ \/?>(.*)$/);
							var img = entry.content.match(/<img .*\/?>/);
							var imgEnd = entry.content.indexOf(">")+1;
							var content = entry.content.slice(imgEnd, imgEnd+300)+"...";
							
							if(!isEmpty(img)) img = '<div style="float: left; max-width: 100%; overflow: hidden;">'+img[0]+'</div>';
							else img = "";
				
							if(!isEmpty(entry.content)) {
								divs += '<strong>'+entry.title+'</strong>'+
										'<p>'+img+content+'</p>'+
										'<a href="'+entry.link+'" class="external" style="clear:both;" data-role="button">Weiterlesen...</a>';
							}
							
							divs += '<hr>';
						}
						
						divs = $(divs);
						
						$("#"+card)
							.empty()
							.append(divs)
							.trigger("create");
						
						divs.filter("hr")
							.last()
							.remove();

						loadingOut();
				  })
				 .fail(ajaxErrorHandler);
			};
		</script>
	</body>
</html>

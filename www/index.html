<!DOCTYPE html>
<html>
	<head>
		<title>HTWK App</title>
		<meta charset = "utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1"> 

		<link rel="stylesheet" type="text/css" href="themes/jquery.mobile-1.4.2.min.css" />
		<link rel="stylesheet" type="text/css" href="themes/HTWK.min.css" />
		<link rel="stylesheet" type="text/css" href="themes/additions.css" />
		
		<script type="application/javascript" src="js/lib/fastclick.js"></script>
		<script type="application/javascript" src="js/lib/jquery-2.0.3.min.js"></script>
		<script type="application/javascript" src="js/lib/jquery.mobile-1.4.2.min.js"></script>
		
		<script type="application/javascript" src="js/config.js"></script>
		<script type="application/javascript" src="js/fn.js"></script>
	</head>
	<body>
		<nav id="menu" data-role="panel" data-theme="b">
			<div data-role="listview" data-inset="true" data-theme="b">
				<li>
					<a href="index.html">News</a>
				</li>
				<li>
					<a href="timetable.html">Stundenplan</a>
				</li>
				<li>
					<a href="mensa.html">Mensa</a>
				</li>
				<li>
					<a href="mail.html">Postfach</a>
				</li>
				<li>
					<a href="qis.html">QIS</a>
				</li>
				<li>
					<a href="sport.html">Hochschulsport</a>
				</li>
				<li>
					<div data-role="collapsible" data-inset="false" data-iconpos="right" data-collapsed-icon="carat-d" data-expanded-icon="carat-u" class="pcoll" data-theme="b">
				    <h4>Info-Center</h4>
				    <ul data-role="listview">
						<li>
							<a href="info.html">Allgemein</a>
						</li>
						<li>
							<a href="staff.html">Mitarbeiter</a>
						</li>
						<li>
							<a href="building.html">Gebäudeplan</a>
						</li>
						<li>
							<a href="wlan.html">WLAN-Konfiguration</a>
						</li>
				    </ul>
				    </div>
				</li>
				<li>
					<a href="room.html">Finde leeren Raum</a>
				</li>
				<li>
					<a href="settings.html">Einstellungen</a>
				</li>
			</div>
		</nav>
		
		<header id="header" data-role="header" data-position="fixed" class="toblur" data-theme="a">
			<h1>News</h1>
			<div data-type="horizontal" class="ui-btn-left">
				<a id="btn_menu" href="#menu" data-role="button" data-icon="bars" data-mini="true">Menü</a>	
				<a id="btn_back" data-rel="back" data-role="button" data-icon="back" data-mini="true">Zurück</a>
			</div>
			<!-- TODO noText -->
			<div data-role="controlgroup" data-type="horizontal" class="ui-btn-right">
				<a id="btn_refresh" data-role="button" data-icon="refresh" data-rel="refresh">Refresh</a>
			</div>
		</header>
		
		<div id="news_page" data-role="page" data-dom-cache="true" data-title="News" class="toblur" data-theme="a" data-content-theme="a">
			<div data-role="content">
				<div data-role="fieldcontain">
					<label for="news_select">Kategorie:</label>
					<select id="news_select" name="news_select" data-mini="true">
						<option selected="selected">Liste der verfügbaren News-Feeds wird geladen...</option>
					</select>
				</div>
				<ul id="news_content_list" data-role="listview" data-inset="true"></ul>
				<!-- TODO <a data-role="button" id="news-more">Mehr</a>-->
			</div>
			<div id="news_popup" data-role="popup">
				<p>Diese Nachricht besitzt keinen zusätzlichen Inhalt!</p>
			</div>
		</div>

	<script>
		//var showLoading = false;
		//var feedList = new Array();

		$.ajaxSetup(CONFIG.AJAX);
		
		$( document )
			.ready(function() {
				$.mobile.defaultPageTransition   = "none";
				$.mobile.defaultDialogTransition = "none";
				$.mobile.buttonMarkup.hoverDelay = 0;
				$.mobile.changePage.defaults.allowSamePageTransition = true;
				// Add EventListener for Fastclick Framework//
				window.addEventListener("load", function() {
					FastClick.attach(document.body);
				}, false);
				// there is no Element to fit the Selector
				//$( "[data-role='navbar']" ).navbar();
				$("header, footer").toolbar();
				var help = localStorage.getItem("username");
				if(help != undefined) GLOBAL.DEMO.username = help;
				help = localStorage.getItem("credentials");
				if(help != undefined) GLOBAL.DEMO.credentials = help;
				help = localStorage.getItem("salt");
				if(help != undefined) GLOBAL.DEMO.salt = help;
				help = localStorage.getItem("language");
				if(help != undefined) CONFIG.LANGUAGE.set = help;
				help = localStorage.getItem("defaultFeed");
				if(help != undefined) CONFIG.NEWS.defaultFeed = help;
				help = localStorage.getItem("defaultCanteen");
				if(help != undefined) CONFIG.MENSA.defaultCanteen = help;
			})
			.on("panelbeforeopen", function( event, ui ) {
				$(".toblur").addClass("blur");
			})
			.on("panelbeforeclose", function( event, ui ) {
				$(".toblur").removeClass("blur");
			})
			/* Update the contents of the toolbars*/
			.on("pageshow", "div:jqmData(role='page')", function() {
    			/* on page: <div data-role="page" data-title="Info">*/
				var o = $(this);
    			var title = o.jqmData("title");
    			var subpage = !isEmpty(o.jqmData("subpage"));
    			var h = $("#header");
    			
    			h.find("h1").text(title);
    			//if( curr == "back") {
    			if(subpage) {
    				h.find("#btn_back").css("display", "block").end()
    				 .find("#btn_menu").css("display", "none");
    				//$( "[data-role='header'] a" ).remove();	
    				//$( "[data-role='header']" ).append('<a data-role="button" data-rel="back" data-icon="back" data-mini="true" class="ui-btn-left">Zurück</a>');
    			} else {
    				//h.find("h1").text( curr ).end()
    				h.find("#btn_menu").css("display", "block").end()
    				 .find("#btn_back").css("display", "none");
    				//$( "[data-role='header'] h1" ).text( current );
    				//$( "[data-role='header'] a" ).remove();	
    				//$( "[data-role='header']" ).append('<a href="#menu" data-role="button" data-icon="bars" data-mini="true" class="ui-btn-left">Menü</a>');
    			}
			});
		// TODO showLoading
		//$( document ).on( "pageshow", function() {if(showLoading == true){showLoader();}});

		$( "#news_page" )
			.on("pagebeforecreate", function() {
				GLOBAL.DATE.currentWeek = getWeek(new Date());
			 })
			/*.on("pagebeforecreate", function() {
				$.getJSON(CONFIG.SERVER.base+CONFIG.SERVER.news)
				.done(fillNewsFeedSelect);
				//fillNewsCategories();
				//	fillNewsContent("");
			})*/
			.on("pagecreate", initNewsView)
			.on("pageshow", function () {
				if(!GLOBAL.INIT.news) loadingIn();
				$("#news_content_list li a").removeClass("ui-btn-active");
				$("#btn_refresh")
				.off()
				.on("click", function() { 
					$("#news_select").change(); 
				 });
			});

		$( "#news_select" )
			.change(function() {
				//$("#news_content_list").empty();
				//$( "div.news_details" ).detach();
				//fillNewsContent(feedList[$(this).val()]);
				changeNewsFeed($(this).val());
			});

		// TODO
		/*function showLoader() {
			showLoading = true;
			$.mobile.loading('show');
		}*/

		/*function fillNewsCategories() {
			$.getJSON(CONFIG.SERVER.base+CONFIG.SERVER.news)
			 .done(fillNewsFeedSelect); 
			//function(data) {
				//$.each( data, createNewsCategory);
				
				//$('#news-more').click(function () {
				//	fillNewsContent(feedList[0]);
				//});
			//});
		}*/
		
		//function fillNewsFeedSelect(data) {//key, item){
		/**
		 * Loading the available News-Feeds (Prefill Feed-Selectbox).
		 */
		function initNewsView() {
			$.getJSON(CONFIG.SERVER.base+CONFIG.SERVER.news)
			 .done(function(data, status, jqXHR) {
					//var list = $("#news_select");
					var tmp, name, id, opts;

					opts = "";
					
					for(var k in data)
					{
						id = data[k].id;
						tmp = id.split(".");
						name = capitalize(tmp[1])+(tmp.length==3?" "+tmp[2]:"");
						if(id == CONFIG.NEWS.defaultFeed)
							tmp = 'selected="selected"';
						else 
							tmp = "";
						opts += '<option value="'+id+'" '+tmp+'>'+name+'</option>'; 
						//feedList[k] = id;
					}	
					
					$( "#news_select" )
						.empty()
						.append(opts)
						.selectmenu("refresh")
						.change();
					
					loadingOut();
					GLOBAL.INIT.news = true;
					
					//var help = item.id.split(".");
					//var name = help[1].substr(0,1).toUpperCase()+help[1].substring(1,help[1].length);
					//var number = ""; var sel = "";
					//if(help.length == 3){number = help[2];}else{number = "";}
					//if(key == "rss.htwk.4") {sel = 'selected="selected"';}
					//list.append('<option value="'+key+'" '+sel+'>'+name+' '+number+'</option>');
					//feedList[key] = item.id;
					//list.selectmenu( "refresh" );
			 });
		};

		/**
		 * Loading all News of the given Feed.
		 */
		function changeNewsFeed(feed) {
			loadingIn();
			//$.getJSON( SERVER_URL+'news/get?',{feed: feed}).done( function(data,a,b) {
			$.getJSON(CONFIG.SERVER.base+CONFIG.SERVER.news+"/get?", {feed: feed})
			 .done(function(data, status, jqXHR) {
				 	createNewsEntries(data.responseData.feed.entries);
				 	loadingOut();
				 //$('#news_content_list').empty();
					/*$.each( data.responseData.feed.entries, function( i, item ) {
						newsCreateNewsElement("",item.title,item.contentSnippet,item.content,item.publishedDate);		
					});*/
					//$.mobile.loading('hide'); 
					//showLoading = false;
				});
			// TODO fail
		};

		//function newsCreateNewsElement(picture,header,contentSnippet,content,date){
		/**
		 * Creating all News-Entries inclusive Details.
		 */
		function createNewsEntries(data) {
			var link, pic, title, snipp, content, date;
			var c = 0;
			var lis = "";
			var divs = "";
			
			// not needed anymore
			//GLOBAL.NEWS.counter = 0;
			
			for(var k in data)
			{
				pic = "";
				title = data[k].title;
				snipp = data[k].contentSnippet;
				content = data[k].content;
				date = new Date(data[k].publishedDate);
				
				if(!isEmpty(pic)) pic = '<img src="data:image/png;base64,'+pic+'" />';
				if(isEmpty(content)) link = 'popup" data-rel="popup"';
				else link = ++c + '"'; //++GLOBAL.NEWS.counter + '"';
				
				lis += 	'<li><a href="#news_'+link+'>'+
							'<h3>'+title+'</h3>'+
							'<p>'+snipp+'</p>'+
							'<p><small>'+createDateTimeStamp(date)+'</small></p>'+
						'</a></li>';
				
				divs += '<div id="news_'+link+' data-role="page" data-title="News" data-subpage="true" class="newsdetails" data-theme="a" data-content-theme="a">'+
							'<div data-role="content">'+pic+
								'<h2>'+title+'</h2><h4><small>'+createDateTimeStamp(date)+'</small></h4><p>'+content+'</p>'+
							'</div>'+
						'</div>';
			}
			
			$( "#news_content_list" )
				.empty()
				.append(lis)
				.listview("refresh")
				.trigger("updatelayout");
			
			$( "body" )
				.find("div.newsdetails")
				.remove().end()
				.append(divs)
				.trigger("create");
			
			$.mobile.initializePage();
			
			/*
			if (content == ""){ link = 'popup" data-rel="popup"';
			}else { link =  ++GLOBAL.NEWS.counter + '"';}
			var pattern = 
				'<li><a href="#news_'+link+'>'+
					'<h3>'+header+'</h3>'+
					'<p>'+contentSnippet+'</p>'+
					'<p><small>'+date+'</small></p>'+
				'</a></li>';
			clist = $('#news_content_list');
			clist.append(pattern);
			clist.listview('refresh');
			clist.trigger('updatelayout');
			if(content != ""){
				var help = "";
				if(picture != "") {
					help = '<img src="data:image/png;base64,'+picture+'" />';
				}
				pattern = 
					'<div data-role="page" class="newpage" id="news_'+link+' data-title="back" data-theme="a" data-content-theme="a">'+
						'<div data-role="content" id="news_content">'+
							help+
							'<h2>'+header+'</h2><h4><small>'+date+'</small></h4><p>'+content+'</p>'+
						'</div>'+
					'</div>';
				$( "body" ).append(pattern).trigger("create");
				$.mobile.initializePage();
			}*/
		};
	</script>	
	</body>
</html>

<!DOCTYPE html>
<html>
	<head>
		<title>HTWK App</title>
		
		<meta http-equiv="Content-Type" content="text/html;charset=utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
        
		<link rel="stylesheet" href="css/HTWK-App.min.css" />
		<link rel="stylesheet" href="css/jquery.mobile.icons.min.css" />
		<link rel="stylesheet" href="css/jquery.mobile.custom.structure.min.css" />
		<link rel="stylesheet" href="css/defaultThemeChanges.min.css" />
		<link rel="stylesheet" href="css/jqm-icon-pack-fa.css" />
		<link rel="stylesheet" href="css/font-awesome.min.css" />

		<script type="application/javascript" src="js/lib/jquery-2.1.1.min.js"></script>
		<script type="application/javascript" src="js/lib/jquery.mobile.custom.1.4.2.min.js"></script>

		<script type="application/javascript" src="js/config.js"></script>
		<script type="application/javascript" src="js/fn.js"></script>
		<script type="application/javascript" src="cordova.js"></script>
		<script type="application/javascript" src="analytics.js"></script>
		
	</head>
	<body>

		<div id="index" data-role="page" data-theme='b'>

			<!--- MENU -->
			<div data-role="panel" data-theme="a" data-display="overlay"  data-position="left"  data-swipe-close="true" class="menu">
				<ul data-role="listview">
					<li data-role="list-divider" role="heading">Hauptmenü</li>
						<li data-icon="home"><a href="index.html">Startseite</a></li>
						<li data-icon="paperclip"><a href="news.html">News</a></li>
						<li data-icon="calendar"><a href="timetable.html">Stundenplan</a></li>
						<li data-icon="cutlery"><a href="canteen.html">Mensa</a></li>
						<li data-icon="envelope"><a href="mail.html">Postfach</a></li>
						<li data-icon="certificate" class="menu_item_qis"><a href="qis.html">QIS</a></li>
						<li data-icon="dribbble"><a href="sport.html">Hochschulsport</a></li>
					<li data-role="list-divider" role="heading">Info-Center</li>
						<li data-icon="fire"><a href="info_general.html">Allgemein</a></li>
						<li data-icon="group"><a href="info_staff.html">Mitarbeiter</a></li>
						<li data-icon="map-marker"><a href="info_buildings.html">Gebäudeplan</a></li>
						<li data-icon="rss"><a href="info_wlan.html">WLAN-Konfiguration</a></li>
					<li data-role="list-divider" role="heading">Tools</li>
						<li data-icon="map-marker"><a href="room_search.html" >Leeren Raum finden</a></li>
					<li data-role="list-divider" role="heading">Einstellungen</li>
						<li data-icon="gear"><a href="settings.html">HTWK-App</a></li>
				</ul>
			</div>
			<!--- MENU -->

			<!--- HEADER -->
			<div data-role="header" data-position="fixed" data-tap-toggle="false" data-theme='b' class="header">
				<a href="#" class="ui-btn-left ui-btn ui-btn-inline ui-mini ui-corner-all btn_menu"><i class="fa fa-bars fa-lg"></i></a>
				<h1>HTWK App</h1>
			</div>
			<!--- HEADER -->
			
			<div role="main" class="ui-content">   
				<h1>Willkommen ...</h1>
				<ul data-nativedroid-plugin='cards' class="nativeDroidCards">
					<li id="PushNotification" data-cards-type='text' style="display: none;"></li>
					<li id="weatherCard" data-cards-type='weather'></li>
					<li id="HTWKNews" data-cards-type='text' class='HtwkImage'></li>
					<li id="HTWKEvents" data-cards-type='text' class='HtwkImage'></li>
					<li id="LVZNews" data-cards-type='text' id="lvz"></li>
				</ul>
			</div>

		</div>

		<!-- ## SIGNIN DIALOG ## -->
		<div id="signInDialog" data-role="popup" data-dismissible="false" data-theme="a" data-overlay-theme="a" data-transition="pop" class="ui-corner-all">
	    <div data-role="header" data-theme="a">
	   		<h2>Authentifizierung</h2>
	   	</div>
	   	<form>
        <div style="padding:10px 20px;">
		 	 		<h4>Damit Sie diesen Dienst nutzen können, müssen Sie sich zunächst anmelden!</h4>
		 	 		
		 	 		<label for="signInDialogUsername" class="ui-hidden-accessible"><strong>Nutzername:</strong></label>
		 	 		<input type="text" name="username" id="signInDialogUsername" value="" placeholder="Nutzername" data-theme="a">
		 	 		
		 	 		<label for="signInDialogPassword" class="ui-hidden-accessible"><strong>Passwort:</strong></label>
		 	 		<input type="password" name="password" id="signInDialogPassword" value="" autocomplete="off" placeholder="Passwort" data-theme="a">

		 	 		<button id="signInDialog_Btn_Save" type="button" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-a ui-btn-icon-left ui-icon-check">Anmelden</button>
					<button id="signInDialog_Btn_Abort" type="button" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-a ui-btn-icon-left ui-icon-back">Abbrechen</button>
   	 		</div>
			</form>
		</div>
		<!-- ## SIGNIN DIALOG ## -->

		<!---------------------------------------------------------------------------------------------------->
		<script>

			/*TODO
			 * Placing of images at fillCard (by card LVZ) isn't the best for Smartphones
			 */

			// AJAX Setup
			$.ajaxSetup(CONFIG.AJAX);
		
			// GENERAL Setup
			$( document )
				.ready(function() {
					$.mobile.defaultPageTransition   = "fade";
					$.mobile.defaultDialogTransition = "fade";
					$.mobile.buttonMarkup.hoverDelay = 0;
					$.mobile.changePage.defaults.allowSamePageTransition = true;

					// swipe Event
					GLOBAL.SCREEN.height = window.screen.height;
					GLOBAL.SCREEN.width = window.screen.width;
					$.event.special.swipe.scrollSupressionThreshold=Math.round(0.3*GLOBAL.SCREEN.width);
					$.event.special.swipe.horizontalDistanceThreshold = 20; // Swipe horizontal displacement must be more than this.
					$.event.special.swipe.durationThreshold = 200;  // More time than this, and it isn't a swipe.
					$.event.special.swipe.verticalDistanceThreshold = 75; // Swipe vertical displacement must be less than this.
					//$.event.special.swipe.durationThreshold=1000;
					//$.event.special.swipe.horizontalDistanceThreshold=Math.round(0.2*GLOBAL.SCREEN.width);
					//$.event.special.swipe.verticalDistanceThreshold=Math.round(GLOBAL.SCREEN.height);

					// Add EventListener for Fastclick Framework//
					//window.addEventListener("load", function() {
					//	FastClick.attach(document.body);
					//}, false);
				
					loadParameters();
				
					if(!CONFIG.GENERAL.student) {
						$("div.menu li.menu_item_qis").hide();
					}

					GLOBAL.DATE.currentWeek = getWeek(new Date());
					$("#signInDialog").trigger("create").popup();

					analytics.startTrackerWithId('UA-49336195-2');
					analytics.trackView('index');
				})
				// Copy Menu to new Pages
				.on("pagebeforecreate", "div:jqmData(role='page')", function() {
					var m = $("#index div.menu").eq(0).clone();
					var o = $(this);
					
					if(o.find("div.menu").length==0 && isEmpty(o.jqmData("subpage"))) {	
						o.prepend(m.panel());
					}
				})
			
				// Header Update on Page Switch
				.on("pageshow", "div:jqmData(role='page')", function() {
						var o = $("body").pagecontainer("getActivePage");
		    			var title = o.jqmData("title");
		    			//var subpage = !isEmpty(o.jqmData("subpage"));
		    			var h = o.find("div.header");
		    			
		    			h.find("h1").text(title);
				})
				// External Link Handling
				.on("click", "a.external", openInExternalBrowser)
				// Button Menu
				.on("click", "a.btn_menu", function(e) {
					var o = $("body").pagecontainer("getActivePage");
					o.find("div.menu").panel("toggle");
				})
				// Swipe Event Menu
				.on("swiperight", function(e) {
					var start = e.swipestart.coords;
					var stop = e.swipestop.coords;
					//alert(e.swipestart.coords+" "+e.swipestop.coords);
					if(start[0] <= 0.1*GLOBAL.SCREEN.width){
						var o = $("body").pagecontainer("getActivePage");
						o.find("div.menu").panel("open");
					}
				});

			// SignIn Dialog
			$( "#signInDialog_Btn_Abort" )
				.on("click", function () {
					$( "#signInDialog" ).popup("close");
					var o = $("body").pagecontainer("getActivePage");
					o.find("div.menu").panel("open");
				});

		// ## Index Page #############################################################
			$("#index")
				.on("pagecreate", function() {})
				.on("pageshow", function () {
					if(!GLOBAL.INIT.index) loadingIn();
					fillCards();
				});

			/**
			 * Fills all corresponding cards (named as arguments) with content
			 *
			 */
			function fillCards(){
				getWeatherLocation();
				fillCard("rss.lvz.news", "LVZNews", "News der LVZ Leipzig");
				fillCard("rss.htwk.1", "HTWKEvents", "Kommende HTWK Veranstaltungen");
				fillCard("rss.htwk.3", "HTWKNews", "Neuste HTWK Nachrichten");
			};

			/**
			 * Gets the user location and calls on succes: fillWeatherCard, on fail: onGeoGetFail
			 *
			 */
			function getWeatherLocation(){
				navigator.geolocation.getCurrentPosition(fillWeatherCard, weatherLocationError, { maximumAge: 7000, timeout: 30000});
			};

			function weatherLocationError(){
				$("#weatherCard").empty().append("<p>Ihre Position konnte leider nicht bestimmt werden</p>");
			};

			/**
			 * Fills the weather card, with the weather for the specified location
			 *
			 * @param GeoData-Object positon ... Geo Position Object, See W3C documentation
			 */
			function fillWeatherCard(position){
				
				loadingIn();

				var weathercard = $("#weatherCard");
			
				$.getJSON(CONFIG.SERVER.base+CONFIG.SERVER.weather+position.coords.latitude.toPrecision(6)+','+position.coords.longitude.toPrecision(6)+"&days=5&customIcons=true")
					 .done(function(data, status, jqXHR) {
						if(!isEmpty(data.exception))
							{ ajaxErrorHandler(data, status, jqXHR); return; }

						var div = "";
						var count = 0;
						var weekday = new Array(7); weekday[0] = "So"; weekday[1] = "Mo"; weekday[2] = "Di"; weekday[3] = "Mi"; weekday[4] = "Do"; weekday[5] = "Fr"; weekday[6] = "Sa";

						for(var k in data){
							var day = data[k];
							var date = new Date(day.dt*1000);
							date = date.getDay();
							var temp;

							if(k == 0){
								div += '<h1>'+day.name+'</h1><h2>'+day.country+'</h2>';
							}

							if(count == 1 && k != 0){
								temp = day.temp.day.toFixed(1);
								div += '<ul class="detail">'+
									'	<li>'+
									'		<span><img src="'+day.weather[0].iconData+'" width="100em" height="100em"></span>'+
									'		<span>'+day.weather[0].descriptionDe+'</span>'+
									'		<span class="icon-flag"> '+day.speed+' m/s</span>'+
									'	</li>'+
									'	<li id="actemp">'+temp+'&deg;</li>'+
									'</ul>';
							}else if(k != 0){
								temp = [day.temp.max.toFixed(1),day.temp.min.toFixed(1)];
								if(count == 2){
									div+= '<ul class="week">'
								}
								div += '<li>'+
									'	<span>'+weekday[date]+'</span>'+
									'	<span><img src="'+day.weather[0].iconData+'" width="50em" height="50em"></span>'+
									'	<strong>'+temp[0]+'&deg;</strong>'+
									'	<span>'+temp[1]+'&deg;</span>'+
									'</li>';
							}
							count += 1;
						}
						div += '</ul>';

						weathercard.empty().append(div).trigger("create");

						//auto adjust font-size for weather
						var actemp = $("#actemp"); 
						var width = actemp.width()/40;
						if(width > 7) width = 7;
						actemp.css('font-size', width+"em" ); 

						loadingOut();
						GLOBAL.INIT.index = true;
					})
					.fail(ajaxErrorHandler);
			};

			/**
			 * Fills a card, given by parameter card, with one of the specified news feeds
			 *
			 * @ param String feed ... a valid feed name to fetch from the Server
			 * @ param String card ... the id of the card to be filled
			 * @ param String heading ... the heading of the card
			 */
			function fillCard(feed, card, heading) {
				loadingIn();

				$.getJSON(CONFIG.SERVER.base+CONFIG.SERVER.news+'/get?feed='+feed+'&limit=2')
				 .done(function(data, status, jqXHR) {
						if(!isEmpty(data.exception))
							{ ajaxErrorHandler(data, status, jqXHR); return; }

						var divs = "<h1>"+heading+"</h1><hr>";
						
						for(var k in data.responseData.feed.entries) {
							entry = data.responseData.feed.entries[k];
							
							var content;
							var img = entry.content.match(/<img .*?\/?>/);
							content = replaceWith(entry.content, '', /<img .*?\/?>/);
							var links;
							do{
								links = content.match(/<a .*?<\/a>/);
								if(!isEmpty(links)){
									var link = links[0];
									content = content.replace(link,$(link).text());
								}
							}while(!isEmpty(links));
							
							if(!isEmpty(img)) img = '<div style="float: left; max-width: 300px; overflow: hidden; padding: 0 8px 8px 8px">'+img[0]+'</div>';
							else img = "";

							if(!isEmpty(entry.content)) {
								divs += '<strong>'+entry.title+'</strong>'+
										'<p id="newsContent">'+img+'<div>'+content.slice(0, 300)+'...</div></p>'+
										'<a href="'+entry.link+'" class="external" style="clear: both;" data-role="button">Weiterlesen...</a>';
							}
							
							divs += '<hr>';
						}
						
						divs = $(divs);
						
						$("#"+card)
							.empty()
							.append(divs)
							.trigger("create");
						
						var imgs = $('.HtwkImage img');
						for(i = 0; i < imgs.length ; i++){
							var src = $(imgs[i]).attr('src');
							$(imgs[i]).attr('src', addhttp(src));
						}
						loadingOut();
						$('img.HtwkImage img#lvz').width('100%');
						$('img.HtwkImage img#lvz').height('auto');
				  })
				 .fail(ajaxErrorHandler);
			};

			function replaceWith(string, toReplace, regExp){
				do{
					var reps = string.match(regExp);
					if(!isEmpty(reps)){
						var rep = reps[0];
						string = string.replace(rep,toReplace);
					}
				}while(!isEmpty(reps));

				return string;
			}
			
			function fillPushNotifictionCard(title, message){
				
				var div = "<h1>ServerInfo</h1><hr>";
				div+= '<strong>'+title+'</strong>';
				div+='<p>'+message+'</p>';
				div+='<a href="#" style="clear:both;" data-role="button" onclick="hideCard(\'PushNotification\')">Okay...</a>';
				$("#PushNotification")
				.empty()
				.append(div)
				.trigger("create").show();
				scrollToElement("PushNotification", -50);
			}
			
			function scrollToElement(element, offset) {
			    var myDivPos =offset + $("#"+element).offset().top;
			    $.mobile.silentScroll( myDivPos );
			}
			
			function hideCard(element){
				$("#"+element).hide();
			}

			function addhttp(url) {
  				if (!/^(f|ht)tps?:\/\//i.test(url)) {
      				url = "http://htwk-leipzig.de/" + url;
   				}
		   return url;
}
			
		</script>
		<script type="text/javascript" src="https://maps.google.com/maps/api/js?v=3.exp&sensor=true"></script>
		<script type="application/javascript" src="js/gmaps.js" defer></script>
		<script type="text/javascript" charset="utf-8" src="PushNotification.js"></script>
		<script type="text/javascript" src="js/pushnotification_support.js" defer></script>
	</body>
</html>

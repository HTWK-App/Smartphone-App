<!DOCTYPE html>
<html>
	<head>
		<title>HTWK App</title>
		<meta charset = "utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1"> 

		<link rel="stylesheet" type="text/css" href="themes/jquery.mobile-1.4.0.min.css" />
		<link rel="stylesheet" type="text/css" href="themes/HTWK.min.css" />
		<link rel="stylesheet" type="text/css" href="themes/additions.css" />
		
		<script type="application/javascript" src="js/lib/fastclick.js"></script>
		<script type="application/javascript" src="js/lib/jquery-2.0.3.min.js"></script>
		<script type="application/javascript" src="js/lib/jquery.mobile-1.4.0.min.js"></script>
		
		<script type="application/javascript" src="js/config.js"></script>
		<script type="application/javascript" src="js/fn.js"></script>
	</head>
	<body>
		<div data-role="panel" id="menue" data-theme="b" >
			<div id="panellist" data-role="listview" data-inset="true" data-theme="b">
				<li>
					<a href="index.html">News</a>
				</li>
				<li>
					<a href="mensa.html">Mensa</a>
				</li>
				<li>
					<a href="mail.html">Postfach</a>
				</li>
				<li>
					<a href="qis.html">QIS</a>
				</li>
				<li>
					<a href="sport.html">Hochschulsport</a>
				</li>
				<li>
					<div data-role="collapsible" class="pcoll" data-inset="false" data-iconpos="right" data-collapsed-icon="carat-d" data-expanded-icon="carat-u" data-theme="b">
				    <h4>Info-Center</h4>
				    <ul data-role="listview">
						<li>
							<a href="profs.html">Professoren</a>
						</li>
						<li>
							<a href="building.html">Gebäudeplan</a>
						</li>
						<li>
							<a href="wlan.html">WLAN-Konfiguration</a>
						</li>
				    </ul>
				    </div>
				</li>
				<li>
					<a href="settings.html">Einstellungen</a>
				</li>
			</div>
		</div>
		
		<div data-role="header" id="header" class="toblur" data-theme="a" data-position="fixed">
			<h1>News</h1>
			<div class="ui-btn-left" data-type="horizontal">
				<a href="#menue" data-role="button" data-icon="bars" data-mini="true">Menü</a>	
				<a data-rel="back" data-role="button" data-icon="back" data-mini="true">Zurück</a>
			</div>
			<div class="ui-btn-right" data-type="horizontal">
				<a data-rel="refresh" id="btn_refresh" data-role="button" data-icon="refresh" data-mini="true">Aktualisieren</a>
			</div>
		</div>
		
		<div data-role="page" id="news" class="toblur" data-title="News" data-theme="a" data-content-theme="a" data-dom-cache="true">
			<div data-role="content" id="news_content">
				<div data-role="fieldcontain">
					<label for="select-news">Kategorie:</label>
					<select name="select-news" id="select-news" data-mini="true">
						<option selected="selected">Liste der verfügbaren News-Feeds wird geladen...</option>
					</select>
				</div>
				<ul data-role="listview" id="news_content_list" data-inset="true"></ul>
				<!-- <a data-role="button" id="news-more">Mehr</a>-->
			</div>
			<div data-role="popup" id="news_popup">
				<p>Diese Nachricht besitzt keinen zusätzlichen Inhalt!</p>
			</div>
		</div>

	<script>
		//var showLoading = false;
		//var feedList = new Array();

		$.ajaxSetup(CONFIG.AJAX);
		
		// TODO remove, only for Testing, Insert your Account-Data in GLOBAL.DEMO
		$.post(CONFIG.SERVER.base+CONFIG.SERVER.auth+'?username='+GLOBAL.DEMO.username+'&password='+GLOBAL.DEMO.password)
		 .done(function(data, status, jqXHR) {
			 GLOBAL.DEMO.credentials = data.encryptedCredentials;
			 GLOBAL.DEMO.salt = data.salt;
		  });
		
		$( document )
			.ready(function() {
				$.mobile.defaultPageTransition   = "none";
				$.mobile.defaultDialogTransition = "none";
				$.mobile.buttonMarkup.hoverDelay = 0;
				$.mobile.changePage.defaults.allowSamePageTransition = true;
				// Add EventListener for Fastclick Framework//
				window.addEventListener("load", function() {
					new FastClick(document.body);
				}, false);
				$( "[data-role='navbar']" ).navbar();
				$( "[data-role='header'], [data-role='footer']" ).toolbar();
			})
			.on( "panelbeforeopen", function( event, ui ) {
				$( ".toblur" ).toggleClass("blur");
			})
			.on( "panelbeforeclose", function( event, ui ) {
				$( ".toblur" ).removeClass("blur");
			})
			/* Update the contents of the toolbars*/
			.on( "pageshow", "[data-role='page']", function() {
    			/* on page: <div data-role="page" data-title="Info">*/
    			var curr = $( this ).jqmData( "title" );
    			var h = $("[data-role='header']");
    			if( curr == "back") {
    				h.find("a[data-rel='back']").css("display", "block").end()
    				 .find("a[href='#menue']").css('display', 'none');
    				//$( "[data-role='header'] a" ).remove();	
    				//$( "[data-role='header']" ).append('<a data-role="button" data-rel="back" data-icon="back" data-mini="true" class="ui-btn-left">Zurück</a>');
    			} else {
    				h.find("h1").text( curr ).end()
    				 .find("a[href='#menue']").css('display', 'block').end()
    				 .find("a[data-rel='back']").css('display', 'none');
    				//$( "[data-role='header'] h1" ).text( current );
    				//$( "[data-role='header'] a" ).remove();	
    				//$( "[data-role='header']" ).append('<a href="#menue" data-role="button" data-icon="bars" data-mini="true" class="ui-btn-left">Menü</a>');
    			}
    			// TODO better
    			$("#btn_refresh").off().on("click", function() { $("#select-news").change(); });
			});
		// TODO showLoading
		//$( document ).on( "pageshow", function() {if(showLoading == true){showLoader();}});

		$( '#news' )
			.on( "pagebeforecreate", function() {
				$.getJSON(CONFIG.SERVER.base+CONFIG.SERVER.news)
				.done(fillNewsFeedSelect);
				//fillNewsCategories();
				//	fillNewsContent("");
			})
			.on('pageshow', function () {
				$("#news_content_list li a").removeClass("ui-btn-active");
			});

		$( '#select-news' )
			.change(function() {
				//$("#news_content_list").empty();
				$( ".newpage" ).detach();
				//fillNewsContent(feedList[$(this).val()]);
				fillNewsContent($(this).val());
			});

		// TODO
		/*function showLoader() {
			showLoading = true;
			$.mobile.loading('show');
		}*/

		/*function fillNewsCategories() {
			$.getJSON(CONFIG.SERVER.base+CONFIG.SERVER.news)
			 .done(fillNewsFeedSelect); 
			//function(data) {
				//$.each( data, createNewsCategory);
				
				//$('#news-more').click(function () {
				//	fillNewsContent(feedList[0]);
				//});
			//});
		}*/

		function fillNewsContent(feed) {
			loadingIn();
			//$.getJSON( SERVER_URL+'news/get?',{feed: feed}).done( function(data,a,b) {
			$.getJSON(CONFIG.SERVER.base+CONFIG.SERVER.news+'/get?', {feed: feed})
				.done(function(data, status, jqXHR) {
					//$('#news_content_list').empty();
					fillNewsList(data.responseData.feed.entries);
					/*$.each( data.responseData.feed.entries, function( i, item ) {
						newsCreateNewsElement("",item.title,item.contentSnippet,item.content,item.publishedDate);		
					});*/
					loadingOut();
					//$.mobile.loading('hide'); 
					//showLoading = false;
				});
			// TODO fail
		};

		//function newsCreateNewsElement(picture,header,contentSnippet,content,date){
		function fillNewsList(data) {
			var link, pic, title, snipp, content, date;
			var lis = '';
			var divs = '';
			
			GLOBAL.NEWS.counter = 0;
			
			for(var k in data)
			{
				pic = '';
				title = data[k].title;
				snipp = data[k].contentSnippet;
				content = data[k].content;
				date = new Date(data[k].publishedDate);
				
				if(!isEmpty(pic)) pic = '<img src="data:image/png;base64,'+pic+'" />';
				if(isEmpty(content)) link = 'popup" data-rel="popup"';
				else link = ++GLOBAL.NEWS.counter + '"';
				
				lis += 	'<li><a href="#news_'+link+'>'+
							'<h3>'+title+'</h3>'+
							'<p>'+snipp+'</p>'+
							'<p><small>'+createDateTimeStamp(date)+'</small></p>'+
						'</a></li>';
				
				divs += '<div data-role="page" class="newpage" id="news_'+link+' data-title="back" data-theme="a" data-content-theme="a">'+
							'<div data-role="content" id="news_content">'+pic+
								'<h2>'+title+'</h2><h4><small>'+createDateTimeStamp(date)+'</small></h4><p>'+content+'</p>'+
							'</div>'+
						'</div>';
			}
			
			$( '#news_content_list' )
				.empty()
				.append(lis)
				.listview('refresh')
				.trigger('updatelayout');
			
			$( 'body' )
				.append(divs)
				.trigger("create");
			
			$.mobile.initializePage();
			
			/*
			if (content == ""){ link = 'popup" data-rel="popup"';
			}else { link =  ++GLOBAL.NEWS.counter + '"';}
			var pattern = 
				'<li><a href="#news_'+link+'>'+
					'<h3>'+header+'</h3>'+
					'<p>'+contentSnippet+'</p>'+
					'<p><small>'+date+'</small></p>'+
				'</a></li>';
			clist = $('#news_content_list');
			clist.append(pattern);
			clist.listview('refresh');
			clist.trigger('updatelayout');
			if(content != ""){
				var help = "";
				if(picture != "") {
					help = '<img src="data:image/png;base64,'+picture+'" />';
				}
				pattern = 
					'<div data-role="page" class="newpage" id="news_'+link+' data-title="back" data-theme="a" data-content-theme="a">'+
						'<div data-role="content" id="news_content">'+
							help+
							'<h2>'+header+'</h2><h4><small>'+date+'</small></h4><p>'+content+'</p>'+
						'</div>'+
					'</div>';
				$( "body" ).append(pattern).trigger("create");
				$.mobile.initializePage();
			}*/
		}

		function fillNewsFeedSelect(data) {//key, item){
			var list = $( "#select-news" );
			var tmp, name, id, items;

			items = "";
			
			for(var k in data)
			{
				id = data[k].id;
				tmp = id.split(".");
				name = capitalize(tmp[1])+(tmp.length==3?" "+tmp[2]:"");
				if(id == CONFIG.NEWS.defaultFeed)
					tmp = 'selected="selected"';
				else 
					tmp = "";
				items += '<option value="'+id+'" '+tmp+'>'+name+'</option>'; 
				//feedList[k] = id;
			}	
			
			list
				.empty()
				.append(items)
				.selectmenu( "refresh" );
			
			//var help = item.id.split(".");
			//var name = help[1].substr(0,1).toUpperCase()+help[1].substring(1,help[1].length);
			//var number = ""; var sel = "";
			//if(help.length == 3){number = help[2];}else{number = "";}
			//if(key == "rss.htwk.4") {sel = 'selected="selected"';}
			//list.append('<option value="'+key+'" '+sel+'>'+name+' '+number+'</option>');
			//feedList[key] = item.id;
			//list.selectmenu( "refresh" );
		};
	</script>	
	</body>
</html>
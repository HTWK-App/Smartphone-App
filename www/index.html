<!DOCTYPE html>
<html>
	<head>
		<title>HTWK App</title>
		<meta charset = "utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1"> 

		<link rel="stylesheet" type="text/css" href="themes/jquery.mobile-1.4.2.min.css" />
		<link rel="stylesheet" type="text/css" href="themes/HTWK.min.css" />
		<link rel="stylesheet" type="text/css" href="themes/additions.css" />
		
		<script type="application/javascript" src="js/lib/fastclick.js"></script>
		<script type="application/javascript" src="js/lib/jquery-2.0.3.min.js"></script>
		<script type="application/javascript" src="js/lib/jquery.mobile-1.4.2.min.js"></script>
		
		<script type="application/javascript" src="js/config.js"></script>
		<script type="application/javascript" src="js/fn.js"></script>
		
		<script type="application/javascript" src="cordova.js"></script>
	</head>
	<body>
		<!-- ## MENU ## -->
		<div id="menu" data-role="panel" data-display="push" data-position="left" data-theme="b">
			<div data-role="listview" data-inset="true" data-theme="b">
				<li>
					<a href="index.html">News</a>
				</li>
				<li>
					<a href="timetable.html">Stundenplan</a>
				</li>
				<li>
					<a href="mensa.html">Mensa</a>
				</li>
				<li>
					<a href="mail.html">Postfach</a>
				</li>
				<li id="menuItem_QIS">
					<a href="qis.html">QIS</a>
				</li>
				<li>
					<a href="sport.html">Hochschulsport</a>
				</li>
				<li>
					<div data-role="collapsible" data-inset="false" data-iconpos="right" data-collapsed-icon="carat-d" data-expanded-icon="carat-u" class="pcoll" data-theme="b">
				    <h4>Info-Center</h4>
				    <ul data-role="listview">
						<li>
							<a href="info.html">Allgemein</a>
						</li>
						<li>
							<a href="staff.html">Mitarbeiter</a>
						</li>
						<li>
							<a href="building.html">Gebäudeplan</a>
						</li>
						<li>
							<a href="wlan.html">WLAN-Konfiguration</a>
						</li>
				    </ul>
				    </div>
				</li>
				<li>
					<a href="room.html">Finde leeren Raum</a>
				</li>
				<li>
					<a href="settings.html">Einstellungen</a>
				</li>
			</div>
		</div>
		<!-- ## MENU ## -->
		
		<!-- ## HEADER ## -->
		<header id="header" data-role="header" data-position="fixed" class="toblur" data-theme="a">
			<h1>News</h1>
			<div data-type="horizontal" class="ui-btn-left">
				<a id="btn_menu" href="#menu" data-role="button" data-icon="bars" data-mini="true">Menü</a>	
				<a id="btn_back" data-rel="back" data-role="button" data-icon="back" data-mini="true">Zurück</a>
			</div>
			<div data-role="controlgroup" data-type="horizontal" class="ui-btn-right">
				<a id="btn_refresh" data-role="button" data-icon="refresh" data-rel="refresh">Refresh</a>
			</div>
		</header>
		<!-- ## HEADER ## -->
		
		<div id="news_page" data-role="page" data-dom-cache="true" data-title="News" class="toblur" data-theme="a" data-content-theme="a">
			<div data-role="content">
				<div data-role="fieldcontain">
					<label for="news_select">Kategorie:</label>
					<select id="news_select" name="news_select" data-mini="true">
						<option selected="selected">Liste der verfügbaren News-Feeds wird geladen...</option>
					</select>
				</div>
				<ul id="news_content_list" data-role="listview" data-inset="true"></ul>
				<a data-role="button" id="news-more" data-icon="arrow-d">Mehr</a>
			</div>
			<div id="news_popup" data-role="popup">
				<p>Diese Nachricht besitzt keinen zusätzlichen Inhalt!</p>
			</div>
		</div>
		
		<!-- ## SIGNIN DIALOG ## -->
		<div id="signInDialog" data-role="popup" data-dismissible="false" data-overlay-theme="b" data-theme="b">
	    	<div data-role="header" data-theme="a">
	   	 		<h1>Authentifizierung</h1>
	   	 	</div>
	   	 	<div role="main" class="ui-content">
	   	 		<h4>Damit Sie diesen Dienst nutzen können, müssen Sie sich zunächst anmelden!</h4>
	   	 		
	   	 		<label for="username"><strong>Nutzername:</strong></label>
	   	 		<input type="text" name="username" id="signInDialogUsername" value="" placeholder="Nutzername">
	   	 		
	   	 		<label for="password"><strong>Passwort:</strong></label>
	   	 		<input type="password" name="password" id="signInDialogPassword" value="" autocomplete="off" placeholder="******">
	   	 		
	   	 		<a id="signInDialog_Btn_Abort" href="#menu" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-b">Abbrechen</a>
	   	 		<a id="signInDialog_Btn_Save" href="#" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-b" data-transition="flow">Speichern</a>
	   	 	</div>
	    </div>
	    <!-- ## SIGNIN DIALOG ## -->

	<script>
		// AJAX Setup
		$.ajaxSetup(CONFIG.AJAX);
		
		// GENERAL Setup
		$( document )
			.ready(function() {
				$.mobile.defaultPageTransition   = "none";
				$.mobile.defaultDialogTransition = "none";
				$.mobile.buttonMarkup.hoverDelay = 0;
				$.mobile.changePage.defaults.allowSamePageTransition = true;
				// Add EventListener for Fastclick Framework//
				window.addEventListener("load", function() {
					FastClick.attach(document.body);
				}, false);
				$("header, footer").toolbar();
				
				loadParameters();
				
				if(!CONFIG.GENERAL.student)
				{
					$("#menuItem_QIS").hide();
				}
			})
			.on("panelbeforeopen", function( event, ui ) {
				$(".toblur").addClass("blur");
			})
			.on("panelbeforeclose", function( event, ui ) {
				$(".toblur").removeClass("blur");
			})
			// Header Update on Page Switch
			.on("pageshow", "div:jqmData(role='page')", function() {
				var o = $(this);
    			var title = o.jqmData("title");
    			var subpage = !isEmpty(o.jqmData("subpage"));
    			var h = $("#header");
    			
    			h.find("h1").text(title);
    			if(subpage) {
    				h.find("#btn_back").css("display", "block").end()
    				 .find("#btn_menu").css("display", "none");
    			} else {
    				h.find("#btn_menu").css("display", "block").end()
    				 .find("#btn_back").css("display", "none");
    			}
			})
			// External Link Handling
			.on("click", "a.external", openInExternalBrowser);

		// SignIn Dialog
		$( "#signInDialog_Btn_Abort" )
			.on("click", function () {
				$( "#signInDialog" ).popup("close");
			 });
		
		// NEWS Page
		$( "#news_page" )
			.on("pagebeforecreate", function() {
				GLOBAL.DATE.currentWeek = getWeek(new Date());
			 })
			.on("pagecreate", initNewsView)
			.on("pageshow", function () {
				if(!GLOBAL.INIT.news) loadingIn();
				$("#btn_refresh")
				.off()
				.on("click", function() { 
					$("#news_select").change(); 
				 });
			});

		$( "#news_select" )
			.change(function() {
				changeNewsFeed($(this).val(),false);
			});
		
		$("#news-more")
			.click(function () {
				changeNewsFeed($("#news_select").val(),true);
			});

		/**
		 * Loading the available News-Feeds (Prefill Feed-Selectbox).
		 */
		function initNewsView() {
			$.getJSON(CONFIG.SERVER.base+CONFIG.SERVER.news)
			 .done(function(data, status, jqXHR) {
					var tmp, name, id, opts = "";
					
					for(var k in data)
					{
						id = data[k].id;
						tmp = id.split(".");
						name = capitalize(tmp[1])+(tmp.length==3?" "+tmp[2]:"");
						
						opts += '<option value="'+id+'">'+name+'</option>';
					}	
					
					$( "#news_select" )
						.empty()
						.append(opts)
						.find("option[value='"+CONFIG.NEWS.defaultFeed+"']")
						.prop("selected", true).end()
						.selectmenu("refresh")
						.change();
					
					loadingOut();
					GLOBAL.INIT.news = true;
			 });
			//.fail(ajaxErrorHandler);
		};

		/**
		 * Loading all News of the given Feed.
		 * 
		 * @param String feed ... News Feed ID
		 * @param Boolean more ... indicates whether additional News should be loaded
		 */
		function changeNewsFeed(feed, more) {
			var offset = 0;
			var remove = true;
			
			loadingIn();
			
			if(more == true) { 
				remove = false; 
				offset = $('#news_content_list li').length;
			}
			
			$.getJSON(CONFIG.SERVER.base+CONFIG.SERVER.news+"/get?", {feed: feed, offset: offset})
			 .done(function(data, status, jqXHR) {
				 	createNewsEntries(data.responseData.feed.entries, remove);
			  });
			//.fail(ajaxErrorHandler);
		};

		/**
		 * Creating all News-Entries inclusive Details.
		 * 
		 * @param JSON-Object data
		 * @param Boolean remove ... indicates whether old News should be removed or not, due to "More"-Button
		 */
		function createNewsEntries(data, remove) {
			var list = $("#news_content_list");
			var news, link,  date;
			var c = list.find("li").length;
			var lis = "";
			var divs = "";
			
			for(var k in data)
			{
				news = data[k];
				date = createDateTimeStamp(new Date(news.publishedDate));
				
				if(isEmpty(news.content)) link = 'popup" data-rel="popup"';
				else link = ++c + '"';
				
				lis += 	'<li><a href="#news_'+link+'>'+
							'<h3>'+news.title+'</h3>'+
							'<p>'+news.contentSnippet+'</p>'+
							'<p><small>'+date+'</small></p>'+
						'</a></li>';
				
				divs += '<div id="news_'+link+' data-role="page" data-title="News" data-subpage="true" class="newsdetails" data-theme="a" data-content-theme="a">'+
							'<div data-role="content">'+
								'<h2>'+news.title+'</h2>'+
								'<h4>'+date+'</h4>'+
								'<p>'+news.content+'</p>'+
								'<p>Quelle: <a href="'+news.link+'">Link zur Nachricht</a></p>'+
							'</div>'+
						'</div>';
			}
			
			divs = $(divs);
			
			divs.find("a").addClass("external");
			
			if(remove == true) {
				list.empty();
				$( "div.newsdetails" ).remove();
			}
			
			list.append(lis)
				.listview("refresh")
				.trigger("updatelayout");
			
			$("body").append(divs)
					 .trigger("create");
			
			$.mobile.initializePage();
			
			loadingOut();
		};
	</script>	
	</body>
</html>
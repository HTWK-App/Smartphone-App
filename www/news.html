<div id="page_news" data-role="page" data-dom-cache="true" data-theme='b'>
	<div data-role="panel" id="menue_news" data-theme="a" data-display="push">
		<ul data-role="listview">
			<li data-role="list-divider" role="heading">Hauptmen체</li>
			<li data-icon="fire"><a href="index.html" >Startseite</a></li>
			<li data-icon="fire"><a href="news.html" >News</a></li>
			<li data-icon="trophy"><a href="stundenplan.html" >Stundenplan</a></li>
			<li data-icon="trophy"><a href="mensa.html" >Mensa</a></li>
			<li data-icon="trophy"><a href="postfach.html" >Postfach</a></li>
			<li data-icon="trophy"><a href="qis.html" >QIS</a></li>
			<li data-icon="trophy"><a href="sport.html" >Hochschulsport</a></li>
			
		</ul>
		<!--<div data-role="collapsible"><h4>Info-Center</h4> -->
		<ul data-role="listview">
			<li data-role="list-divider" role="heading">Info-Center</li>
			<li data-icon="trophy"><a href="info_allgemein.html" >Allgemein</a></li>
			<li data-icon="trophy"><a href="info_mitarbeiter.html" >Mitarbeiter</a></li>
			<li data-icon="trophy"><a href="info_gebaeudeplan.html" >Geb채udeplan</a></li>
			<li data-icon="trophy"><a href="info_wlan.html" >WLAN-Konfiguration</a></li>
		</ul>
		<!--</div> -->
		<ul data-role="listview">
			<li data-role="list-divider" role="heading">Tools</li>
			<li data-icon="trophy"><a href="tools_leeren-raum.html" >Leeren Raum finden</a></li>
			<li data-icon="trophy"><a href="tools_buch.html" >Buchausleihe</a></li>
		</ul>
		<ul data-role="listview">
			<li data-role="list-divider" role="heading">Einstellungen</li>
			<li data-icon="trophy"><a href="einstellungen_htwk-app.html" >HTWK-App</a></li>
		</ul>
	</div>
	<div data-role="header" data-position="fixed" data-theme='b'>
		<a href="#menue_news" data-role="button" data-iconpos='left' data-mini="true"><i class="icon-ellipsis-vertical"></i>&nbsp;</a>
		<h1>&nbsp;HTWK App</h1>
	</div>
	<div data-position="fixed" data-role="footer" data-theme='b'> <!--data-tap-toggle="true" setzen falls gew체nscht--> 
		<select id="news_select" name="select-choice-1" data-native-menu="true">
			<option selected="selected" value="">News Feed ...</option>
		</select>
	</div>
	<div data-role="content">   
		<ul id="news_content_list" data-role="listview" data-inset="true"></ul>
		<a data-role="button" id="news-more" data-icon="arrow-d">Mehr</a>
	</div>
	<div id="news_popup" data-role="popup">
		<p>Diese Nachricht besitzt keinen zus채tzlichen Inhalt!</p>
	</div>

	<script>

		/*TODO
		 * 
		 */
		$( "#page_news" )
			.on("pagebeforecreate", function() {
				GLOBAL.DATE.currentWeek = getWeek(new Date());
			 })
			.on("pagecreate", newsInitNewsView)
			.on("pageshow", function () {
				if(!GLOBAL.INIT.news) loadingIn();
				$("#btn_refresh")
					.off()
					.on("click", function() { 
						$("#news_select").change(); 
				 	});
			});
		
		$( "#news_select" )
			.change(function() {
				changeNewsFeed($(this).val(),false);
			});
		
		$("#news-more")
			.click(function () {
				changeNewsFeed($("#news_select").val(),true);
			});
		
		/**
		 * Fetches data from the Server to fill the news view. Calls changeNewsFeed
		 *
		 */
		function newsInitNewsView() {
			$.getJSON(CONFIG.SERVER.base+CONFIG.SERVER.news)
				.done(function(data, status, jqXHR) {
					if(!isEmpty(data.message)){ajaxErrorHandler(data, status, jqXHR); return;}

					var tmp, name, id, opts = "";
					
					for(var k in data) {
						id = data[k].id;
						tmp = id.split(".");
						name = capitalize(tmp[1])+(tmp.length==3?" "+tmp[2]:"");
						
						opts += '<option value="'+id+'">'+name+'</option>';
					}
					
					$( "#news_select" )
						.empty()
						.append(opts)
						.find("option[value='"+CONFIG.NEWS.defaultFeed+"']")
						.prop("selected", true).end()
						.selectmenu("refresh")
						.change();
					
					loadingOut();
					GLOBAL.INIT.news = true;
				})
				.fail(ajaxErrorHandler);
		}
		
		/**
		 * Loading all News of the given Feed.
		 * 
		 * @param String feed ... News Feed ID
		 * @param Boolean more ... indicates whether additional News shall be loaded
		 */
		function changeNewsFeed(feed, more) {

			var offset = 0;
			var remove = true;
			
			loadingIn();
			
			if(more == true) { 
				remove = false; 
				offset = $('#news_content_list li').length;
			}
			
			$.getJSON(CONFIG.SERVER.base+CONFIG.SERVER.news+"/get?", {feed: feed, offset: offset})
				.done(function(data, status, jqXHR) {
					if(!isEmpty(data.message)){ajaxErrorHandler(data, status, jqXHR); return;}

				 	createNewsEntries(data.responseData.feed.entries, remove);
				})
				.fail(ajaxErrorHandler);
		}
		
		/**
		 * Creating all News-Entries inclusive Details.
		 * 
		 * @param JSON-Object data
		 * @param Boolean remove ... indicates whether old News should be removed or not, due to "More"-Button
		 */
		function createNewsEntries(data, remove) {

			var list = $("#news_content_list");
			var news, link,  date;
			var c = list.find("li").length;
			var lis = "";
			var divs = "";
			
			for(var k in data) {
				news = data[k];
				date = createDateTimeStamp(new Date(news.publishedDate));
				
				if(isEmpty(news.content)) 
					link = 'popup" data-rel="popup"';
				else 
					link = ++c + '"';
	
				lis += 	'<li><a href="#news_'+link+' data-transition="slide">'+
						'<h3>'+news.title+'</h3>'+
						'<p>'+news.contentSnippet+'</p>'+
						'<p><small>'+date+'</small></p>'+
					'</a></li>';

				divs += '<div id="news_'+link+' data-role="page" data-theme ="b" data-title="News" data-subpage="true" class="newsdetails" >'+
						'<div data-role="header" data-position="fixed" data-tap-toggle="false" data-theme="b">'+
						'	<a href="#" data-rel="back" data-role="button" data-transition="slide" data-direction="reverse"><i class="icon-angle-left"></i></a>'+
						'	<h1>&nbsp;HTWK App</h1>'+
						'</div>'+
						'<div data-role="content"> <div class="inset">'+
						'	<ul data-nativedroid-plugin="cards" class="nativeDroidCards">'+
						'		<li data-cards-type="text" >'+
						'			<h1>'+news.title+'</h1><hr/>'+
						'			<p>'+news.content+'<br/><br/></p>'+
						'			<h6>'+date+'</h6>'+
						'			<p><b>Quelle:</b> <a href="'+news.link+'">Link zur Nachricht</a></p>'+
						'		</li>'+
						'	</ul>'+
						'</div>'+
					'</div></div>';
			}
			
			divs = $(divs);
			
			divs.find("div[data-role='content'] a").addClass("external");
			
			if(remove == true) {
				list.empty();
				$( "div.newsdetails" ).remove();
			}
			
			list.append(lis)
				.listview("refresh")
				.trigger("updatelayout");
			
			$("body").append(divs)
				 .trigger("create");
			
			loadingOut();
		}

	</script>
</div>

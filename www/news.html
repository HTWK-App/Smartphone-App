<div id="news_page" data-role="page" data-title="News" data-theme='b' data-dom-cache="true">
	<!--- HEADER --->
	<div data-role="header" data-position="fixed" data-theme='b' class="header">
		<a data-role="button" data-iconpos='left' class="btn_menu"><span class="icon-ellipsis-vertical"></span></a>
		<h1>HTWK App</h1>
	</div>
	<!--- HEADER --->
	
	<div data-role="content">   
		<ul id="news_content_list" data-role="listview" data-inset="true"></ul>
		<a data-role="button" id="news_btn_more" data-icon="arrow-d">Mehr</a>
	</div>
	<div id="news_popup" data-role="popup">
		<p>Diese Nachricht besitzt keinen zusätzlichen Inhalt!</p>
	</div>
	
	<div data-role="footer" data-tap-toggle="true" data-position="fixed" data-theme='b'> 
		<select id="news_select" data-native-menu="true">
			<option selected="selected" value="">Verfügbare News-Feeds werden geladen ...</option>
		</select>
	</div>

	<script>
		$( "#news_page" )
			.on("pagecreate", initNewsView)
			.on("pageshow", function () {
				if(!GLOBAL.INIT.news) loadingIn();
				/*$("#btn_refresh")
					.off()
					.on("click", function() { 
						$("#news_select").change(); 
				 	});*/
			})
			.on("pagehide", function () {
				//$(".newsdetails").remove();
			});
		
		$( "#news_select" )
			.change(function() {
				changeNewsFeed($(this).val(),false);
			});
		
		$( "#news_btn_more" )
			.click(function() {
				changeNewsFeed($("#news_select").val(),true);
			});
		
		/**
		 * Fetches Data from the Server to fill the News-View. Calls changeNewsFeed.
		 */
		function initNewsView() {
			$.getJSON(CONFIG.SERVER.base+CONFIG.SERVER.news)
			 .done(function(data, status, jqXHR) {
					if(!isEmpty(data.exception))
						{ ajaxErrorHandler(data, status, jqXHR); return; }

					var tmp, name, id, opts = "";
					
					for(var k in data) {
						id = data[k].id;
						tmp = id.split(".");
						name = capitalize(tmp[1])+(tmp.length==3?" "+tmp[2]:"");
						
						opts += '<option value="'+id+'">'+GLOBAL.NEWS.titles[id]+'</option>';
					}
					
					$( "#news_select" )
						.empty()
						.append(opts)
						.find("option[value='"+CONFIG.NEWS.defaultFeed+"']")
						.prop("selected", true).end()
						.selectmenu("refresh")
						.change();
					
					loadingOut();
					GLOBAL.INIT.news = true;
			  })
			 .fail(ajaxErrorHandler);
		}
		
		/**
		 * Loading all News of the given Feed.
		 * 
		 * @param String feed ... News Feed ID
		 * @param Boolean more ... indicates whether additional News shall be loaded
		 */
		function changeNewsFeed(feed, more) {

			var offset = 0;
			var remove = true;
			
			loadingIn();
			
			if(more == true) { 
				remove = false; 
				offset = $('#news_content_list li').length;
			}
			
			$.getJSON(CONFIG.SERVER.base+CONFIG.SERVER.news+"/get?", {feed: feed, offset: offset})
			 .done(function(data, status, jqXHR) {
					if(!isEmpty(data.exception))
						{ ajaxErrorHandler(data, status, jqXHR); return; }

				 	createNewsEntries(data.responseData.feed.entries, remove);
			  })
			 .fail(ajaxErrorHandler);
		}
		
		/**
		 * Creating all News-Entries inclusive Details.
		 * 
		 * @param JSON-Object data
		 * @param Boolean remove ... indicates whether old News should be removed or not, due to "More"-Button
		 */
		function createNewsEntries(data, remove) {
			var list = $("#news_content_list");
			var news, link, date;
			var c = list.find("li").length;
			var lis = "";
			var divs = "";
			
			for(var k in data) {
				news = data[k];
				date = createDateTimeStamp(new Date(news.publishedDate));
				
				if(isEmpty(news.content)) 
					link = 'popup" data-rel="popup"';
				else 
					link = ++c + '"';
	
				lis += 	'<li><a href="#news_'+link+' data-transition="slide">'+
							'<h3>'+news.title+'</h3>'+
							'<p>'+news.contentSnippet+'</p>'+
							'<p><small>'+date+'</small></p>'+
						'</a></li>';

				divs += '<div id="news_'+link+' data-role="page" data-theme="b" data-title="News" data-subpage="true" class="newsdetails">'+
							'<div data-role="header" data-position="fixed" data-tap-toggle="false" data-theme="b" class="header">'+
								'<a href="#" data-rel="back" data-role="button" data-transition="slide" data-direction="reverse"><span class="icon-angle-left"></span></a>'+
								'<h1>HTWK App</h1>'+
							'</div>'+
    						'<div data-role="content"><div class="inset">'+
    							'<ul data-nativedroid-plugin="cards" class="nativeDroidCards">'+
    								'<li data-cards-type="text">'+
    									'<h1>'+news.title+'</h1><hr/>'+
    									'<p>'+news.content+'<br/><br/></p>'+
    									'<h6>'+date+'</h6>'+
    									'<p><b>Quelle:</b> <a href="'+news.link+'">Link zur Nachricht</a></p>'+
    								'</li>'+
    							'</ul>'+
    						'</div>'+
    					'</div></div>';
			}
			
			divs = $(divs);
			
			divs.find("div:jqmData(role='content')").find("a").addClass("external").end()
													.find("img").css("max-width", "100%")
																.css("max-height", "100%");
			
			if(remove == true) {
				list.empty();
				$( "div.newsdetails" ).remove();
			}
			
			list.append(lis)
				.listview("refresh")
				.trigger("updatelayout");
			
			$("body").append(divs)
				 	 .trigger("create");
			
			loadingOut();
		}
	</script>
</div>
